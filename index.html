<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munetios Docs</title>
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'none'">

    <link onerror="this.onerror=null;this.href='https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined';" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
        }
        body {
            background-color: #f0f0f0;
            color: #333;
        }
        body.dark-mode .home-page {
            background-color: #6027e6;
            color: #e0e0e0;
        }
        body.dark-mode {
            background-color: #421dc74b !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode a {
            color: #bb86fc !important;
        }
        body.dark-mode .topbar {
            background-color: #6910bd !important;
            border-bottom: 1px solid #333 !important;
        }
        body.dark-mode .footer {
            background-color: #561dc2 !important;
            color: #bbb !important;
        }
        body.dark-mode .content {
            background-color: #7219d8 !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .search-bar {
            background-color: #333 !important;
            color: #fff !important;
        }
        body.dark-mode .logo {
            color: #bb86fc !important;
        }
        body.dark-mode .search-bar input {
            background-color: #444 !important;
            color: #fff !important;
        }
        body.dark-mode .search-bar input::placeholder {
            color: #bbb !important;
        }
        body.dark-mode .search-bar-mobile {
            background-color: #333 !important;
            color: #fff !important;
        }
        body.dark-mode .search-bar-mobile input {
            background-color: #444 !important;
            color: #fff !important;
        }
        body.dark-mode .search-bar-mobile input::placeholder {
            color: #bbb !important;
        }
        body.dark-mode .modal-content {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .modal-content input[type="text"] {
            background-color: #333 !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        body.dark-mode .modal-content input[type="text"]::placeholder {
            color: #bbb !important;
        }
        body.dark-mode .modal-content button {
            background: linear-gradient(90deg, #bb86fc 0%, #6200ee 100%) !important;
            color: #fff !important;
        }
        body.dark-mode .modal-content button:hover {
            background: linear-gradient(90deg, #6200ee 0%, #bb86fc 100%) !important;
        }
        body.dark-mode .modal-content .close {
            color: #bb86fc !important;
        }
        body.dark-mode .modal-content .close:hover {
            color: #6200ee !important;
        }
        body.dark-mode .documents {
            background-color: #5b17c9 !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .documents {
            background-color: #4017d4 !important;
            color: #e0e0e0 !important;
        }
        body.dark-mode .documents .document {
            background: #4017d4 !important;
            color: #e0e0e0 !important;
            border: 1px solid #333 !important;
        }
        body.dark-mode .documents .document:hover {
            background: #333 !important;
        }
        body.dark-mode .documents .document-item {
            background-color: #4017d4 !important;
            color: #e0e0e0 !important;
            border: 1px solid #333 !important;
        }

        body.dark-mode .documents .document-item:hover {
            background-color: #333 !important;
        }
        body.dark-mode .documents .document-item h3 {
            color: #bb86fc !important;
        }
        body.dark-mode .documents .document-item p {
            color: #bbb !important;
        }
        body.dark-mode .editor {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
        }

        body.dark-mode .editor .toolbar {
            background: #3f0d81 !important;
            border-bottom: 1px solid #333 !important;
        }
        body.dark-mode .editor .toolbar-item {
            color: #bbb !important;
        }
        body.dark-mode .editor .toolbar-item:hover {
            background: #333 !important;
            color: #fff !important;
        }
        .home-page {
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(63, 63, 63, 0.1);
        }
        .top-left {
            display: flex;
            align-items: center;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            font-size: 1.2em;
            color: #333;
        }
        .btn {
            padding: 15px 28px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(90deg, #712cca 0%, #a259e6 100%);
            color: #fff;
            border: none;
            border-radius: 32px;
            cursor: pointer;
            transition: 
            background 0.3s cubic-bezier(.4,0,.2,1),
            box-shadow 0.3s cubic-bezier(.4,0,.2,1),
            transform 0.2s cubic-bezier(.4,0,.2,1);
            box-shadow: 0 4px 16px rgba(113, 44, 202, 0.18), 0 1.5px 4px rgba(80, 80, 80, 0.08);
            font-size: 1.1em;
            font-weight: 600;
            letter-spacing: 0.03em;
            outline: none;
            position: relative;
            overflow: hidden;
        }
        .btn::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.25);
            border-radius: 100%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
            z-index: 0;
        }
        .btn:hover {
            background: linear-gradient(90deg, #a259e6 0%, #712cca 100%);
            box-shadow: 0 8px 24px rgba(113, 44, 202, 0.22), 0 2px 8px rgba(80, 80, 80, 0.12);
            transform: translateY(-2px) scale(1.03);
        }
        .btn:active::after {
            width: 200%;
            height: 200%;
        }
        .btn:active {
            transform: scale(0.98);
        }
        
        [Hidden] {
            display: none;
        }
        .top-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .material-symbols-outlined {
            cursor: pointer;
        }
        .material-symbols-outlined:hover {
            color: #712cca;
        

        }
        .search-bar {
            display: flex;
            align-items: center;
            background: #a0a0a0;
            border-radius: 20px;
            max-width: 768px;
            margin-left: 25px;
            position: relative;
            margin-right: 30px;
            width: 100%;
            height: 40px;
            transition: background-color 0.3s, box-shadow 0.3s, transform 0.3s;
            box-shadow: 0 2px 4px rgba(63, 63, 63, 0.1);
            padding: 10px 15px;
            gap: 10px;
        }
        .search-bar:hover, .search-bar:focus-within {
            background: #b8a0d6;
            box-shadow: 0 4px 12px rgba(113, 44, 202, 0.15);
            transform: translateY(-2px) scale(1.01);
        }
        .search-bar input {
            padding: 10px;
            border: none;
            border-radius: 20px;
            width: 100%;
            color: white;
            background-color: transparent;
            outline: none;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .search-bar input:focus {
            border-color: #712cca;
            background-color: rgba(113, 44, 202, 0.08);
        }

        .footer {
            text-align: center;
            padding: 20px;
            background-color: #fff;
            border-top: 1px solid #eee;
            margin-top: 50%;
            border-radius: 20px;
            box-shadow: 0 -2px 4px rgba(63, 63, 63, 0.1);
            font-size: 0.9em;
            color: #666;
            transition: box-shadow 0.3s;
        }
        .footer:hover {
            box-shadow: 0 -4px 12px rgba(113, 44, 202, 0.12);
        }

        .content {
            margin-top: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(63, 63, 63, 0.1);
            transition: box-shadow 0.3s, transform 0.3s;
        }
        .content:hover {
            box-shadow: 0 6px 18px rgba(113, 44, 202, 0.13);
            transform: translateY(-2px) scale(1.01);
        }

        .view {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-bottom: 20px;
            transition: gap 0.3s;
        }
        .view > div {
            transition: transform 0.2s, color 0.2s;
        }
        .view > div:hover {
            transform: scale(1.15) rotate(-5deg);
            color: #712cca;
        }

        .search-overlay-mobile {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            transition: background-color 0.3s;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s cubic-bezier(.4,0,.2,1), background-color 0.3s;
        }
        .search-overlay-mobile[style*="display: flex"] {
            opacity: 1;
            pointer-events: auto;
        }
        .search-bar-mobile {
            background: #696565;
            border-radius: 20px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 700px;
            transform: translateY(40px) scale(0.98);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(.4,0,.2,1), opacity 0.4s cubic-bezier(.4,0,.2,1);
        }
        .search-overlay-mobile[style*="display: flex"] .search-bar-mobile {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .search-bar-mobile {
            background: #696565;
            border-radius: 20px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 700px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            z-index: 1000;
            background: rgba(113, 44, 202, 0.18);
            backdrop-filter: blur(2px);
            transition: background 0.3s;
            /* Use flex to center modal-content */

            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(113,44,202,0.18), 0 2px 8px rgba(80,80,80,0.10);
            padding: 36px 32px 28px 32px;
            min-width: 320px;
            max-width: 90vw;
            /* Remove width: 100% to allow max-width to work */
            display: flex;
            flex-direction: column;
            align-items: stretch;
            position: relative;
            animation: modalFadeIn 0.4s cubic-bezier(.4,0,.2,1);
        }
        @keyframes modalFadeIn {
            from { transform: translateY(40px) scale(0.97); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .modal-content h2 {
            margin-bottom: 18px;
            color: #712cca;
            font-size: 1.5em;
            font-weight: 700;
            text-align: center;
        }
        .modal-content input[type="text"] {
            padding: 12px 16px;
            border-radius: 10px;
            border: 1.5px solid #ece6f7;
            margin-bottom: 18px;
            font-size: 1.1em;
            outline: none;
            transition: border-color 0.3s;
        }
        .modal-content input[type="text"]:focus {
            border-color: #a259e6;
            background: #f7f3ff;
        }
        .modal-content button {
            background: linear-gradient(90deg, #712cca 0%, #a259e6 100%);
            color: #fff;
            border: none;
            border-radius: 32px;
            padding: 12px 0;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
            box-shadow: 0 4px 16px rgba(113, 44, 202, 0.13);
            margin-top: 8px;
        }
        .modal-content button:hover {
            background: linear-gradient(90deg, #a259e6 0%, #712cca 100%);
            box-shadow: 0 8px 24px rgba(113, 44, 202, 0.18);
            transform: translateY(-2px) scale(1.03);
        }
        .close {
            position: absolute;
            top: 18px;
            right: 22px;
            font-size: 2em;
            color: #a259e6;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
            z-index: 2;
        }
        .close:hover {
            color: #712cca;
            transform: scale(1.2) rotate(10deg);
        }
        .search-bar-mobile input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 20px;
            color: white;
            background-color: transparent;
            outline: none;
        }

        #create-btn {
            position: relative;
        }
        .create-wrapper {
            position: absolute;
            top: 100%;
            left: 0;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(63, 63, 63, 0.1);
            display: none;
            flex-direction: column;
            gap: 10px;
            width: 240px;
            z-index: 10;
        }

        .create-wrapper button {
            background: transparent;
            color: #000000;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            text-align: left;
            font-size: 1em;
        }
        .create-wrapper button:hover {
            background: #f0f0f0;
        }
        @media (max-width: 768px) {
        .search-bar {
            display: none;
        }
        #searchIconMobile {
            display: block !important;
        }
        .create-label {
            display: none;
        }
    }

    @media (max-width: 576px) {
        .logo-text {
          display: none;
        }
    }
        @media (max-width: 980px) {
            .search-bar {
                margin-right: 5px;
            }
        }


        @media (max-width: 798px) {
            .create-wrapper {
            position: absolute;
            top: 100%;
            left: auto;
            right: 0;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(63, 63, 63, 0.1);
            display: none;
            flex-direction: column;
            gap: 10px;
            width: 240px;
            z-index: 10;
            }
        }

        .editor .top-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }


        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 10px;
            background: #ece6f7;
            border-radius: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #a259e6 0%, #712cca 100%);
            border-radius: 8px;
            min-height: 40px;
            box-shadow: 0 2px 6px rgba(113, 44, 202, 0.12);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #712cca 0%, #a259e6 100%);
        }
        ::-webkit-scrollbar-track {
            background: #f5f3fa;
            border-radius: 8px;
        }

        
        .editor {
            width: 100%;
          height: 100vh;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .editor .topbar .top-right {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: nowrap;
            justify-content: flex-end;
            margin-left: auto;
            margin-right: 0;
            align-self: flex-start;
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            margin-right: 10px;
            margin-top: -25px;
        }
        .editor .topbar {
            position: relative;
        }

        @media (max-width: 576px) {
            .home-page {
                padding: 5px;
            }
            .editor {
                padding: 5px;
            }
        }
    .tab-btn-bar {
        display: flex;
        gap: 10px;
        margin-left: 20px;
        margin-top: 12px;
        flex-wrap: wrap;
        /* Place the tab bar under the topbar */
        width: 100%;
    }

    .tab-btn {
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
    }

    .vl {
        height: 24px;
        width: 1.5px;
        background: linear-gradient(180deg, #a259e6 0%, #712cca 100%);
        margin: 0 12px;
        align-self: center;
        border-radius: 2px;
        opacity: 0.7;
    }

    /* Ensure tab-btn-bar is below the topbar in the editor */
    .editor .topbar {
        flex-direction: column;
        align-items: stretch;
        gap: 0;
    }

    .editor .top-left {
        margin-bottom: 0;
    }

    .tab-btn-bar {
        order: 2;
    }
    @media (max-width: 450px) {
        .tab-btn-bar {
            gap: 1px;
        }
    }
    .dropdown-file,
    .dropdown-edit,
    .dropdown-view,
    .dropdown-insert,
    .dropdown-format {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 220px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(113,44,202,0.13), 0 2px 8px rgba(80,80,80,0.10);
        display: none;
        flex-direction: column;
        gap: 4px;
        padding: 10px 0;
        z-index: 20;
        animation: dropdownFadeIn 0.25s cubic-bezier(.4,0,.2,1);
        border: 1.5px solid #ece6f7;
    }
    @keyframes dropdownFadeIn {
        from { opacity: 0; transform: translateY(10px) scale(0.98);}
        to { opacity: 1; transform: translateY(0) scale(1);}
    }
    .dropdown-file .item,
    .dropdown-edit .item,
    .dropdown-view .item,
    .dropdown-insert .item,
    .dropdown-format .item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 18px;
        font-size: 1em;
        color: #333;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, transform 0.15s;
        border-radius: 6px;
        outline: none;
    }
    .dropdown-file .item:hover,
    .dropdown-edit .item:hover,
    .dropdown-view .item:hover,
    .dropdown-insert .item:hover,
    .dropdown-format .item:hover {
        background: linear-gradient(90deg, #f7f3ff 0%, #ece6f7 100%);
        color: #712cca;
        transform: translateX(4px) scale(1.03);
    }
    .dropdown-file hr,
    .dropdown-edit hr,
    .dropdown-view hr,
    .dropdown-insert hr,
    .dropdown-format hr {
        border: none;
        border-top: 1px solid #ece6f7;
        margin: 6px 0;
    }

    .editor .editor-canvas {
        border: 1px solid #ece6f7;
        border-radius: 12px;
        padding: 12px;
        background: #fff;
        box-shadow: 0 8px 32px rgba(113,44,202,0.13), 0 2px 8px rgba(80,80,80,0.10);
    }

    .editor .more-options {
        position: absolute;
        top: 100%;
        right: 0;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(113,44,202,0.13), 0 2px 8px rgba(80,80,80,0.10);
        display: none;
        flex-direction: column;
        gap: 4px;
        padding: 10px 0;
        z-index: 20;
        animation: dropdownFadeIn 0.25s cubic-bezier(.4,0,.2,1);
    }

    .editor .more-options .item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 18px;
        font-size: 1em;
        color: #333;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, transform 0.15s;
        border-radius: 6px;
        outline: none;
    }

    .overflow-menu {
        position: absolute;
        top: 100%;
        right: 0;
        min-width: 220px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(113,44,202,0.13), 0 2px 8px rgba(80,80,80,0.10);
        display: none;
        flex-direction: column;
        gap: 4px;
        padding: 10px 0;
        z-index: 20;
        animation: dropdownFadeIn 0.25s cubic-bezier(.4,0,.2,1);
        border: 1.5px solid #ece6f7;
        position: absolute;
        top: 100%;
        right: 0;
        left: auto;
        margin-top: 4px;
        }
        .overflow-menu .item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 18px;
        font-size: 1em;
        color: #333;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, transform 0.15s;
        border-radius: 6px;
        outline: none;
        }
        .overflow-menu .item:hover {
        background: linear-gradient(90deg, #f7f3ff 0%, #ece6f7 100%);
        color: #712cca;
        transform: translateX(4px) scale(1.03);
        }
        .overflow-menu hr {
        border: none;
        border-top: 1px solid #ece6f7;
        margin: 6px 0;
        }
        .overflow-menu .item-label {
        font-size: 1em;
        color: inherit;
        font-weight: 500;
        }

        @media (max-width: 768px) {
            .btn-text-2 {
                display: none;
            }
        }

    .editor .toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
        border-radius: 30px;
        padding: 8px 12px;
        background: #f7f7f7;
        border-bottom: 1px solid #ece6f7;
        /* Ensure toolbar is below the tab-btn-bar */
        order: 3;
        width: 100%;
    }

    #overflow-btn {
        display: none;
    }

    @media (max-width: 1697px) {
        #overflow-btn {
            display: block;
        }

        #zoom-in,
        #zoom-out {
            display: none;
        }
    }
    @media (max-width: 1615px) {
        #image {
            display: none;
        }
    }
    @media (max-width: 1557px) {
        #link,
        #divider {
            display: none;
        }
    }

    @media (max-width: 1444px) {
        #font-select {
            display: none !important;
        }
    }

    @media (max-width: 1196px) {
        #quote {
            display: none !important;
        }
    }
    @media (max-width: 1146px) {
        #toolbar-align-left, #toolbar-align-center, #toolbar-align-right, #checklist {
            display: none !important;
        }
    }
    @media (max-width: 900px) {
        .toolbar-item#find-in-doc, #font-size {
            display: none !important;
        }
       .hide-900 {
            display: none !important;
        }
    }
    @media (max-width: 440px) {
        #toolbar-strikethrough {
            display: none !important;
        }
    }
@media (max-width: 370px) {
    #toolbar-text-color {
        display: none !important;
    }
}

    @media (max-width: 630px) {
        #bulleted-list, #numbered-list {
            display: none !important;
        }
        .hide-600 {
            display: none !important;
        }
    }
    .editor .editor-canvas {
        overflow-x: auto !important;
        overflow-y: auto !important;
        box-sizing: border-box;
    }
    .editor .toolbar-item {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
    }
    @media (max-width: 1100px) {
        .download-button .btn-text {
            display: none;
        }
        .download-button {
            padding: 5px 10px !important;
        }
    }

    @media (max-width: 500px) {
        .download-button {
            display: none;
        }
        .undo-btn, .redo-btn {
            display: none;
        }
    }

    .editor .toolbar-item:hover {
        background: #ece6f7;
    }

    select {
        background: #fff;
        color: #333;
        border: 1px solid #ece6f7;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 1em;
        transition: background 0.2s, color 0.2s, transform 0.15s;
    }
    </style>
</head>
<body>
    <div class="home-page">
        <div class="search-overlay-mobile">
            <div class="search-bar-mobile">
                <div id="back">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="vertical-align: middle;">
                        <path d="M15.5 19L9 12L15.5 5" stroke="#712cca" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <span class="material-symbols-outlined">search</span>
                <input type="text" placeholder="Search for documents">
            </div>
        </div>
        <div class="topbar">
            <div class="top-left">
                <div class="logo">
                    <span class="material-symbols-outlined">description</span>
                    <span class="logo-text">Munetios Docs</span>
                </div>
            </div>
            <div class="search-bar" id="searchDocs">
                <span class="material-symbols-outlined">search</span>
                <input type="text" placeholder="Search for documents">
            </div>
            <div class="top-right">
                <div id="searchIconMobile" hidden>
                    <span class="material-symbols-outlined">search</span>
                </div>
                <div id="create-btn">
                    <button class="btn">
                        <span class="material-symbols-outlined">add</span>
                        <div class="create-label">
                            Create
                        </div>
                    </button>
                    <div class="create-wrapper">
                        <button class="btn" id="create-doc-btn"><span class="material-symbols-outlined">description</span> Create Document</button>
                        <button class="btn" id="import-btn"><span class="material-symbols-outlined">upload</span> Import Documents</button>
                    </div>
                </div>
                <div id="settings-btn">
                    <span class="material-symbols-outlined">settings</span>
                </div>
                <div id="help-btn">
                    <span class="material-symbols-outlined">help</span>
                </div>
            </div>
        </div>
        <div class="content">
            <h2>My Documents</h2>
            <div class="view top-right-view">
                <div id="grid-view">
                    <span class="material-symbols-outlined">grid_view</span>
                </div>
                <div id="list-view">
                    <span class="material-symbols-outlined">view_list</span>
                </div>
            </div>
            <div class="documents" id="documentsList">
                <!-- Injected by javascript -->
            </div>
        </div>
        <!-- MODALS -->
        <div class="modal" id="createDocModal">
            <div class="modal-content">
                <span class="close" id="closeCreateDocModal">&times;</span>
                <h2>Create Document</h2>
                <input type="text" id="newDocTitle" placeholder="Document Title">
                <button id="saveDocBtn">Save</button>
            </div>
        </div>
        <div class="modal" id="importModal">
            <div class="modal-content">
                <span class="close" id="closeImportModal">&times;</span>
                <h2>Import Documents</h2>
                <label for="importFileInput" class="btn" style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <span class="material-symbols-outlined">upload</span>
                    <span>Choose Files</span>
                    <input type="file" id="importFileInput" multiple style="display: none;">
                </label>
                <button id="importFilesBtn">Import</button>
            </div>
        </div>
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <span class="close" id="closeSettingsModal">&times;</span>
                <h2>Settings</h2>
                <label>Theme</label>
                <select id="themeSelect">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option selected value="system">System</option>
                </select>
                <label>Language</label>
                <select id="languageSelect">
                    <option selected value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="de">German</option>
                    <option value="zh">Chinese</option>
                    <option value="fr">French</option>
                    <option value="ru">Russian</option>
                    <option value="ja">Japanese</option>
                    <option value="pt">Portuguese</option>
                    <option value="it">Italian</option>
                    <option value="hi">Hindi</option>
                    <option value="ar">Arabic</option>
                    <option value="ko">Korean</option>
                    <option value="tr">Turkish</option>
                </select>
            </div>
        </div>
        <div class="modal" id="helpModal">
            <div class="modal-content">
                <span class="close" id="closeHelpModal">&times;</span>
                <h2>Help</h2>
                <p>Terms of Service:</p>
                <p><ol><li>We reserve the right to modify these terms at any time.</li><li>All your documents are private so we don't collect any data about you.</li></ol></p>
                <p>Privacy Policy:</p>
                <p>We take your privacy seriously. Your documents are stored locally and are not accessible by anyone else.</p> 
                <p>You can view your documents on <b>the Documents page</b>. <br> So you can make any documents and edit them here. all your documents are saved to localstorage. <br> Note: this is a beta Munetios Docs so some features are coming soon and may have some bugs. </p>
                <button class="btn" onclick="window.open('https://mail.google.com/mail/u/0/?fs=1&tf=cm&source=mailto&to=minecraftgamer97529@gmail.com')">Contact Us</button>
            </div>
        </div>
        <footer>
            <div class="footer">
                <p>&copy; 2025 GAMERYTDeveloper. All rights reserved.</p>
            </div>
        </footer>
    </div>
    <div class="editor" hidden>
        <div class="topbar">
            <div class="top-left">
                <span class="material-symbols-outlined" id="goHome">menu</span>
                <input
                    id="docsName"
                    type="text"
                    style="outline: none; min-width: 50px; font-size: 1.2em; font-weight: 600; border: none; background: transparent; padding: 4px 8px; border-radius: 6px; transition: background 0.2s;"
                    value=""
                /> 
            </div>
            <div class="top-right">
                <div class="undo-btn" id="undo-btn">
                    <span class="material-symbols-outlined">undo</span>
                </div>
                <div class="redo-btn" id="redo-btn">
                    <span class="material-symbols-outlined">redo</span>
                </div>
                <div class="history-btn" id="history-btn">
                    <span class="material-symbols-outlined">history</span>
                </div>
                <div class="theme-color-btn" id="bg-color-btn">
                    <span class="material-symbols-outlined">palette</span>
                </div>
                <div class="save-button" id="save-btn">
                    <button class="btn" id="saveFile">
                        <span class="material-symbols-outlined">save</span>
                        <p class="btn-text-2">Save</p>
                    </button>
                </div>
                <div class="download-button" id="download-btn">
                    <button class="btn" id="downloadFile">
                        <span class="material-symbols-outlined">download</span>
                       <p class="btn-text">Download</p>
                    </button>
                </div>
                <div class="more-btn" id="moreBtn">
                    <span class="material-symbols-outlined">more_vert</span>
                    <div class="more-options">
                        <div class="item" id="print">
                            <span class="material-symbols-outlined">print</span>
                            <p>Print</p>
                        </div>
                        <div class="item" id="rename">
                            <span class="material-symbols-outlined">edit</span>
                            <p>Rename</p>
                        </div>
                        <div class="item" id="details">
                            <span class="material-symbols-outlined">info</span>
                            <p>Details</p>
                        </div>
                        <div class="item" id="make-a-copy">
                            <span class="material-symbols-outlined">content_copy</span>
                            <p>Make a copy</p>
                        </div>
                        <div class="item" id="delete">
                            <span class="material-symbols-outlined">delete</span>
                            <p>Delete</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-btn-bar">
                <div class="tab-btn" id="file-btn">
                    <p>File</p>
                    <div class="dropdown-file">
                        <div class="item" id="make-a-copy">
                            <span class="material-symbols-outlined">content_copy</span>
                            <p>Make a copy</p>
                        </div>
                        <div class="item" id="download">
                            <span class="material-symbols-outlined">download</span>
                            <p>Download</p>
                        </div>
                        <div class="item" id="print">
                            <span class="material-symbols-outlined">print</span>
                            <p>Print</p>
                        </div>
                        <div class="item" id="rename">
                            <span class="material-symbols-outlined">edit</span>
                            <p>Rename</p>
                        </div>
                        <hr>
                        <div class="item" id="history">
                            <span class="material-symbols-outlined">history</span>
                            <p>Version history</p>
                        </div>
                        <hr>
                        <div class="item" id="details">
                            <span class="material-symbols-outlined">info</span>
                            <p>Details</p>
                        </div>
                        <div class="item" id="delete">
                            <span class="material-symbols-outlined">delete</span>
                            <p>Delete</p>
                        </div>
                        <hr>
                        <div class="item" id="mobile-breakpoints">
                            <span class="material-symbols-outlined">
                                phone_iphone
                            </span> 
                            <p>Mobile Breakpoints</p>
                        </div>
                        <div class="item" id="resize">
                            <span class="material-symbols-outlined">crop</span>
                            <p>Resize (new)</p>
                        </div>
                    </div>
                </div>
                
                <div class="tab-btn" id="edit-btn">
                    <p>Edit</p>
                    <div class="dropdown-edit">
                        <div class="item" id="undo">
                            <span class="material-symbols-outlined">undo</span>
                            <p>Undo</p>
                            </div>
                        <div class="item" id="redo">
                            <span class="material-symbols-outlined">redo</span>
                            <p>Redo</p>

                        </div>
                        <div class="item" id="cut">
                            <span class="material-symbols-outlined">content_cut</span>
                            <p>Cut</p>
                        </div>
                        <div class="item" id="copy">
                            <span class="material-symbols-outlined">content_copy</span>
                            <p>Copy</p>
                        </div>
                        <div class="item" id="paste">
                            <span class="material-symbols-outlined">content_paste</span>
                            <p>Paste</p>
                        </div>
                        <div class="item" id="select-all">
                            <span class="material-symbols-outlined">select_all</span>
                            <p>Select all</p>
                        </div>
                        <hr>
                        <div class="item" id="find-replace">
                            <span class="material-symbols-outlined">find_replace</span>
                            <p>Find and replace (new) </p>
                        </div>
                    </div>
                </div>
                <div class="tab-btn" id="view-btn">
                    <p>View</p>
                    <div class="dropdown-view">
                        <div class="item" id="zoom-in">
                            <span class="material-symbols-outlined">zoom_in</span>
                            <p>Zoom In</p>
                        </div>
                        <div class="item" id="zoom-out">
                            <span class="material-symbols-outlined">zoom_out</span>
                            <p>Zoom Out</p>
                        </div>
                        <div class="item" id="reset-zoom">
                            <span class="material-symbols-outlined">zoom_out</span>
                            <p>Reset Zoom</p>
                        </div>
                        <hr>
                        <div class="item" id="fullscreen">
                            <span class="material-symbols-outlined">fullscreen</span>
                            <p>Fullscreen</p>
                        </div>
                        <hr>
                        <div class="item" id="find-document">
                            <span class="material-symbols-outlined">search</span>
                            <p>Find Document</p>
                        </div>
                    </div>
                </div>
                <div class="tab-btn" id="insert-btn">
                    <p>Insert</p>
                    <div class="dropdown-insert">
                        <div class="item" id="insert-image">
                            <span class="material-symbols-outlined">image</span>
                            <p>Insert Image</p>
                        </div>
                        <div class="item" id="insert-link">
                            <span class="material-symbols-outlined">link</span>
                            <p>Insert Link  </p>
                        </div>
                        <div class="item" id="insert-table">
                            <span class="material-symbols-outlined">table_chart</span>
                            <p>Insert Table</p>
                        </div>
                        <div class="item" id="insert-code-block">
                            <span class="material-symbols-outlined">code</span>
                            <p>Insert Code Block</p>
                        </div>
                        <div class="item" id="insert-quote">
                            <span class="material-symbols-outlined">format_quote</span>
                            <p>Insert Quote </p>
                        </div>
                        <div class="item" id="insert-horizontal-rule">
                            <span class="material-symbols-outlined">horizontal_rule</span>
                            <p>Insert Horizontal Rule </p>
                        </div>
                        <div class="item" id="insert-dropdown">
                            <span class="material-symbols-outlined">arrow_drop_down</span>
                            <p>Insert Dropdown</p>
                        </div>
                    </div>
                </div>
                <div class="tab-btn" id="format-btn">
                    <p>Format</p>   
                    <div class="dropdown-format">
                        <div class="item" id="bold">
                            <span class="material-symbols-outlined">format_bold</span>
                            <p>Bold</p>
                        </div>
                        <div class="item" id="italic">
                            <span class="material-symbols-outlined">format_italic</span>
                            <p>Italic</p>
                        </div>
                        <div class="item" id="underline">
                            <span class="material-symbols-outlined">format_underlined</span>
                            <p>Underline</p>
                        </div>
                        <div class="item" id="strikethrough">
                            <span class="material-symbols-outlined">strikethrough_s</span>
                            <p>Strikethrough</p>
                        </div>
                        <hr>
                        <div class="item" id="text-color">
                            <span class="material-symbols-outlined">format_color_text</span>
                            <p>Text Color</p>
                        </div>
                        <hr>
                        <div class="item" id="align-left">
                            <span class="material-symbols-outlined">format_align_left</span>
                            <p>Align Left</p>
                        </div>
                        <div class="item" id="align-center">
                            <span class="material-symbols-outlined">format_align_center</span>
                            <p>Align Center</p>
                        </div>
                        <div class="item" id="align-right">
                            <span class="material-symbols-outlined">format_align_right</span>
                            <p>Align Right</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="toolbar">
            <div class="toolbar-item" id="find-in-doc">
                <span class="material-symbols-outlined">search</span>
            </div>
            <div class="toolbar-item" id="zoom-in">
                <span class="material-symbols-outlined">zoom_in</span>
            </div>
            <div class="toolbar-item" id="zoom-out">
                <span class="material-symbols-outlined">zoom_out</span>
            </div>
            <div class="vl hide-900"></div>
            <div class="toolbar-item" id="font-select" style="display: flex; align-items: center; gap: 6px;">
                <span class="material-symbols-outlined">font_download</span>
                <select
                    id="fontSelect"
                    style="background: transparent; border: none; outline: none; color: #333; font-size: 1em; padding: 4px 8px; border-radius: 6px; transition: background 0.2s;"
                    title="Choose font family"
                >
                    <option value="Segoe UI" selected>Segoe UI (Default)</option>
                    <option value="Arial">Arial</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Tahoma">Tahoma</option>
                    <option value="Trebuchet MS">Trebuchet MS</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Garamond">Garamond</option>
                    <option value="Palatino Linotype">Palatino Linotype</option>
                    <option value="Lucida Sans Unicode">Lucida Sans Unicode</option>
                    <option value="Lucida Console">Lucida Console</option>
                    <option value="Consolas">Consolas</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Arial Black">Arial Black</option>
                    <option value="Comic Sans MS">Comic Sans MS</option>
                    <option value="Impact">Impact</option>
                    <option value="Symbol">Symbol</option>
                    <option value="Roboto">Roboto</option>
                    <option value="Poppins">Poppins</option>
                </select>
            </div>
            <div class="toolbar-item" id="font-size" style="display: flex; align-items: center; gap: 6px;">
                <span class="material-symbols-outlined" id="removeFontSize">remove</span>
                <input
                    type="number"
                    id="fontSizeInput"
                    value="16"
                    min="1"
                    style="background: transparent; width: 50px; border: none; outline: none; color: #333; font-size: 1em; padding: 4px 8px; border-radius: 6px; transition: background 0.2s;"
                    title="Choose font size"
                />
                <span class="material-symbols-outlined" id="addFontSize">add</span>
            </div>
            <div class="vl hide-900"></div>
            <div class="toolbar-item" id="toolbar-bold">
                <span class="material-symbols-outlined">format_bold</span>
            </div>
            <div class="toolbar-item" id="toolbar-italic">
                <span class="material-symbols-outlined">format_italic</span>
            </div>
            <div class="toolbar-item" id="toolbar-underline">
                <span class="material-symbols-outlined">format_underlined</span>
            </div>
            <div class="toolbar-item" id="toolbar-strikethrough">
                <span class="material-symbols-outlined">strikethrough_s</span>
            </div>
            <div class="toolbar-item" id="toolbar-text-color">
                <span class="material-symbols-outlined">format_color_text</span>
            </div>
            <div class="vl hide-600"></div>
            <div class="toolbar-item" id="toolbar-align-left">
                <span class="material-symbols-outlined">format_align_left</span>
            </div>
            <div class="toolbar-item" id="toolbar-align-center">
                <span class="material-symbols-outlined">format_align_center</span>
            </div>
            <div class="toolbar-item" id="toolbar-align-right">
                <span class="material-symbols-outlined">format_align_right</span>
            </div>
            <div class="toolbar-item" id="bulleted-list">
                <span class="material-symbols-outlined">format_list_bulleted</span>
            </div>
            <div class="toolbar-item" id="numbered-list">
                <span class="material-symbols-outlined">format_list_numbered</span>
            </div>
            <div class="toolbar-item" id="checklist">
                <span class="material-symbols-outlined">check_box</span>
            </div>
            <div class="toolbar-item" id="quote">
                <span class="material-symbols-outlined">format_quote</span>
            </div>
            <div class="vl"></div>
            <div class="toolbar-item" id="divider">
                <span class="material-symbols-outlined">horizontal_rule</span>
            </div>
            <div class="toolbar-item" id="link">
                <span class="material-symbols-outlined">link</span>
            </div>
            <div class="toolbar-item" id="image">
                <span class="material-symbols-outlined">image</span>
            </div>
            <div class="toolbar-item" id="overflow-btn">
                <span class="material-symbols-outlined">more_vert</span>
                <div class="overflow-menu">
                    <!-- All toolbar items that exist, for overflow -->
                    <div class="item" id="overflow-find-in-doc">
                        <span class="material-symbols-outlined">search</span>
                        <span class="item-label">Find in Document</span>
                    </div>
                    <div class="item" id="overflow-zoom-in">
                        <span class="material-symbols-outlined">zoom_in</span>
                        <span class="item-label">Zoom In</span>
                    </div>
                    <div class="item" id="overflow-zoom-out">
                        <span class="material-symbols-outlined">zoom_out</span>
                        <span class="item-label">Zoom Out</span>
                    </div>
                    <hr>
                    <div class="item" id="overflow-font-select" style="display: flex; align-items: center; gap: 6px;">
                        <span class="material-symbols-outlined">font_download</span>
                        <select
                            id="overflowFontSelect"
                            style="background: transparent; border: none; outline: none; color: #333; font-size: 1em; padding: 4px 8px; border-radius: 6px; transition: background 0.2s;"
                            title="Choose font family"
                        >
                            <option value="Segoe UI" selected>Segoe UI (Default)</option>
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Tahoma">Tahoma</option>
                            <option value="Trebuchet MS">Trebuchet MS</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Garamond">Garamond</option>
                            <option value="Palatino Linotype">Palatino Linotype</option>
                            <option value="Lucida Sans Unicode">Lucida Sans Unicode</option>
                            <option value="Lucida Console">Lucida Console</option>
                            <option value="Consolas">Consolas</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Arial Black">Arial Black</option>
                            <option value="Comic Sans MS">Comic Sans MS</option>
                            <option value="Impact">Impact</option>
                            <option value="Symbol">Symbol</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Poppins">Poppins</option>
                        </select>
                    </div>
                    <div class="item" id="overflow-font-size" style="display: flex; align-items: center; gap: 6px;">
                        <span class="material-symbols-outlined">format_size</span>
                        <input
                            type="number"
                            id="overflowFontSizeInput"
                            value="16"
                            min="1"
                            style="background: transparent; width: 50px; border: none; outline: none; color: #333; font-size: 1em; padding: 4px 8px; border-radius: 6px; transition: background 0.2s;"
                            title="Choose font size"
                        />
                    </div>
                    <hr>
                    <div class="item" id="overflow-bold">
                        <span class="material-symbols-outlined">format_bold</span>
                        <span class="item-label">Bold</span>
                    </div>
                    <div class="item" id="overflow-italic">
                        <span class="material-symbols-outlined">format_italic</span>
                        <span class="item-label">Italic</span>
                    </div>
                    <div class="item" id="overflow-underline">
                        <span class="material-symbols-outlined">format_underlined</span>
                        <span class="item-label">Underline</span>
                    </div>
                    <div class="item" id="overflow-strikethrough">
                        <span class="material-symbols-outlined">strikethrough_s</span>
                        <span class="item-label">Strikethrough</span>
                    </div>
                    <div class="item" id="overflow-text-color">
                        <span class="material-symbols-outlined">format_color_text</span>
                        <span class="item-label">Text Color</span>
                    </div>
                    <hr>
                    <div class="item" id="overflow-align-left">
                        <span class="material-symbols-outlined">format_align_left</span>
                        <span class="item-label">Align Left</span>
                    </div>
                    <div class="item" id="overflow-align-center">
                        <span class="material-symbols-outlined">format_align_center</span>
                        <span class="item-label">Align Center</span>
                    </div>
                    <div class="item" id="overflow-align-right">
                        <span class="material-symbols-outlined">format_align_right</span>
                        <span class="item-label">Align Right</span>
                    </div>
                    <div class="item" id="overflow-bulleted-list">
                        <span class="material-symbols-outlined">format_list_bulleted</span>
                        <span class="item-label">Bulleted List</span>
                    </div>
                    <div class="item" id="overflow-numbered-list">
                        <span class="material-symbols-outlined">format_list_numbered</span>
                        <span class="item-label">Numbered List</span>
                    </div>
                    <div class="item" id="overflow-checklist">
                        <span class="material-symbols-outlined">check_box</span>
                        <span class="item-label">Checklist</span>
                    </div>
                    <div class="item" id="overflow-quote">
                        <span class="material-symbols-outlined">format_quote</span>
                        <span class="item-label">Quote</span>
                    </div>
                    <hr>
                    <div class="item" id="overflow-divider">
                        <span class="material-symbols-outlined">horizontal_rule</span>
                        <span class="item-label">Divider</span>
                    </div>
                    <div class="item" id="overflow-link">
                        <span class="material-symbols-outlined">link</span>
                        <span class="item-label">Insert Link</span>
                    </div>
                    <div class="item" id="overflow-image">
                        <span class="material-symbols-outlined">image</span>
                        <span class="item-label">Insert Image</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Place your editor content below the toolbar, not inside it -->
        <div class="editor-canvas">
            <div class="doc-canvas" id="docCanvas" contenteditable="true" spellcheck="true" style="min-height: 60vh; outline: none; font-size: 16px; font-family: inherit;">
                <!-- Document content will be loaded here -->
            </div>
        </div>
    </div>
    <script> 
    /* --- FIND AND REPLACE FUNCTIONALITY --- */
    document.querySelector('.dropdown-edit .item#find-replace').addEventListener('click', function () {
        // Remove any existing modal
        let frModal = document.getElementById('find-replace-modal');
        if (frModal) frModal.remove();

        frModal = document.createElement('div');
        frModal.id = 'find-replace-modal';
        frModal.style.position = 'fixed';
        frModal.style.top = '0';
        frModal.style.left = '0';
        frModal.style.width = '100vw';
        frModal.style.height = '100vh';
        frModal.style.background = 'rgba(0,0,0,0.15)';
        frModal.style.display = 'flex';
        frModal.style.alignItems = 'center';
        frModal.style.justifyContent = 'center';
        frModal.style.zIndex = '4000';

        const modalContent = document.createElement('div');
        modalContent.style.background = '#fff';
        modalContent.style.borderRadius = '18px';
        modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
        modalContent.style.padding = '28px 24px 20px 24px';
        modalContent.style.display = 'flex';
        modalContent.style.flexDirection = 'column';
        modalContent.style.alignItems = 'center';
        modalContent.style.position = 'relative';
        modalContent.style.minWidth = '320px';

        const closeBtn = document.createElement('span');
        closeBtn.className = 'material-symbols-outlined';
        closeBtn.textContent = 'close';
        closeBtn.style.position = 'absolute';
        closeBtn.style.top = '12px';
        closeBtn.style.right = '16px';
        closeBtn.style.fontSize = '2em';
        closeBtn.style.color = '#a259e6';
        closeBtn.style.cursor = 'pointer';
        closeBtn.addEventListener('click', () => frModal.style.display = 'none');

        const label = document.createElement('label');
        label.textContent = 'Find and Replace';
        label.style.marginBottom = '18px';
        label.style.fontWeight = '600';
        label.style.color = '#712cca';
        label.style.fontSize = '1.1em';

        const findInput = document.createElement('input');
        findInput.type = 'text';
        findInput.placeholder = 'Find...';
        findInput.style.marginBottom = '10px';
        findInput.style.padding = '8px 12px';
        findInput.style.borderRadius = '8px';
        findInput.style.border = '1.5px solid #ece6f7';
        findInput.style.fontSize = '1em';
        findInput.style.width = '220px';

        const replaceInput = document.createElement('input');
        replaceInput.type = 'text';
        replaceInput.placeholder = 'Replace with...';
        replaceInput.style.marginBottom = '18px';
        replaceInput.style.padding = '8px 12px';
        replaceInput.style.borderRadius = '8px';
        replaceInput.style.border = '1.5px solid #ece6f7';
        replaceInput.style.fontSize = '1em';
        replaceInput.style.width = '220px';

        const btnRow = document.createElement('div');
        btnRow.style.display = 'flex';
        btnRow.style.gap = '10px';

        const findBtn = document.createElement('button');
        findBtn.textContent = 'Find';
        findBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
        findBtn.style.color = '#fff';
        findBtn.style.border = 'none';
        findBtn.style.borderRadius = '18px';
        findBtn.style.padding = '8px 18px';
        findBtn.style.cursor = 'pointer';
        findBtn.style.fontWeight = '600';
        findBtn.style.fontSize = '1em';

        const replaceBtn = document.createElement('button');
        replaceBtn.textContent = 'Replace';
        replaceBtn.style.background = '#ece6f7';
        replaceBtn.style.color = '#712cca';
        replaceBtn.style.border = 'none';
        replaceBtn.style.borderRadius = '18px';
        replaceBtn.style.padding = '8px 18px';
        replaceBtn.style.cursor = 'pointer';
        replaceBtn.style.fontWeight = '600';
        replaceBtn.style.fontSize = '1em';

        const replaceAllBtn = document.createElement('button');
        replaceAllBtn.textContent = 'Replace All';
        replaceAllBtn.style.background = 'linear-gradient(90deg, #a259e6 0%, #712cca 100%)';
        replaceAllBtn.style.color = '#fff';
        replaceAllBtn.style.border = 'none';
        replaceAllBtn.style.borderRadius = '18px';
        replaceAllBtn.style.padding = '8px 18px';
        replaceAllBtn.style.cursor = 'pointer';
        replaceAllBtn.style.fontWeight = '600';
        replaceAllBtn.style.fontSize = '1em';

        btnRow.appendChild(findBtn);
        btnRow.appendChild(replaceBtn);
        btnRow.appendChild(replaceAllBtn);

        modalContent.appendChild(closeBtn);
        modalContent.appendChild(label);
        modalContent.appendChild(findInput);
        modalContent.appendChild(replaceInput);
        modalContent.appendChild(btnRow);
        frModal.appendChild(modalContent);
        document.body.appendChild(frModal);

        frModal.style.display = 'flex';

        // Highlight all matches
        function highlightAll(term) {
            const docCanvas = document.getElementById('docCanvas');
            // Remove previous highlights
            docCanvas.querySelectorAll('mark.__fr__').forEach(mark => {
                const parent = mark.parentNode;
                parent.replaceChild(document.createTextNode(mark.textContent), mark);
                parent.normalize();
            });
            if (!term) return;
            const walk = document.createTreeWalker(docCanvas, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            while ((node = walk.nextNode())) {
                if (node.nodeValue.match(regex)) {
                    const span = document.createElement('span');
                    span.innerHTML = node.nodeValue.replace(regex, m => `<mark class="__fr__" style="background: #ffe066; color: #333;">${m}</mark>`);
                    node.parentNode.replaceChild(span, node);
                }
            }
        }

        findBtn.addEventListener('click', function () {
            highlightAll(findInput.value);
        });

        // Replace first match
        replaceBtn.addEventListener('click', function () {
            const docCanvas = document.getElementById('docCanvas');
            const term = findInput.value;
            const replacement = replaceInput.value;
            if (!term) return;
            let replaced = false;
            // Find first match and replace
            const walk = document.createTreeWalker(docCanvas, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
            while ((node = walk.nextNode())) {
                if (node.nodeValue.match(regex)) {
                    node.nodeValue = node.nodeValue.replace(regex, replacement);
                    replaced = true;
                    break;
                }
            }
            if (replaced) {
                showToast('Replaced!');
                highlightAll(term);
                docCanvas.dispatchEvent(new Event('input'));
            } else {
                showToast('No match found.');
            }
        });

        // Replace all matches
        replaceAllBtn.addEventListener('click', function () {
            const docCanvas = document.getElementById('docCanvas');
            const term = findInput.value;
            const replacement = replaceInput.value;
            if (!term) return;
            let replaced = false;
            // Replace in all text nodes
            const walk = document.createTreeWalker(docCanvas, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            while ((node = walk.nextNode())) {
                if (node.nodeValue.match(regex)) {
                    node.nodeValue = node.nodeValue.replace(regex, replacement);
                    replaced = true;
                }
            }
            if (replaced) {
                showToast('Replaced all!');
                highlightAll(term);
                docCanvas.dispatchEvent(new Event('input'));
            } else {
                showToast('No match found.');
            }
        });

        // Remove highlights on close
        closeBtn.addEventListener('click', function () {
            const docCanvas = document.getElementById('docCanvas');
            docCanvas.querySelectorAll('mark.__fr__').forEach(mark => {
                const parent = mark.parentNode;
                parent.replaceChild(document.createTextNode(mark.textContent), mark);
                parent.normalize();
            });
        });
    });
     

    document.querySelector('.dropdown-insert .item#insert-link').addEventListener('click', function () {
        document.getElementById('link').click();
    });
    document.querySelector('.dropdown-insert .item#insert-quote').addEventListener('click', function () {
        document.getElementById('quote').click();
    });
    document.querySelector('.dropdown-insert .item#insert-horizontal-rule').addEventListener('click', function () {
        document.getElementById('divider').click();
    });




    document.getElementById('settings-btn').addEventListener('click', function () {
        document.getElementById('settingsModal').style.display = 'flex';
    });
    document.getElementById('closeSettingsModal').addEventListener('click', function () {
        document.getElementById('settingsModal').style.display = 'none';
    });
    document.getElementById('help-btn').addEventListener('click', function () {
        document.getElementById('helpModal').style.display = 'flex';
    });
    document.getElementById('closeHelpModal').addEventListener('click', function () {
        document.getElementById('helpModal').style.display = 'none';
    });

    // Theme selector logic
    const themeSelect = document.getElementById('themeSelect');
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
        } else if (theme === 'light') {
            document.body.classList.remove('dark-mode');
        } else {
            // system
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }
    }
    themeSelect.addEventListener('change', function () {
        localStorage.setItem('docs_theme', this.value);
        applyTheme(this.value);
    });
    document.addEventListener('DOMContentLoaded', function () {
        const savedTheme = localStorage.getItem('docs_theme') || 'system';
        themeSelect.value = savedTheme;
        applyTheme(savedTheme);
        // Listen for system theme changes if system selected
        if (savedTheme === 'system') {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function () {
                applyTheme('system');
            });
        }
    });
    // Language selector logic with UI update
    const languageSelect = document.getElementById('languageSelect');
     const translations = {
        en: {
            create: "Create",
            createDocument: "Create Document",
            importDocuments: "Import Documents",
            settings: "Settings",
            help: "Help",
            myDocuments: "My Documents",
            save: "Save",
            download: "Download",
            print: "Print",
            rename: "Rename",
            details: "Details",
            makeCopy: "Make a copy",
            delete: "Delete",
            file: "File",
            edit: "Edit",
            view: "View",
            insert: "Insert",
            format: "Format",
            searchPlaceholder: "Search for documents",
            chooseFiles: "Choose Files",
            import: "Import",
            theme: "Theme",
            language: "Language",
            termsOfService: "Terms of Service:",
            privacyPolicy: "Privacy Policy:",
            noDocuments: "No documents found.",
            documentDetails: "Document Details",
            title: "Title",
            characters: "Characters",
            words: "Words",
            font: "Font",
            created: "Created",
            lastModified: "Last Modified",
            addBreakpoint: "Add Breakpoint",
            documentPreview: "Document Preview",
            use: "Use",
            deleteBreakpoint: "Delete breakpoint",
            insertImage: "Insert Image",
            insertTable: "Insert Table",
            insertCodeBlock: "Insert Code Block",
            insertDropdown: "Insert Dropdown",
            insertLink: "Insert Link",
            insertQuote: "Insert Quote",
            insertHorizontalRule: "Insert Horizontal Rule",
            apply: "Apply",
            cancel: "Cancel",
            yes: "Yes",
            no: "No",
            restore: "Restore",
            show: "Show",
            hide: "Hide",
            restoreVersion: "Restore this version?",
            versionHistory: "Version History",
            pickTextColor: "Pick text color:",
            pickBgColor: "Pick background color:",
            resizePage: "Resize Page",
            width: "Width",
            height: "Height",
            fontSize: "Font",
            mobileBreakpoints: "Mobile Breakpoints",
            gridView: "Grid View",
            listView: "List View",
            document: "Document",
            documents: "Documents",
            close: "Close",
        },
        es: {
            create: "Crear",
            createDocument: "Crear Documento",
            importDocuments: "Importar Documentos",
            settings: "Configuración",
            help: "Ayuda",
            myDocuments: "Mis Documentos",
            save: "Guardar",
            download: "Descargar",
            print: "Imprimir",
            rename: "Renombrar",
            details: "Detalles",
            makeCopy: "Hacer una copia",
            delete: "Eliminar",
            file: "Archivo",
            edit: "Editar",
            view: "Ver",
            insert: "Insertar",
            format: "Formato",
            searchPlaceholder: "Buscar documentos",
            chooseFiles: "Elegir archivos",
            import: "Importar",
            theme: "Tema",
            language: "Idioma",
            termsOfService: "Términos del servicio:",
            privacyPolicy: "Política de privacidad:",
            noDocuments: "No se encontraron documentos.",
            documentDetails: "Detalles del documento",
            title: "Título",
            characters: "Caracteres",
            words: "Palabras",
            font: "Fuente",
            created: "Creado",
            lastModified: "Última modificación",
            addBreakpoint: "Agregar punto de quiebre",
            documentPreview: "Vista previa del documento",
            use: "Usar",
            deleteBreakpoint: "Eliminar punto de quiebre",
            insertImage: "Insertar imagen",
            insertTable: "Insertar tabla",
            insertCodeBlock: "Insertar bloque de código",
            insertDropdown: "Insertar desplegable",
            insertLink: "Insertar enlace",
            insertQuote: "Insertar cita",
            insertHorizontalRule: "Insertar línea horizontal",
            apply: "Aplicar",
            cancel: "Cancelar",
            yes: "Sí",
            no: "No",
            restore: "Restaurar",
            show: "Mostrar",
            hide: "Ocultar",
            restoreVersion: "¿Restaurar esta versión?",
            versionHistory: "Historial de versiones",
            pickTextColor: "Elige el color del texto:",
            pickBgColor: "Elige el color de fondo:",
            resizePage: "Redimensionar página",
            width: "Ancho",
            height: "Alto",
            fontSize: "Fuente",
            mobileBreakpoints: "Puntos de quiebre móviles",
            gridView: "Vista de cuadrícula",
            listView: "Vista de lista",
            document: "Documento",
            documents: "Documentos",
            close: "Cerrar",
        },
        fr: {
            create: "Créer",
            createDocument: "Créer un document",
            importDocuments: "Importer des documents",
            settings: "Paramètres",
            help: "Aide",
            myDocuments: "Mes documents",
            save: "Enregistrer",
            download: "Télécharger",
            print: "Imprimer",
            rename: "Renommer",
            details: "Détails",
            makeCopy: "Faire une copie",
            delete: "Supprimer",
            file: "Fichier",
            edit: "Éditer",
            view: "Vue",
            insert: "Insérer",
            format: "Format",
            searchPlaceholder: "Rechercher des documents",
            chooseFiles: "Choisir des fichiers",
            import: "Importer",
            theme: "Thème",
            language: "Langue",
            termsOfService: "Conditions d'utilisation :",
            privacyPolicy: "Politique de confidentialité :",
            noDocuments: "Aucun document trouvé.",
            documentDetails: "Détails du document",
            title: "Titre",
            characters: "Caractères",
            words: "Mots",
            font: "Police",
            created: "Créé",
            lastModified: "Dernière modification",
            addBreakpoint: "Ajouter un point de rupture",
            documentPreview: "Aperçu du document",
            use: "Utiliser",
            deleteBreakpoint: "Supprimer le point de rupture",
            insertImage: "Insérer une image",
            insertTable: "Insérer un tableau",
            insertCodeBlock: "Insérer un bloc de code",
            insertDropdown: "Insérer un menu déroulant",
            insertLink: "Insérer un lien",
            insertQuote: "Insérer une citation",
            insertHorizontalRule: "Insérer une ligne horizontale",
            apply: "Appliquer",
            cancel: "Annuler",
            yes: "Oui",
            no: "Non",
            restore: "Restaurer",
            show: "Afficher",
            hide: "Masquer",
            restoreVersion: "Restaurer cette version ?",
            versionHistory: "Historique des versions",
            pickTextColor: "Choisissez la couleur du texte :",
            pickBgColor: "Choisissez la couleur de fond :",
            resizePage: "Redimensionner la page",
            width: "Largeur",
            height: "Hauteur",
            fontSize: "Police",
            mobileBreakpoints: "Points de rupture mobiles",
            gridView: "Vue grille",
            listView: "Vue liste",
            document: "Document",
            documents: "Documents",
            close: "Fermer",
        },
        de: {
            create: "Erstellen",
            createDocument: "Dokument erstellen",
            importDocuments: "Dokumente importieren",
            settings: "Einstellungen",
            help: "Hilfe",
            myDocuments: "Meine Dokumente",
            save: "Speichern",
            download: "Herunterladen",
            print: "Drucken",
            rename: "Umbenennen",
            details: "Details",
            makeCopy: "Kopie erstellen",
            delete: "Löschen",
            file: "Datei",
            edit: "Bearbeiten",
            view: "Ansicht",
            insert: "Einfügen",
            format: "Format",
            searchPlaceholder: "Dokumente suchen",
            chooseFiles: "Dateien auswählen",
            import: "Importieren",
            theme: "Thema",
            language: "Sprache",
            termsOfService: "Nutzungsbedingungen:",
            privacyPolicy: "Datenschutzrichtlinie:",
            noDocuments: "Keine Dokumente gefunden.",
            documentDetails: "Dokumentdetails",
            title: "Titel",
            characters: "Zeichen",
            words: "Wörter",
            font: "Schriftart",
            created: "Erstellt",
            lastModified: "Zuletzt geändert",
            addBreakpoint: "Breakpoint hinzufügen",
            documentPreview: "Dokumentenvorschau",
            use: "Verwenden",
            deleteBreakpoint: "Breakpoint löschen",
            insertImage: "Bild einfügen",
            insertTable: "Tabelle einfügen",
            insertCodeBlock: "Codeblock einfügen",
            insertDropdown: "Dropdown einfügen",
            insertLink: "Link einfügen",
            insertQuote: "Zitat einfügen",
            insertHorizontalRule: "Horizontale Linie einfügen",
            apply: "Anwenden",
            cancel: "Abbrechen",
            yes: "Ja",
            no: "Nein",
            restore: "Wiederherstellen",
            show: "Anzeigen",
            hide: "Ausblenden",
            restoreVersion: "Diese Version wiederherstellen?",
            versionHistory: "Versionsverlauf",
            pickTextColor: "Textfarbe wählen:",
            pickBgColor: "Hintergrundfarbe wählen:",
            resizePage: "Seite anpassen",
            width: "Breite",
            height: "Höhe",
            fontSize: "Schriftart",
            mobileBreakpoints: "Mobile Breakpoints",
            gridView: "Rasteransicht",
            listView: "Listenansicht",
            document: "Dokument",
            documents: "Dokumente",
            close: "Schließen",
        },
        zh: {
            create: "创建",
            createDocument: "创建文档",
            importDocuments: "导入文档",
            settings: "设置",
            help: "帮助",
            myDocuments: "我的文档",
            save: "保存",
            download: "下载",
            print: "打印",
            rename: "重命名",
            details: "详情",
            makeCopy: "制作副本",
            delete: "删除",
            file: "文件",
            edit: "编辑",
            view: "视图",
            insert: "插入",
            format: "格式",
            searchPlaceholder: "搜索文档",
            chooseFiles: "选择文件",
            import: "导入",
            theme: "主题",
            language: "语言",
            termsOfService: "服务条款：",
            privacyPolicy: "隐私政策：",
            noDocuments: "未找到文档。",
            documentDetails: "文档详情",
            title: "标题",
            characters: "字符数",
            words: "单词数",
            font: "字体",
            created: "创建时间",
            lastModified: "最后修改",
            addBreakpoint: "添加断点",
            documentPreview: "文档预览",
            use: "使用",
            deleteBreakpoint: "删除断点",
            insertImage: "插入图片",
            insertTable: "插入表格",
            insertCodeBlock: "插入代码块",
            insertDropdown: "插入下拉菜单",
            insertLink: "插入链接",
            insertQuote: "插入引用",
            insertHorizontalRule: "插入水平线",
            apply: "应用",
            cancel: "取消",
            yes: "是",
            no: "否",
            restore: "恢复",
            show: "显示",
            hide: "隐藏",
            restoreVersion: "恢复此版本？",
            versionHistory: "版本历史",
            pickTextColor: "选择文本颜色：",
            pickBgColor: "选择背景颜色：",
            resizePage: "调整页面大小",
            width: "宽度",
            height: "高度",
            fontSize: "字体",
            mobileBreakpoints: "移动断点",
            gridView: "网格视图",
            listView: "列表视图",
            document: "文档",
            documents: "文档",
            close: "关闭",
        },
        ru: {
            create: "Создать",
            createDocument: "Создать документ",
            importDocuments: "Импортировать документы",
            settings: "Настройки",
            help: "Помощь",
            myDocuments: "Мои документы",
            save: "Сохранить",
            download: "Скачать",
            print: "Печать",
            rename: "Переименовать",
            details: "Детали",
            makeCopy: "Создать копию",
            delete: "Удалить",
            file: "Файл",
            edit: "Редактировать",
            view: "Вид",
            insert: "Вставить",
            format: "Формат",
            searchPlaceholder: "Поиск документов",
            chooseFiles: "Выбрать файлы",
            import: "Импортировать",
            theme: "Тема",
            language: "Язык",
            termsOfService: "Условия обслуживания:",
            privacyPolicy: "Политика конфиденциальности:",
            noDocuments: "Документы не найдены.",
            documentDetails: "Детали документа",
            title: "Название",
            characters: "Символы",
            words: "Слова",
            font: "Шрифт",
            created: "Создано",
            lastModified: "Последнее изменение",
            addBreakpoint: "Добавить точку останова",
            documentPreview: "Предпросмотр документа",
            use: "Использовать",
            deleteBreakpoint: "Удалить точку останова",
            insertImage: "Вставить изображение",
            insertTable: "Вставить таблицу",
            insertCodeBlock: "Вставить блок кода",
            insertDropdown: "Вставить выпадающий список",
            insertLink: "Вставить ссылку",
            insertQuote: "Вставить цитату",
            insertHorizontalRule: "Вставить горизонтальную линию",
            apply: "Применить",
            cancel: "Отмена",
            yes: "Да",
            no: "Нет",
            restore: "Восстановить",
            show: "Показать",
            hide: "Скрыть",
            restoreVersion: "Восстановить эту версию?",
            versionHistory: "История версий",
            pickTextColor: "Выберите цвет текста:",
            pickBgColor: "Выберите цвет фона:",
            resizePage: "Изменить размер страницы",
            width: "Ширина",
            height: "Высота",
            fontSize: "Шрифт",
            mobileBreakpoints: "Мобильные точки останова",
            gridView: "Вид сетки",
            listView: "Вид списка",
            document: "Документ",
            documents: "Документы",
            close: "Закрыть",
        },
        ar: {
            create: "إنشاء",
            createDocument: "إنشاء مستند",
            importDocuments: "استيراد مستندات",
            settings: "الإعدادات",
            help: "مساعدة",
            myDocuments: "مستنداتي",
            save: "حفظ",
            download: "تنزيل",
            print: "طباعة",
            rename: "إعادة تسمية",
            details: "تفاصيل",
            makeCopy: "إنشاء نسخة",
            delete: "حذف",
            file: "ملف",
            edit: "تحرير",
            view: "عرض",
            insert: "إدراج",
            format: "تنسيق",
            searchPlaceholder: "ابحث عن مستندات",
            chooseFiles: "اختر ملفات",
            import: "استيراد",
            theme: "السمة",
            language: "اللغة",
            termsOfService: "شروط الخدمة:",
            privacyPolicy: "سياسة الخصوصية:",
            noDocuments: "لم يتم العثور على مستندات.",
            documentDetails: "تفاصيل المستند",
            title: "العنوان",
            characters: "أحرف",
            words: "كلمات",
            font: "الخط",
            created: "تم الإنشاء",
            lastModified: "آخر تعديل",
            addBreakpoint: "إضافة نقطة توقف",
            documentPreview: "معاينة المستند",
            use: "استخدام",
            deleteBreakpoint: "حذف نقطة التوقف",
            insertImage: "إدراج صورة",
            insertTable: "إدراج جدول",
            insertCodeBlock: "إدراج كتلة كود",
            insertDropdown: "إدراج قائمة منسدلة",
            insertLink: "إدراج رابط",
            insertQuote: "إدراج اقتباس",
            insertHorizontalRule: "إدراج خط أفقي",
            apply: "تطبيق",
            cancel: "إلغاء",
            yes: "نعم",
            no: "لا",
            restore: "استعادة",
            show: "عرض",
            hide: "إخفاء",
            restoreVersion: "استعادة هذا الإصدار؟",
            versionHistory: "سجل الإصدارات",
            pickTextColor: "اختر لون النص:",
            pickBgColor: "اختر لون الخلفية:",
            resizePage: "تغيير حجم الصفحة",
            width: "العرض",
            height: "الارتفاع",
            fontSize: "الخط",
            mobileBreakpoints: "نقاط توقف الجوال",
            gridView: "عرض الشبكة",
            listView: "عرض القائمة",
            document: "مستند",
            documents: "مستندات",
            close: "إغلاق",
        },
        hi: {
            create: "बनाएँ",
            createDocument: "दस्तावेज़ बनाएँ",
            importDocuments: "दस्तावेज़ आयात करें",
            settings: "सेटिंग्स",
            help: "सहायता",
            myDocuments: "मेरे दस्तावेज़",
            save: "सहेजें",
            download: "डाउनलोड",
            print: "प्रिंट",
            rename: "नाम बदलें",
            details: "विवरण",
            makeCopy: "कॉपी बनाएँ",
            delete: "हटाएँ",
            file: "फ़ाइल",
            edit: "संपादित करें",
            view: "देखें",
            insert: "सम्मिलित करें",
            format: "प्रारूप",
            searchPlaceholder: "दस्तावेज़ खोजें",
            chooseFiles: "फ़ाइलें चुनें",
            import: "आयात करें",
            theme: "थीम",
            language: "भाषा",
            termsOfService: "सेवा की शर्तें:",
            privacyPolicy: "गोपनीयता नीति:",
            noDocuments: "कोई दस्तावेज़ नहीं मिला।",
            documentDetails: "दस्तावेज़ विवरण",
            title: "शीर्षक",
            characters: "अक्षर",
            words: "शब्द",
            font: "फ़ॉन्ट",
            created: "निर्मित",
            lastModified: "अंतिम संशोधित",
            addBreakpoint: "ब्रेकपॉइंट जोड़ें",
            documentPreview: "दस्तावेज़ पूर्वावलोकन",
            use: "उपयोग करें",
            deleteBreakpoint: "ब्रेकपॉइंट हटाएँ",
            insertImage: "छवि जोड़ें",
            insertTable: "तालिका जोड़ें",
            insertCodeBlock: "कोड ब्लॉक जोड़ें",
            insertDropdown: "ड्रॉपडाउन जोड़ें",
            insertLink: "लिंक जोड़ें",
            insertQuote: "उद्धरण जोड़ें",
            insertHorizontalRule: "क्षैतिज रेखा जोड़ें",
            apply: "लागू करें",
            cancel: "रद्द करें",
            yes: "हाँ",
            no: "नहीं",
            restore: "पुनर्स्थापित करें",
            show: "दिखाएँ",
            hide: "छिपाएँ",
            restoreVersion: "इस संस्करण को पुनर्स्थापित करें?",
            versionHistory: "संस्करण इतिहास",
            pickTextColor: "पाठ का रंग चुनें:",
            pickBgColor: "पृष्ठभूमि रंग चुनें:",
            resizePage: "पृष्ठ का आकार बदलें",
            width: "चौड़ाई",
            height: "ऊँचाई",
            fontSize: "फ़ॉन्ट",
            mobileBreakpoints: "मोबाइल ब्रेकपॉइंट्स",
            gridView: "ग्रिड दृश्य",
            listView: "सूची दृश्य",
            document: "दस्तावेज़",
            documents: "दस्तावेज़",
            close: "बंद करें",
        },
        ja: {
            create: "作成",
            createDocument: "ドキュメントを作成",
            importDocuments: "ドキュメントをインポート",
            settings: "設定",
            help: "ヘルプ",
            myDocuments: "マイドキュメント",
            save: "保存",
            download: "ダウンロード",
            print: "印刷",
            rename: "名前を変更",
            details: "詳細",
            makeCopy: "コピーを作成",
            delete: "削除",
            file: "ファイル",
            edit: "編集",
            view: "表示",
            insert: "挿入",
            format: "書式",
            searchPlaceholder: "ドキュメントを検索",
            chooseFiles: "ファイルを選択",
            import: "インポート",
            theme: "テーマ",
            language: "言語",
            termsOfService: "利用規約：",
            privacyPolicy: "プライバシーポリシー：",
            noDocuments: "ドキュメントが見つかりません。",
            documentDetails: "ドキュメントの詳細",
            title: "タイトル",
            characters: "文字数",
            words: "単語数",
            font: "フォント",
            created: "作成日",
            lastModified: "最終更新日",
            addBreakpoint: "ブレークポイントを追加",
            documentPreview: "ドキュメントプレビュー",
            use: "使用",
            deleteBreakpoint: "ブレークポイントを削除",
            insertImage: "画像を挿入",
            insertTable: "表を挿入",
            insertCodeBlock: "コードブロックを挿入",
            insertDropdown: "ドロップダウンを挿入",
            insertLink: "リンクを挿入",
            insertQuote: "引用を挿入",
            insertHorizontalRule: "水平線を挿入",
            apply: "適用",
            cancel: "キャンセル",
            yes: "はい",
            no: "いいえ",
            restore: "復元",
            show: "表示",
            hide: "非表示",
            restoreVersion: "このバージョンを復元しますか？",
            versionHistory: "バージョン履歴",
            pickTextColor: "テキストの色を選択：",
            pickBgColor: "背景色を選択：",
            resizePage: "ページサイズを変更",
            width: "幅",
            height: "高さ",
            fontSize: "フォント",
            mobileBreakpoints: "モバイルブレークポイント",
            gridView: "グリッド表示",
            listView: "リスト表示",
            document: "ドキュメント",
            documents: "ドキュメント",
            close: "閉じる",
        },
        pt: {
            create: "Criar",
            createDocument: "Criar Documento",
            importDocuments: "Importar Documentos",
            settings: "Configurações",
            help: "Ajuda",
            myDocuments: "Meus Documentos",
            save: "Salvar",
            download: "Baixar",
            print: "Imprimir",
            rename: "Renomear",
            details: "Detalhes",
            makeCopy: "Fazer uma cópia",
            delete: "Excluir",
            file: "Arquivo",
            edit: "Editar",
            view: "Visualizar",
            insert: "Inserir",
            format: "Formato",
            searchPlaceholder: "Pesquisar documentos",
            chooseFiles: "Escolher arquivos",
            import: "Importar",
            theme: "Tema",
            language: "Idioma",
            termsOfService: "Termos de serviço:",
            privacyPolicy: "Política de privacidade:",
            noDocuments: "Nenhum documento encontrado.",
            documentDetails: "Detalhes do documento",
            title: "Título",
            characters: "Caracteres",
            words: "Palavras",
            font: "Fonte",
            created: "Criado",
            lastModified: "Última modificação",
            addBreakpoint: "Adicionar ponto de interrupção",
            documentPreview: "Visualização do documento",
            use: "Usar",
            deleteBreakpoint: "Excluir ponto de interrupção",
            insertImage: "Inserir imagem",
            insertTable: "Inserir tabela",
            insertCodeBlock: "Inserir bloco de código",
            insertDropdown: "Inserir menu suspenso",
            insertLink: "Inserir link",
            insertQuote: "Inserir citação",
            insertHorizontalRule: "Inserir linha horizontal",
            apply: "Aplicar",
            cancel: "Cancelar",
            yes: "Sim",
            no: "Não",
            restore: "Restaurar",
            show: "Mostrar",
            hide: "Ocultar",
            restoreVersion: "Restaurar esta versão?",
            versionHistory: "Histórico de versões",
            pickTextColor: "Escolha a cor do texto:",
            pickBgColor: "Escolha a cor de fundo:",
            resizePage: "Redimensionar página",
            width: "Largura",
            height: "Altura",
            fontSize: "Fonte",
            mobileBreakpoints: "Pontos de interrupção móveis",
            gridView: "Visualização em grade",
            listView: "Visualização em lista",
            document: "Documento",
            documents: "Documentos",
            close: "Fechar",
        },
        it: {
            create: "Crea",
            createDocument: "Crea Documento",
            importDocuments: "Importa Documenti",
            settings: "Impostazioni",
            help: "Aiuto",
            myDocuments: "I miei documenti",
            save: "Salva",
            download: "Scarica",
            print: "Stampa",
            rename: "Rinomina",
            details: "Dettagli",
            makeCopy: "Crea una copia",
            delete: "Elimina",
            file: "File",
            edit: "Modifica",
            view: "Visualizza",
            insert: "Inserisci",
            format: "Formato",
            searchPlaceholder: "Cerca documenti",
            chooseFiles: "Scegli file",
            import: "Importa",
            theme: "Tema",
            language: "Lingua",
            termsOfService: "Termini di servizio:",
            privacyPolicy: "Informativa sulla privacy:",
            noDocuments: "Nessun documento trovato.",
            documentDetails: "Dettagli documento",
            title: "Titolo",
            characters: "Caratteri",
            words: "Parole",
            font: "Carattere",
            created: "Creato",
            lastModified: "Ultima modifica",
            addBreakpoint: "Aggiungi breakpoint",
            documentPreview: "Anteprima documento",
            use: "Usa",
            deleteBreakpoint: "Elimina breakpoint",
            insertImage: "Inserisci immagine",
            insertTable: "Inserisci tabella",
            insertCodeBlock: "Inserisci blocco di codice",
            insertDropdown: "Inserisci menu a discesa",
            insertLink: "Inserisci link",
            insertQuote: "Inserisci citazione",
            insertHorizontalRule: "Inserisci linea orizzontale",
            apply: "Applica",
            cancel: "Annulla",
            yes: "Sì",
            no: "No",
            restore: "Ripristina",
            show: "Mostra",
            hide: "Nascondi",
            restoreVersion: "Ripristinare questa versione?",
            versionHistory: "Cronologia versioni",
            pickTextColor: "Scegli il colore del testo:",
            pickBgColor: "Scegli il colore di sfondo:",
            resizePage: "Ridimensiona pagina",
            width: "Larghezza",
            height: "Altezza",
            fontSize: "Carattere",
            mobileBreakpoints: "Breakpoint mobili",
            gridView: "Vista griglia",
            listView: "Vista elenco",
            document: "Documento",
            documents: "Documenti",
            close: "Chiudi",
        },
        ko: {
            create: "생성",
            createDocument: "문서 생성",
            importDocuments: "문서 가져오기",
            settings: "설정",
            help: "도움말",
            myDocuments: "내 문서",
            save: "저장",
            download: "다운로드",
            print: "인쇄",
            rename: "이름 바꾸기",
            details: "세부 정보",
            makeCopy: "복사본 만들기",
            delete: "삭제",
            file: "파일",
            edit: "편집",
            view: "보기",
            insert: "삽입",
            format: "서식",
            searchPlaceholder: "문서 검색",
            chooseFiles: "파일 선택",
            import: "가져오기",
            theme: "테마",
            language: "언어",
            termsOfService: "서비스 약관:",
            privacyPolicy: "개인정보 처리방침:",
            noDocuments: "문서를 찾을 수 없습니다.",
            documentDetails: "문서 세부 정보",
            title: "제목",
            characters: "문자 수",
            words: "단어 수",
            font: "글꼴",
            created: "생성됨",
            lastModified: "마지막 수정",
            addBreakpoint: "중단점 추가",
            documentPreview: "문서 미리보기",
            use: "사용",
            deleteBreakpoint: "중단점 삭제",
            insertImage: "이미지 삽입",
            insertTable: "표 삽입",
            insertCodeBlock: "코드 블록 삽입",
            insertDropdown: "드롭다운 삽입",
            insertLink: "링크 삽입",
            insertQuote: "인용문 삽입",
            insertHorizontalRule: "수평선 삽입",
            apply: "적용",
            cancel: "취소",
            yes: "예",
            no: "아니오",
            restore: "복원",
            show: "보기",
            hide: "숨기기",
            restoreVersion: "이 버전을 복원하시겠습니까?",
            versionHistory: "버전 기록",
            pickTextColor: "텍스트 색상 선택:",
            pickBgColor: "배경 색상 선택:",
            resizePage: "페이지 크기 조정",
            width: "너비",
            height: "높이",
            fontSize: "글꼴",
            mobileBreakpoints: "모바일 중단점",
            gridView: "그리드 보기",
            listView: "목록 보기",
            document: "문서",
            documents: "문서",
            close: "닫기",
        },
        tr: {
            create: "Oluştur",
            createDocument: "Belge Oluştur",
            importDocuments: "Belgeleri İçe Aktar",
            settings: "Ayarlar",
            help: "Yardım",
            myDocuments: "Belgelerim",
            save: "Kaydet",
            download: "İndir",
            print: "Yazdır",
            rename: "Yeniden Adlandır",
            details: "Detaylar",
            makeCopy: "Kopyasını oluştur",
            delete: "Sil",
            file: "Dosya",
            edit: "Düzenle",
            view: "Görünüm",
            insert: "Ekle",
            format: "Biçim",
            searchPlaceholder: "Belgeleri ara",
            chooseFiles: "Dosya seç",
            import: "İçe Aktar",
            theme: "Tema",
            language: "Dil",
            termsOfService: "Hizmet Şartları:",
            privacyPolicy: "Gizlilik Politikası:",
            noDocuments: "Belge bulunamadı.",
            documentDetails: "Belge Detayları",
            title: "Başlık",
            characters: "Karakter",
            words: "Kelime",
            font: "Yazı tipi",
            created: "Oluşturuldu",
            lastModified: "Son Değişiklik",
            addBreakpoint: "Kesme noktası ekle",
            documentPreview: "Belge Önizlemesi",
            use: "Kullan",
            deleteBreakpoint: "Kesme noktasını sil",
            insertImage: "Resim ekle",
            insertTable: "Tablo ekle",
            insertCodeBlock: "Kod bloğu ekle",
            insertDropdown: "Açılır menü ekle",
            insertLink: "Bağlantı ekle",
            insertQuote: "Alıntı ekle",
            insertHorizontalRule: "Yatay çizgi ekle",
            apply: "Uygula",
            cancel: "İptal",
            yes: "Evet",
            no: "Hayır",
            restore: "Geri yükle",
            show: "Göster",
            hide: "Gizle",
            restoreVersion: "Bu sürümü geri yükle?",
            versionHistory: "Sürüm Geçmişi",
            pickTextColor: "Metin rengini seç:",
            pickBgColor: "Arka plan rengini seç:",
            resizePage: "Sayfa Boyutunu Değiştir",
            width: "Genişlik",
            height: "Yükseklik",
            fontSize: "Yazı tipi",
            mobileBreakpoints: "Mobil Kesme Noktaları",
            gridView: "Izgara Görünümü",
            listView: "Liste Görünümü",
            document: "Belge",
            documents: "Belgeler",
            close: "Kapat",
        },
    
        // Add more languages as needed...
    };

    // Get current language translations
    function getTranslations() {
        const lang = document.documentElement.lang || 'en';
        return translations[lang] || translations['en'];
    }

    // Set text content and placeholders for elements with data-i18n/data-i18n-placeholder
    function setTextContent() {
        const t = getTranslations();
        // Text content
        for (const key in t) {
            document.querySelectorAll(`[data-i18n="${key}"]`).forEach(el => {
                el.textContent = t[key];
            });
        }
        // Placeholders
        for (const key in t) {
            document.querySelectorAll(`[data-i18n-placeholder="${key}"]`).forEach(el => {
                el.placeholder = t[key];
            });
        }
        // Special: search bar placeholders
        const searchInputs = [
            document.querySelector('.search-bar input'),
            document.querySelector('.search-bar-mobile input')
        ];
        searchInputs.forEach(input => {
            if (input && t.searchPlaceholder) input.placeholder = t.searchPlaceholder;
        });
        // Special: create modal
        const createDocModal = document.getElementById('createDocModal');
        if (createDocModal) {
            const h2 = createDocModal.querySelector('h2');
            if (h2 && t.createDocument) h2.textContent = t.createDocument;
            const saveBtn = document.getElementById('saveDocBtn');
            if (saveBtn && t.save) saveBtn.textContent = t.save;
            const input = document.getElementById('newDocTitle');
            if (input && t.title) input.placeholder = t.title;
        }
        // Special: import modal
        const importModal = document.getElementById('importModal');
        if (importModal) {
            const h2 = importModal.querySelector('h2');
            if (h2 && t.importDocuments) h2.textContent = t.importDocuments;
            const chooseFiles = importModal.querySelector('label.btn span:last-child');
            if (chooseFiles && t.chooseFiles) chooseFiles.textContent = t.chooseFiles;
            const importBtn = document.getElementById('importFilesBtn');
            if (importBtn && t.import) importBtn.textContent = t.import;
        }
        // Special: settings modal
        const settingsModal = document.getElementById('settingsModal');
        if (settingsModal) {
            const h2 = settingsModal.querySelector('h2');
            if (h2 && t.settings) h2.textContent = t.settings;
            const labels = settingsModal.querySelectorAll('label');
            if (labels[0] && t.theme) labels[0].textContent = t.theme;
            if (labels[1] && t.language) labels[1].textContent = t.language;
        }
        // Special: help modal
        const helpModal = document.getElementById('helpModal');
        if (helpModal) {
            const h2 = helpModal.querySelector('h2');
            if (h2 && t.help) h2.textContent = t.help;
            const ps = helpModal.querySelectorAll('p');
            if (ps[0] && t.termsOfService) ps[0].textContent = t.termsOfService;
            if (ps[2] && t.privacyPolicy) ps[2].textContent = t.privacyPolicy;
        }
        // Special: My Documents
        const myDocs = document.querySelector('.content h2');
        if (myDocs && t.myDocuments) myDocs.textContent = t.myDocuments;
        // Special: Create button
        const createLabel = document.querySelector('.create-label');
        if (createLabel && t.create) createLabel.textContent = t.create;
        // Special: Create Document/Import Documents in create-wrapper
        const createDocBtn = document.getElementById('create-doc-btn');
        if (createDocBtn && t.createDocument) {
            createDocBtn.childNodes.forEach(n => {
                if (n.nodeType === 3) n.textContent = ' ' + t.createDocument;
            });
        }
        const importBtn = document.getElementById('import-btn');
        if (importBtn && t.importDocuments) {
            importBtn.childNodes.forEach(n => {
                if (n.nodeType === 3) n.textContent = ' ' + t.importDocuments;
            });
        }
        // Special: Topbar icons
        const settingsBtn = document.getElementById('settings-btn');
        if (settingsBtn && t.settings) settingsBtn.title = t.settings;
        const helpBtn = document.getElementById('help-btn');
        if (helpBtn && t.help) helpBtn.title = t.help;
        // Special: Grid/List view
        const gridView = document.getElementById('grid-view');
        if (gridView && t.gridView) gridView.title = t.gridView;
        const listView = document.getElementById('list-view');
        if (listView && t.listView) listView.title = t.listView;
        // Special: Footer
        const footer = document.querySelector('.footer p');
        if (footer && t.documents) {
            footer.innerHTML = footer.innerHTML.replace(/GAMERYTDeveloper\. All rights reserved\./, `GAMERYTDeveloper. ${t.documents} © 2025`);
        }

        // --- Editor UI translations ---
        // Tab bar
        const tabBar = [
            { selector: '#file-btn > p', key: 'file' },
            { selector: '#edit-btn > p', key: 'edit' },
            { selector: '#view-btn > p', key: 'view' },
            { selector: '#insert-btn > p', key: 'insert' },
            { selector: '#format-btn > p', key: 'format' }
        ];
        tabBar.forEach(item => {
            const el = document.querySelector(item.selector);
            if (el && t[item.key]) el.textContent = t[item.key];
        });

        // Dropdowns
        const dropdowns = [
            // File
            { selector: '.dropdown-file .item#make-a-copy p', key: 'makeCopy' },
            { selector: '.dropdown-file .item#download p', key: 'download' },
            { selector: '.dropdown-file .item#print p', key: 'print' },
            { selector: '.dropdown-file .item#rename p', key: 'rename' },
            { selector: '.dropdown-file .item#history p', key: 'versionHistory' },
            { selector: '.dropdown-file .item#details p', key: 'details' },
            { selector: '.dropdown-file .item#delete p', key: 'delete' },
            { selector: '.dropdown-file .item#mobile-breakpoints p', key: 'mobileBreakpoints' },
            { selector: '.dropdown-file .item#resize p', key: 'resizePage' },
            // Edit
            { selector: '.dropdown-edit .item#undo p', key: 'undo' },
            { selector: '.dropdown-edit .item#redo p', key: 'redo' },
            { selector: '.dropdown-edit .item#cut p', key: 'cut' },
            { selector: '.dropdown-edit .item#copy p', key: 'copy' },
            { selector: '.dropdown-edit .item#paste p', key: 'paste' },
            { selector: '.dropdown-edit .item#select-all p', key: 'selectAll' },
            { selector: '.dropdown-edit .item#find-replace p', key: 'findReplace' },
            // View
            { selector: '.dropdown-view .item#zoom-in p', key: 'zoomIn' },
            { selector: '.dropdown-view .item#zoom-out p', key: 'zoomOut' },
            { selector: '.dropdown-view .item#reset-zoom p', key: 'resetZoom' },
            { selector: '.dropdown-view .item#fullscreen p', key: 'fullscreen' },
            { selector: '.dropdown-view .item#find-document p', key: 'searchPlaceholder' },
            // Insert
            { selector: '.dropdown-insert .item#insert-image p', key: 'insertImage' },
            { selector: '.dropdown-insert .item#insert-link p', key: 'insertLink' },
            { selector: '.dropdown-insert .item#insert-table p', key: 'insertTable' },
            { selector: '.dropdown-insert .item#insert-code-block p', key: 'insertCodeBlock' },
            { selector: '.dropdown-insert .item#insert-quote p', key: 'insertQuote' },
            { selector: '.dropdown-insert .item#insert-horizontal-rule p', key: 'insertHorizontalRule' },
            { selector: '.dropdown-insert .item#insert-dropdown p', key: 'insertDropdown' },
            // Format
            { selector: '.dropdown-format .item#bold p', key: 'bold' },
            { selector: '.dropdown-format .item#italic p', key: 'italic' },
            { selector: '.dropdown-format .item#underline p', key: 'underline' },
            { selector: '.dropdown-format .item#strikethrough p', key: 'strikethrough' },
            { selector: '.dropdown-format .item#text-color p', key: 'textColor' },
            { selector: '.dropdown-format .item#align-left p', key: 'alignLeft' },
            { selector: '.dropdown-format .item#align-center p', key: 'alignCenter' },
            { selector: '.dropdown-format .item#align-right p', key: 'alignRight' }
        ];
        dropdowns.forEach(item => {
            const el = document.querySelector(item.selector);
            if (el && t[item.key]) el.textContent = t[item.key];
        });

        // Toolbar tooltips (title attributes)
        const toolbarTitles = [
            { selector: '#toolbar-bold', key: 'bold' },
            { selector: '#toolbar-italic', key: 'italic' },
            { selector: '#toolbar-underline', key: 'underline' },
            { selector: '#toolbar-strikethrough', key: 'strikethrough' },
            { selector: '#toolbar-text-color', key: 'textColor' },
            { selector: '#toolbar-align-left', key: 'alignLeft' },
            { selector: '#toolbar-align-center', key: 'alignCenter' },
            { selector: '#toolbar-align-right', key: 'alignRight' },
            { selector: '#bulleted-list', key: 'bulletedList' },
            { selector: '#numbered-list', key: 'numberedList' },
            { selector: '#checklist', key: 'checklist' },
            { selector: '#quote', key: 'insertQuote' },
            { selector: '#divider', key: 'insertHorizontalRule' },
            { selector: '#link', key: 'insertLink' },
            { selector: '#image', key: 'insertImage' }
        ];
        toolbarTitles.forEach(item => {
            const el = document.querySelector(item.selector);
            if (el && t[item.key]) el.title = t[item.key];
        });

        // Editor modal labels (if open)
        // Insert Image Modal
        const imgModal = document.getElementById('insert-image-modal');
        if (imgModal) {
            const label = imgModal.querySelector('label');
            if (label && t.insertImage) label.textContent = t.insertImage;
            const btn = imgModal.querySelector('button');
            if (btn && t.insertImage) btn.textContent = t.insertImage;
        }
        // Insert Table Modal
        const tableModal = document.getElementById('insert-table-modal');
        if (tableModal) {
            const label = tableModal.querySelector('label');
            if (label && t.insertTable) label.textContent = t.insertTable;
            const btn = tableModal.querySelector('button');
            if (btn && t.insertTable) btn.textContent = t.insertTable;
            const inputs = tableModal.querySelectorAll('input');
            if (inputs[0] && t.rows) inputs[0].placeholder = t.rows;
            if (inputs[1] && t.columns) inputs[1].placeholder = t.columns;
        }
        // Insert Code Modal
        const codeModal = document.getElementById('insert-code-modal');
        if (codeModal) {
            const label = codeModal.querySelector('label');
            if (label && t.insertCodeBlock) label.textContent = t.insertCodeBlock;
            const btn = codeModal.querySelector('button');
            if (btn && t.insertCodeBlock) btn.textContent = t.insertCodeBlock;
        }
        // Insert Dropdown Modal
        const dropdownModal = document.getElementById('insert-dropdown-modal');
        if (dropdownModal) {
            const label = dropdownModal.querySelector('label');
            if (label && t.insertDropdown) label.textContent = t.insertDropdown;
            const btn = dropdownModal.querySelector('button');
            if (btn && t.insertDropdown) btn.textContent = t.insertDropdown;
            const textarea = dropdownModal.querySelector('textarea');
            if (textarea && t.options) textarea.placeholder = t.options;
        }
        // Resize Modal
        const resizeModal = document.getElementById('resize-modal');
        if (resizeModal) {
            const label = resizeModal.querySelector('label');
            if (label && t.resizePage) label.textContent = t.resizePage;
            const btn = resizeModal.querySelector('button');
            if (btn && t.apply) btn.textContent = t.apply;
        }

        // Editor Save/Download/Print/Details/History/Undo/Redo/Restore/Restore Version/Show/Hide/Apply/Cancel/Yes/No
        // More options menu
        const moreOptions = document.querySelector('.more-options');
        if (moreOptions) {
            const items = [
                { selector: '.item#print p', key: 'print' },
                { selector: '.item#rename p', key: 'rename' },
                { selector: '.item#details p', key: 'details' },
                { selector: '.item#make-a-copy p', key: 'makeCopy' },
                { selector: '.item#delete p', key: 'delete' }
            ];
            items.forEach(item => {
                const el = moreOptions.querySelector(item.selector);
                if (el && t[item.key]) el.textContent = t[item.key];
            });
        }
        // Save/Download buttons
        const saveBtn = document.getElementById('saveFile');
        if (saveBtn && t.save) {
            const txt = saveBtn.querySelector('.btn-text-2');
            if (txt) txt.textContent = t.save;
        }
        const downloadBtn = document.getElementById('downloadFile');
        if (downloadBtn && t.download) {
            const txt = downloadBtn.querySelector('.btn-text');
            if (txt) txt.textContent = t.download;
        }
        // Editor input placeholder
        const docsNameInput = document.getElementById('docsName');
        if (docsNameInput && t.title) docsNameInput.placeholder = t.title;
    }

    // Update language and UI when language changes
    languageSelect.addEventListener('change', function () {
        document.documentElement.lang = this.value;
        localStorage.setItem('docs_lang', this.value);
        setTextContent();
    });

    // On load, set language from storage and update UI
    document.addEventListener('DOMContentLoaded', function () {
        const savedLang = localStorage.getItem('docs_lang') || 'en';
        document.documentElement.lang = savedLang;
        languageSelect.value = savedLang;
        setTextContent();
    });

    // Also update editor UI when editor is shown (for dynamic elements)
    const origShowEditorLang = window.showEditor;
    window.showEditor = function(idx) {
        origShowEditorLang(idx);
        setTimeout(setTextContent, 0);
    };
    document.addEventListener('DOMContentLoaded', function () {
        var saveFileBtn = document.getElementById('saveFile');
        if (saveFileBtn) {
            saveFileBtn.addEventListener('click', function () {
                // Save all quotes, images, hrs, checklists, bulleted lists, numbered lists, and text formatting
                const idx = sessionStorage.getItem('currentDocIndex');
                if (idx !== null && idx !== undefined && idx !== "") {
                    const docs = JSON.parse(localStorage.getItem('docs') || '[]');
                    const docCanvas = document.getElementById('docCanvas');
                    if (docs[idx] && docCanvas) {
                        docs[idx].content = docCanvas.innerHTML;
                        docs[idx].updatedAt = new Date().toISOString();
                        localStorage.setItem('docs', JSON.stringify(docs));
                        showToast('Saved');
                    } else {
                        showToast('Error: Document not found.');
                    }
                } else {
                    showToast('Error: No document selected.');
                }
            });
        }
    });

    // Toast notification function
    function showToast(msg) {
        let toast = document.getElementById('custom-toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'custom-toast';
            toast.style.position = 'fixed';
            toast.style.bottom = '32px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = 'linear-gradient(90deg,#712cca 0%,#a259e6 100%)';
            toast.style.color = '#fff';
            toast.style.padding = '12px 32px';
            toast.style.borderRadius = '24px';
            toast.style.fontWeight = '600';
            toast.style.fontSize = '1.1em';
            toast.style.boxShadow = '0 4px 16px rgba(113,44,202,0.13)';
            toast.style.zIndex = '9999';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s';
            document.body.appendChild(toast);
        }
        toast.textContent = msg;
        toast.style.opacity = '1';
        setTimeout(() => {
            toast.style.opacity = '0';
        }, 1800);
    }
    /* --- MOBILE BREAKPOINTS FUNCTIONALITY (MODAL WITH DOCUMENT PREVIEW & MANAGE) --- */
    // Remove any existing modal before adding
    function removeMobileBreakpointsModal() {
        const oldModal = document.getElementById('mobile-breakpoints-modal');
        if (oldModal) oldModal.remove();
    }
    function renderMobileBreakpointsModal() {
        removeMobileBreakpointsModal();

        // Modal overlay
        const modal = document.createElement('div');
        modal.id = 'mobile-breakpoints-modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.18)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '4100';

        // Modal content
        const content = document.createElement('div');
        content.style.background = '#fff';
        content.style.borderRadius = '18px';
        content.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
        content.style.padding = '32px 28px 24px 28px';
        content.style.display = 'flex';
        content.style.flexDirection = 'column';
        content.style.alignItems = 'center';
        content.style.position = 'relative';
        content.style.minWidth = '340px';
        content.style.maxWidth = '98vw';
        content.style.maxHeight = '90vh';
        content.style.overflowY = 'auto';

        // Title row
        const titleRow = document.createElement('div');
        titleRow.style.display = 'flex';
        titleRow.style.alignItems = 'center';
        titleRow.style.justifyContent = 'space-between';
        titleRow.style.width = '100%';

        const title = document.createElement('span');
        title.textContent = 'Mobile Breakpoints';
        title.style.fontWeight = '700';
        title.style.fontSize = '1.2em';
        title.style.color = '#712cca';

        const closeBtn = document.createElement('span');
        closeBtn.className = 'material-symbols-outlined';
        closeBtn.textContent = 'close';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.color = '#a259e6';
        closeBtn.style.fontSize = '2em';
        closeBtn.title = 'Close';
        closeBtn.addEventListener('click', removeMobileBreakpointsModal);

        titleRow.appendChild(title);
        titleRow.appendChild(closeBtn);

        // Presets
        const presets = [
            { name: 'iPhone SE', width: 375, height: 667 },
            { name: 'iPhone 12', width: 390, height: 844 },
            { name: 'Pixel 5', width: 393, height: 851 },
            { name: 'iPad Mini', width: 768, height: 1024 },
            { name: 'Galaxy S20', width: 412, height: 915 },
            { name: 'Surface Duo', width: 540, height: 720 }
        ];

        // Inputs row (width, height, font size)
        const whRow = document.createElement('div');
        whRow.style.display = 'flex';
        whRow.style.gap = '12px';
        whRow.style.alignItems = 'center';
        whRow.style.justifyContent = 'center';
        whRow.style.margin = '10px 0';

        const widthInput = document.createElement('input');
        widthInput.type = 'number';
        widthInput.value = 375;
        widthInput.min = 100;
        widthInput.max = 2000;
        widthInput.style.width = '70px';
        widthInput.style.padding = '6px 10px';
        widthInput.style.borderRadius = '8px';
        widthInput.style.border = '1.5px solid #ece6f7';
        widthInput.style.fontSize = '1em';

        const heightInput = document.createElement('input');
        heightInput.type = 'number';
        heightInput.value = 667;
        heightInput.min = 100;
        heightInput.max = 3000;
        heightInput.style.width = '70px';
        heightInput.style.padding = '6px 10px';
        heightInput.style.borderRadius = '8px';
        heightInput.style.border = '1.5px solid #ece6f7';
        heightInput.style.fontSize = '1em';

        // Font size controls
        const fontSizeLabel = document.createElement('span');
        fontSizeLabel.textContent = 'Font:';
        fontSizeLabel.style.marginLeft = '10px';

        const fontMinus = document.createElement('span');
        fontMinus.className = 'material-symbols-outlined';
        fontMinus.textContent = 'remove';
        fontMinus.style.cursor = 'pointer';
        fontMinus.style.color = '#712cca';
        fontMinus.style.fontSize = '1.5em';
        fontMinus.title = 'Decrease font size';

        const fontSizeInput = document.createElement('input');
        fontSizeInput.type = 'number';
        fontSizeInput.value = 16;
        fontSizeInput.min = 8;
        fontSizeInput.max = 64;
        fontSizeInput.style.width = '48px';
        fontSizeInput.style.padding = '4px 6px';
        fontSizeInput.style.borderRadius = '8px';
        fontSizeInput.style.border = '1.5px solid #ece6f7';
        fontSizeInput.style.fontSize = '1em';
        fontSizeInput.style.textAlign = 'center';

        const fontPlus = document.createElement('span');
        fontPlus.className = 'material-symbols-outlined';
        fontPlus.textContent = 'add';
        fontPlus.style.cursor = 'pointer';
        fontPlus.style.color = '#712cca';
        fontPlus.style.fontSize = '1.5em';
        fontPlus.title = 'Increase font size';

        whRow.appendChild(document.createTextNode('Width:'));
        whRow.appendChild(widthInput);
        whRow.appendChild(document.createTextNode('Height:'));
        whRow.appendChild(heightInput);
        whRow.appendChild(fontSizeLabel);
        whRow.appendChild(fontMinus);
        whRow.appendChild(fontSizeInput);
        whRow.appendChild(fontPlus);

        // Preset buttons
        const presetRow = document.createElement('div');
        presetRow.style.display = 'flex';
        presetRow.style.flexWrap = 'wrap';
        presetRow.style.gap = '8px';
        presetRow.style.margin = '8px 0 10px 0';
        presets.forEach(p => {
            const btn = document.createElement('button');
            btn.textContent = p.name;
            btn.style.background = '#ece6f7';
            btn.style.color = '#712cca';
            btn.style.border = 'none';
            btn.style.borderRadius = '8px';
            btn.style.padding = '6px 14px';
            btn.style.cursor = 'pointer';
            btn.style.fontWeight = '600';
            btn.style.fontSize = '0.98em';
            btn.addEventListener('click', () => {
                widthInput.value = p.width;
                heightInput.value = p.height;
                preview.style.width = p.width + 'px';
                preview.style.height = p.height + 'px';
                setPreviewFontSize(fontSizeInput.value);
                syncEditorCanvas(p.width, p.height, fontSizeInput.value);
            });
            presetRow.appendChild(btn);
        });

        // Document preview
        const previewLabel = document.createElement('div');
        previewLabel.textContent = 'Document Preview';
        previewLabel.style.fontWeight = '600';
        previewLabel.style.color = '#712cca';
        previewLabel.style.margin = '10px 0 4px 0';

        const preview = document.createElement('div');
        preview.style.width = '375px';
        preview.style.height = '667px';
        preview.style.border = '2px dashed #a259e6';
        preview.style.borderRadius = '14px';
        preview.style.background = '#f7f3ff';
        preview.style.position = 'relative';
        preview.style.display = 'flex';
        preview.style.alignItems = 'flex-start';
        preview.style.justifyContent = 'center';
        preview.style.overflow = 'auto';
        preview.style.marginBottom = '12px';

        // Clone docCanvas content for preview
        function updatePreviewContent() {
            const docCanvas = document.getElementById('docCanvas');
            preview.innerHTML = '';
            if (docCanvas) {
                const clone = docCanvas.cloneNode(true);
                clone.removeAttribute('id');
                clone.contentEditable = false;
                clone.style.pointerEvents = 'none';
                clone.style.background = 'transparent';
                clone.style.boxShadow = 'none';
                clone.style.margin = '0';
                clone.style.border = 'none';
                clone.style.borderRadius = '0';
                clone.style.width = '100%';
                clone.style.minHeight = '0';
                clone.style.aspectRatio = '';
                clone.style.fontSize = fontSizeInput.value + 'px';
                preview.appendChild(clone);
            }
        }

        // Font size controls logic
        fontMinus.addEventListener('click', () => {
            let v = Math.max(8, parseInt(fontSizeInput.value, 10) - 1);
            fontSizeInput.value = v;
            setPreviewFontSize(v);
            syncEditorCanvas(widthInput.value, heightInput.value, v);
        });
        fontPlus.addEventListener('click', () => {
            let v = Math.min(64, parseInt(fontSizeInput.value, 10) + 1);
            fontSizeInput.value = v;
            setPreviewFontSize(v);
            syncEditorCanvas(widthInput.value, heightInput.value, v);
        });
        fontSizeInput.addEventListener('change', () => {
            let v = Math.max(8, Math.min(64, parseInt(fontSizeInput.value, 10)));
            fontSizeInput.value = v;
            setPreviewFontSize(v);
            syncEditorCanvas(widthInput.value, heightInput.value, v);
        });

        function setPreviewFontSize(size) {
            if (preview.firstChild) preview.firstChild.style.fontSize = size + 'px';
        }

        // Drag handle for resizing preview
        const dragHandle = document.createElement('div');
        dragHandle.style.position = 'absolute';
        dragHandle.style.right = '0';
        dragHandle.style.bottom = '0';
        dragHandle.style.width = '24px';
        dragHandle.style.height = '24px';
        dragHandle.style.background = '#a259e6';
        dragHandle.style.borderRadius = '50%';
        dragHandle.style.cursor = 'nwse-resize';
        dragHandle.style.display = 'flex';
        dragHandle.style.alignItems = 'center';
        dragHandle.style.justifyContent = 'center';
        dragHandle.innerHTML = '<span class="material-symbols-outlined" style="color:#fff;font-size:1.3em;">open_with</span>';
        preview.appendChild(dragHandle);

        // Drag/resize logic
        let dragging = false, startX = 0, startY = 0, startW = 0, startH = 0;
        dragHandle.addEventListener('mousedown', function (e) {
            dragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startW = parseInt(preview.style.width, 10);
            startH = parseInt(preview.style.height, 10);
            document.body.style.userSelect = 'none';
        });
        document.addEventListener('mousemove', function (e) {
            if (dragging) {
                let newW = Math.max(100, startW + (e.clientX - startX));
                let newH = Math.max(100, startH + (e.clientY - startY));
                preview.style.width = newW + 'px';
                preview.style.height = newH + 'px';
                widthInput.value = newW;
                heightInput.value = newH;
                syncEditorCanvas(newW, newH, fontSizeInput.value);
            }
        });
        document.addEventListener('mouseup', function () {
            if (dragging) {
                dragging = false;
                document.body.style.userSelect = '';
            }
        });

        // Sync preview and editor canvas when input changes
        widthInput.addEventListener('input', function () {
            preview.style.width = widthInput.value + 'px';
            syncEditorCanvas(widthInput.value, heightInput.value, fontSizeInput.value);
        });
        heightInput.addEventListener('input', function () {
            preview.style.height = heightInput.value + 'px';
            syncEditorCanvas(widthInput.value, heightInput.value, fontSizeInput.value);
        });

        // Helper: set editor canvas size and font
        function syncEditorCanvas(w, h, fontSize) {
            const editorCanvas = document.querySelector('.editor-canvas');
            if (editorCanvas) {
                editorCanvas.style.maxWidth = w + 'px';
                editorCanvas.style.minHeight = h + 'px';
                editorCanvas.style.width = '';
                editorCanvas.style.aspectRatio = '';
                editorCanvas.style.fontSize = fontSize + 'px';
            }
            updatePreviewContent();
        }

        // Add breakpoint button
        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add Breakpoint';
        addBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
        addBtn.style.color = '#fff';
        addBtn.style.border = 'none';
        addBtn.style.borderRadius = '18px';
        addBtn.style.padding = '8px 24px';
        addBtn.style.cursor = 'pointer';
        addBtn.style.fontWeight = '600';
        addBtn.style.fontSize = '1em';
        addBtn.style.margin = '10px 0';

        // Breakpoint list (with remove icon)
        const breakpointsDiv = document.createElement('div');
        breakpointsDiv.style.display = 'flex';
        breakpointsDiv.style.flexDirection = 'column';
        breakpointsDiv.style.gap = '8px';
        breakpointsDiv.style.width = '100%';
        breakpointsDiv.style.margin = '10px 0';

        // Load breakpoints from localStorage
        let breakpoints = [];
        try {
            breakpoints = JSON.parse(localStorage.getItem('mobileBreakpoints') || '[]');
        } catch { breakpoints = []; }

        function saveBreakpoints() {
            localStorage.setItem('mobileBreakpoints', JSON.stringify(breakpoints));
        }
        function renderBreakpointsList() {
            breakpointsDiv.innerHTML = '';
            if (breakpoints.length === 0) {
                breakpointsDiv.innerHTML = '<div style="color:#888;text-align:center;">No breakpoints saved.</div>';
                return;
            }
            breakpoints.slice().reverse().forEach((bp, i) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.justifyContent = 'space-between';
                row.style.background = '#f7f3ff';
                row.style.borderRadius = '8px';
                row.style.padding = '8px 12px';
                row.style.gap = '10px';

                const info = document.createElement('span');
                info.textContent = `${bp.width} x ${bp.height} | Font: ${bp.fontSize || 16}`;
                info.style.fontWeight = '600';
                info.style.color = '#712cca';

                const useBtn = document.createElement('button');
                useBtn.textContent = 'Use';
                useBtn.style.background = '#ece6f7';
                useBtn.style.color = '#712cca';
                useBtn.style.border = 'none';
                useBtn.style.borderRadius = '8px';
                useBtn.style.padding = '4px 12px';
                useBtn.style.cursor = 'pointer';
                useBtn.style.fontWeight = '600';
                useBtn.style.fontSize = '0.95em';
                useBtn.addEventListener('click', () => {
                    widthInput.value = bp.width;
                    heightInput.value = bp.height;
                    fontSizeInput.value = bp.fontSize || 16;
                    preview.style.width = bp.width + 'px';
                    preview.style.height = bp.height + 'px';
                    setPreviewFontSize(fontSizeInput.value);
                    syncEditorCanvas(bp.width, bp.height, fontSizeInput.value);
                });

                // Remove icon
                const delBtn = document.createElement('span');
                delBtn.className = 'material-symbols-outlined';
                delBtn.textContent = 'remove';
                delBtn.style.cursor = 'pointer';
                delBtn.style.color = '#f44336';
                delBtn.style.fontSize = '1.5em';
                delBtn.title = 'Delete breakpoint';
                delBtn.addEventListener('click', () => {
                    breakpoints.splice(breakpoints.length - 1 - i, 1);
                    saveBreakpoints();
                    renderBreakpointsList();
                });

                row.appendChild(info);
                row.appendChild(useBtn);
                row.appendChild(delBtn);
                breakpointsDiv.appendChild(row);
            });
        }

        // Add breakpoint handler
        addBtn.addEventListener('click', () => {
            const w = parseInt(widthInput.value, 10);
            const h = parseInt(heightInput.value, 10);
            const f = parseInt(fontSizeInput.value, 10);
            if (!w || !h || !f) {
                showToast('Enter valid width, height, and font size.');
                return;
            }
            breakpoints.push({ width: w, height: h, fontSize: f, time: new Date().toISOString() });
            saveBreakpoints();
            renderBreakpointsList();
            showToast('Breakpoint added!');
        });

        // Initial preview content
        updatePreviewContent();

        // Compose modal content
        content.appendChild(titleRow);
        content.appendChild(whRow);
        content.appendChild(presetRow);
        content.appendChild(previewLabel);
        content.appendChild(preview);
        content.appendChild(addBtn);
        content.appendChild(breakpointsDiv);

        modal.appendChild(content);
        document.body.appendChild(modal);

        // Set initial preview/input values to match editor canvas if possible
        const editorCanvas = document.querySelector('.editor-canvas');
        if (editorCanvas) {
            let w = parseInt(editorCanvas.style.maxWidth) || 375;
            let h = parseInt(editorCanvas.style.minHeight) || 667;
            let f = parseInt(editorCanvas.style.fontSize) || 16;
            widthInput.value = w;
            heightInput.value = h;
            fontSizeInput.value = f;
            preview.style.width = w + 'px';
            preview.style.height = h + 'px';
            setPreviewFontSize(f);
            syncEditorCanvas(w, h, f);
        }
        renderBreakpointsList();
    }

    // Always re-bind the click handler to allow multiple opens
    function bindMobileBreakpointsBtn() {
        const btn = document.querySelector('.dropdown-file .item#mobile-breakpoints');
        if (!btn) return;
        btn.removeEventListener('click', btn._mobileBreakpointsHandler || (()=>{}));
        btn._mobileBreakpointsHandler = function () {
            renderMobileBreakpointsModal();
        };
        btn.addEventListener('click', btn._mobileBreakpointsHandler);
    }
    bindMobileBreakpointsBtn();
    // Also re-bind after dropdown closes (in case of dynamic DOM)
    document.addEventListener('DOMContentLoaded', bindMobileBreakpointsBtn);
    /* --- OVERFLOW MENU FUNCTIONALITY --- */
    // Helper: Simulate click for toolbar/format actions
    function triggerToolbarAction(id) {
        const el = document.getElementById(id);
        if (el) el.click();
    }

    // Find in Document
    document.getElementById('overflow-find-in-doc').addEventListener('click', () => {
        triggerToolbarAction('find-in-doc');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });

    // Zoom In/Out
    document.getElementById('overflow-zoom-in').addEventListener('click', () => {
        triggerToolbarAction('zoom-in');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-zoom-out').addEventListener('click', () => {
        triggerToolbarAction('zoom-out');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });

    // Font select
    document.getElementById('overflowFontSelect').addEventListener('change', function () {
        document.getElementById('fontSelect').value = this.value;
        document.getElementById('fontSelect').dispatchEvent(new Event('change'));
    });

    // Font size
    document.getElementById('overflowFontSizeInput').addEventListener('change', function () {
        document.getElementById('fontSizeInput').value = this.value;
        document.getElementById('fontSizeInput').dispatchEvent(new Event('change'));

        });

    // Bold/Italic/Underline/Strikethrough/Text Color
    document.getElementById('overflow-bold').addEventListener('click', () => {
        triggerToolbarAction('toolbar-bold');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-italic').addEventListener('click', () => {
        triggerToolbarAction('toolbar-italic');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-underline').addEventListener('click', () => {
        triggerToolbarAction('toolbar-underline');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-strikethrough').addEventListener('click', () => {
        triggerToolbarAction('toolbar-strikethrough');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-text-color').addEventListener('click', () => {
        triggerToolbarAction('toolbar-text-color');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });

    // Align Left/Center/Right
    document.getElementById('overflow-align-left').addEventListener('click', () => {
        triggerToolbarAction('toolbar-align-left');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-align-center').addEventListener('click', () => {
        triggerToolbarAction('toolbar-align-center');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-align-right').addEventListener('click', () => {
        triggerToolbarAction('toolbar-align-right');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });

    // Bulleted/Numbered List, Checklist, Quote
    document.getElementById('overflow-bulleted-list').addEventListener('click', () => {
        triggerToolbarAction('bulleted-list');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-numbered-list').addEventListener('click', () => {
        triggerToolbarAction('numbered-list');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-checklist').addEventListener('click', () => {
        triggerToolbarAction('checklist');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-quote').addEventListener('click', () => {
        triggerToolbarAction('quote');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });

    // Divider, Link, Image
    document.getElementById('overflow-divider').addEventListener('click', () => {
        triggerToolbarAction('divider');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-link').addEventListener('click', () => {
        triggerToolbarAction('link');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
    document.getElementById('overflow-image').addEventListener('click', () => {
        triggerToolbarAction('image');
        overflowBtn.querySelector('.overflow-menu').style.display = 'none';
    });
     // overflow menu functionality
    const overflowBtn = document.getElementById('overflow-btn');
    if (overflowBtn) {
        const overflowMenu = overflowBtn.querySelector('.overflow-menu');
        if (overflowMenu) {
            // Ensure menu is hidden by default
            overflowMenu.style.display = 'none';
            overflowBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                // Close all other overflow menus if any
                document.querySelectorAll('.overflow-menu').forEach(menu => {
                    if (menu !== overflowMenu) menu.style.display = 'none';
                });
                // Position the menu directly under the icon
                const btnRect = overflowBtn.getBoundingClientRect();
                const menuRect = overflowMenu.getBoundingClientRect();
                // Find the nearest positioned ancestor (should be .toolbar)
                let parent = overflowBtn.parentElement;
                while (parent && window.getComputedStyle(parent).position === 'static') {
                    parent = parent.parentElement;
                }
                const parentRect = parent ? parent.getBoundingClientRect() : { left: 0, top: 0 };
                overflowMenu.style.left = (btnRect.left - parentRect.left) + 'px';
                overflowMenu.style.top = (btnRect.bottom - parentRect.top) + 'px';
                overflowMenu.style.right = '';
                overflowMenu.style.position = 'absolute';
                // Toggle this menu
                overflowMenu.style.display = (overflowMenu.style.display === 'flex') ? 'none' : 'flex';
            });
            // Hide menu when clicking outside
         
            // Hide menu on ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') overflowMenu.style.display = 'none';
            });
        }
    }
    /* --- INSERT IMAGE FUNCTIONALITY --- */
    document.getElementById('image').addEventListener('click', function () {
        openInsertImageModal();
    });
    document.querySelector('.dropdown-insert .item#insert-image').addEventListener('click', function () {
        openInsertImageModal();
    });
    function openInsertImageModal() {
        let imgModal = document.getElementById('insert-image-modal');
        if (!imgModal) {
            imgModal = document.createElement('div');
            imgModal.id = 'insert-image-modal';
            imgModal.style.position = 'fixed';
            imgModal.style.top = '0';
            imgModal.style.left = '0';
            imgModal.style.width = '100vw';
            imgModal.style.height = '100vh';
            imgModal.style.background = 'rgba(0,0,0,0.15)';
            imgModal.style.display = 'flex';
            imgModal.style.alignItems = 'center';
            imgModal.style.justifyContent = 'center';
            imgModal.style.zIndex = '3000';

            const modalContent = document.createElement('div');
            modalContent.style.background = '#fff';
            modalContent.style.borderRadius = '18px';
            modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
            modalContent.style.padding = '28px 24px 20px 24px';
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
            modalContent.style.alignItems = 'center';
            modalContent.style.position = 'relative';
            modalContent.style.minWidth = '320px';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'material-symbols-outlined';
            closeBtn.textContent = 'close';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '12px';
            closeBtn.style.right = '16px';
            closeBtn.style.fontSize = '2em';
            closeBtn.style.color = '#a259e6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.addEventListener('click', () => imgModal.style.display = 'none');

            const label = document.createElement('label');
            label.textContent = 'Insert Image';
            label.style.marginBottom = '18px';
            label.style.fontWeight = '600';
            label.style.color = '#712cca';
            label.style.fontSize = '1.1em';

            const urlInput = document.createElement('input');
            urlInput.type = 'url';
            urlInput.placeholder = 'Image URL (https://...)';
            urlInput.style.marginBottom = '12px';
            urlInput.style.padding = '10px 14px';
            urlInput.style.borderRadius = '8px';
            urlInput.style.border = '1.5px solid #ece6f7';
            urlInput.style.fontSize = '1em';
            urlInput.style.width = '220px';

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.marginBottom = '18px';

            const applyBtn = document.createElement('button');
            applyBtn.textContent = 'Insert Image';
            applyBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
            applyBtn.style.color = '#fff';
            applyBtn.style.border = 'none';
            applyBtn.style.borderRadius = '18px';
            applyBtn.style.padding = '8px 24px';
            applyBtn.style.cursor = 'pointer';
            applyBtn.style.fontWeight = '600';
            applyBtn.style.fontSize = '1em';

            applyBtn.addEventListener('click', function () {
                docCanvas.focus();
                const sel = window.getSelection();
                let img = document.createElement('img');
                img.style.maxWidth = '100%';
                img.style.borderRadius = '8px';
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        img.src = e.target.result;
                        insertImageNode(img, sel);
                        imgModal.style.display = 'none';
                        saveDocContent();
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                } else if (urlInput.value.trim()) {
                    img.src = urlInput.value.trim();
                    insertImageNode(img, sel);
                    imgModal.style.display = 'none';
                    saveDocContent();
                } else {
                    showToast('Please provide an image URL or select a file.');
                }
            });

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(label);
            modalContent.appendChild(urlInput);
            modalContent.appendChild(fileInput);
            modalContent.appendChild(applyBtn);
            imgModal.appendChild(modalContent);
            document.body.appendChild(imgModal);
        }
        imgModal.style.display = 'flex';
    }
    function insertImageNode(img, sel) {
        if (sel && sel.rangeCount > 0 && (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)) {
            const range = sel.getRangeAt(0);
            range.insertNode(img);
            sel.removeAllRanges();
            const newRange = document.createRange();
            newRange.setStartAfter(img);
            newRange.collapse(true);
            sel.addRange(newRange);
            docCanvas.dispatchEvent(new Event('input'));
            saveDocContent();
        }
    }
    
    // Ensure document content is loaded into the editor on page load or when the editor is shown
    function loadDocContent(idx) {
        idx = parseInt(idx, 10);
        const docs = JSON.parse(localStorage.getItem('docs') || '[]');
        if (Number.isInteger(idx) && docs[idx] && docs[idx].content !== undefined) {
            docCanvas.innerHTML = docs[idx].content;
        } else {
            docCanvas.innerHTML = '';
        }
        // Set the current doc index in sessionStorage for saving
        sessionStorage.setItem('currentDocIndex', idx);
    }

    // Patch showEditor to load content when opening a document
    const origShowEditorImage = window.showEditor;
    window.showEditor = function(idx) {
        if (typeof origShowEditorImage === 'function') origShowEditorImage(idx);
        loadDocContent(idx);
    };
    document.addEventListener('DOMContentLoaded', function() {
        if (!document.querySelector('.editor').hidden) {
            const idx = sessionStorage.getItem('currentDocIndex');
            if (idx !== null && idx !== undefined && idx !== "") loadDocContent(idx);
        }
    });

    // Save doc content helper
    function saveDocContent() {
        let idx = sessionStorage.getItem('currentDocIndex');
        idx = parseInt(idx, 10);
        if (Number.isInteger(idx)) {
            const docs = JSON.parse(localStorage.getItem('docs') || '[]');
            if (docs[idx]) {
                docs[idx].content = docCanvas.innerHTML;
                docs[idx].updatedAt = new Date().toISOString();
                localStorage.setItem('docs', JSON.stringify(docs));
            }
        }
    }

    // Always save after any change in docCanvas, including image insertions
    document.getElementById('docCanvas').addEventListener('input', function () {
        saveDocContent();
    });

    // Also save after images are loaded (for pasted or inserted images)
    document.getElementById('docCanvas').addEventListener('DOMNodeInserted', function (e) {
        if (e.target && e.target.tagName === 'IMG') {
            // Wait for image to load before saving, to ensure src is set
            e.target.addEventListener('load', function () {
                saveDocContent();
            });
            // In case image is already loaded (e.g. data URL)
            if (e.target.complete) {
                saveDocContent();
            }
        }
    });

    /* --- MAKE QUOTES MOVEABLE AND COLOR-CHANGEABLE --- */
    // (code is handled after docCanvas is defined, see below)

    /* --- INSERT TABLE FUNCTIONALITY --- */
    document.getElementById('insert-table').addEventListener('click', function () {
        openInsertTableModal();
    });
    document.querySelector('.dropdown-insert .item#insert-table').addEventListener('click', function () {
        openInsertTableModal();
    });
    function openInsertTableModal() {
        let tableModal = document.getElementById('insert-table-modal');
        if (!tableModal) {
            tableModal = document.createElement('div');
            tableModal.id = 'insert-table-modal';
            tableModal.style.position = 'fixed';
            tableModal.style.top = '0';
            tableModal.style.left = '0';
            tableModal.style.width = '100vw';
            tableModal.style.height = '100vh';
            tableModal.style.background = 'rgba(0,0,0,0.15)';
            tableModal.style.display = 'flex';
            tableModal.style.alignItems = 'center';
            tableModal.style.justifyContent = 'center';
            tableModal.style.zIndex = '3000';

            const modalContent = document.createElement('div');
            modalContent.style.background = '#fff';
            modalContent.style.borderRadius = '18px';
            modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
            modalContent.style.padding = '28px 24px 20px 24px';
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
            modalContent.style.alignItems = 'center';
            modalContent.style.position = 'relative';
            modalContent.style.minWidth = '320px';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'material-symbols-outlined';
            closeBtn.textContent = 'close';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '12px';
            closeBtn.style.right = '16px';
            closeBtn.style.fontSize = '2em';
            closeBtn.style.color = '#a259e6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.addEventListener('click', () => tableModal.style.display = 'none');

            const label = document.createElement('label');
            label.textContent = 'Insert Table';
            label.style.marginBottom = '18px';
            label.style.fontWeight = '600';
            label.style.color = '#712cca';
            label.style.fontSize = '1.1em';

            const rowsInput = document.createElement('input');
            rowsInput.type = 'number';
            rowsInput.placeholder = 'Rows';
            rowsInput.value = 2;
            rowsInput.min = 1;
            rowsInput.style.marginBottom = '8px';
            rowsInput.style.padding = '8px 12px';
            rowsInput.style.borderRadius = '8px';
            rowsInput.style.border = '1.5px solid #ece6f7';
            rowsInput.style.fontSize = '1em';
            rowsInput.style.width = '120px';

            const colsInput = document.createElement('input');
            colsInput.type = 'number';
            colsInput.placeholder = 'Columns';
            colsInput.value = 2;
            colsInput.min = 1;
            colsInput.style.marginBottom = '18px';
            colsInput.style.padding = '8px 12px';
            colsInput.style.borderRadius = '8px';
            colsInput.style.border = '1.5px solid #ece6f7';
            colsInput.style.fontSize = '1em';
            colsInput.style.width = '120px';

            const applyBtn = document.createElement('button');
            applyBtn.textContent = 'Insert Table';
            applyBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
            applyBtn.style.color = '#fff';
            applyBtn.style.border = 'none';
            applyBtn.style.borderRadius = '18px';
            applyBtn.style.padding = '8px 24px';
            applyBtn.style.cursor = 'pointer';
            applyBtn.style.fontWeight = '600';
            applyBtn.style.fontSize = '1em';

            applyBtn.addEventListener('click', function () {
                const rows = Math.max(1, parseInt(rowsInput.value, 10));
                const cols = Math.max(1, parseInt(colsInput.value, 10));
                docCanvas.focus();
                const sel = window.getSelection();
                const table = document.createElement('table');
                table.style.borderCollapse = 'collapse';
                table.style.margin = '12px 0';
                table.style.width = '100%';
                table.style.background = '#fff';
                table.style.border = '1px solid #a259e6';
                for (let i = 0; i < rows; i++) {
                    const tr = document.createElement('tr');
                    for (let j = 0; j < cols; j++) {
                        const td = document.createElement('td');
                        td.textContent = ' ';
                        td.style.border = '1px solid #a259e6';
                        td.style.padding = '8px';
                        tr.appendChild(td);
                    }
                    table.appendChild(tr);
                }
                if (sel && sel.rangeCount > 0 && (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)) {
                    const range = sel.getRangeAt(0);
                    range.insertNode(table);
                    sel.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.setStartAfter(table);
                    newRange.collapse(true);
                    sel.addRange(newRange);
                    docCanvas.dispatchEvent(new Event('input'));
                }
                tableModal.style.display = 'none';
            });

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(label);
            modalContent.appendChild(rowsInput);
            modalContent.appendChild(colsInput);
            modalContent.appendChild(applyBtn);
            tableModal.appendChild(modalContent);
            document.body.appendChild(tableModal);
        }
        tableModal.style.display = 'flex';
    }

    /* --- INSERT CODE BLOCK FUNCTIONALITY --- */
    document.getElementById('insert-code-block').addEventListener('click', function () {
        openInsertCodeModal();
    });
    document.querySelector('.dropdown-insert .item#insert-code-block').addEventListener('click', function () {
        openInsertCodeModal();
    });
    function openInsertCodeModal() {
        let codeModal = document.getElementById('insert-code-modal');
        if (!codeModal) {
            codeModal = document.createElement('div');
            codeModal.id = 'insert-code-modal';
            codeModal.style.position = 'fixed';
            codeModal.style.top = '0';
            codeModal.style.left = '0';
            codeModal.style.width = '100vw';
            codeModal.style.height = '100vh';
            codeModal.style.background = 'rgba(0,0,0,0.15)';
            codeModal.style.display = 'flex';
            codeModal.style.alignItems = 'center';
            codeModal.style.justifyContent = 'center';
            codeModal.style.zIndex = '3000';

            const modalContent = document.createElement('div');
            modalContent.style.background = '#fff';
            modalContent.style.borderRadius = '18px';
            modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
            modalContent.style.padding = '28px 24px 20px 24px';
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
            modalContent.style.alignItems = 'center';
            modalContent.style.position = 'relative';
            modalContent.style.minWidth = '320px';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'material-symbols-outlined';
            closeBtn.textContent = 'close';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '12px';
            closeBtn.style.right = '16px';
            closeBtn.style.fontSize = '2em';
            closeBtn.style.color = '#a259e6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.addEventListener('click', () => codeModal.style.display = 'none');

            const label = document.createElement('label');
            label.textContent = 'Insert Code Block';
            label.style.marginBottom = '18px';
            label.style.fontWeight = '600';
            label.style.color = '#712cca';
            label.style.fontSize = '1.1em';

            const textarea = document.createElement('textarea');
            textarea.placeholder = 'Paste or type your code here...';
            textarea.style.marginBottom = '18px';
            textarea.style.padding = '10px 14px';
            textarea.style.borderRadius = '8px';
            textarea.style.border = '1.5px solid #ece6f7';
            textarea.style.fontSize = '1em';
            textarea.style.width = '260px';
            textarea.style.height = '100px';
            textarea.style.fontFamily = 'Consolas, monospace';

            const applyBtn = document.createElement('button');
            applyBtn.textContent = 'Insert Code';
            applyBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
            applyBtn.style.color = '#fff';
            applyBtn.style.border = 'none';
            applyBtn.style.borderRadius = '18px';
            applyBtn.style.padding = '8px 24px';
            applyBtn.style.cursor = 'pointer';
            applyBtn.style.fontWeight = '600';
            applyBtn.style.fontSize = '1em';

            applyBtn.addEventListener('click', function () {
                const code = textarea.value;
                if (!code) {
                    showToast('Please enter code.');
                    return;
                }
                docCanvas.focus();
                const sel = window.getSelection();
                const pre = document.createElement('pre');
                pre.style.background = '#f7f3ff';
                pre.style.border = '1px solid #a259e6';
                pre.style.borderRadius = '8px';
                pre.style.padding = '12px';
                pre.style.fontFamily = 'Consolas, monospace';
                pre.style.fontSize = '1em';
                pre.style.overflowX = 'auto';
                pre.textContent = code;
                if (sel && sel.rangeCount > 0 && (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)) {
                    const range = sel.getRangeAt(0);
                    range.insertNode(pre);
                    sel.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.setStartAfter(pre);
                    newRange.collapse(true);
                    sel.addRange(newRange);
                    docCanvas.dispatchEvent(new Event('input'));
                }
                codeModal.style.display = 'none';
            });

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(label);
            modalContent.appendChild(textarea);
            modalContent.appendChild(applyBtn);
            codeModal.appendChild(modalContent);
            document.body.appendChild(codeModal);
        }
        codeModal.style.display = 'flex';
    }

    /* --- FULLSCREEN FUNCTIONALITY --- */
    document.querySelector('.dropdown-view .item#fullscreen').addEventListener('click', function () {
        const editor = document.querySelector('.editor');
        if (!document.fullscreenElement) {
            editor.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    });

/* --- RESIZE PAGE FUNCTIONALITY --- */
document.querySelector('.dropdown-file .item#resize').addEventListener('click', function () {
    openResizeModal();
});
function openResizeModal() {
    let resizeModal = document.getElementById('resize-modal');
    if (!resizeModal) {
        resizeModal = document.createElement('div');
        resizeModal.id = 'resize-modal';
        resizeModal.style.position = 'fixed';
        resizeModal.style.top = '0';
        resizeModal.style.left = '0';
        resizeModal.style.width = '100vw';
        resizeModal.style.height = '100vh';
        resizeModal.style.background = 'rgba(0,0,0,0.15)';
        resizeModal.style.display = 'flex';
        resizeModal.style.alignItems = 'center';
        resizeModal.style.justifyContent = 'center';
        resizeModal.style.zIndex = '3000';

        const modalContent = document.createElement('div');
        modalContent.style.background = '#fff';
        modalContent.style.borderRadius = '18px';
        modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
        modalContent.style.padding = '28px 24px 20px 24px';
        modalContent.style.display = 'flex';
        modalContent.style.flexDirection = 'column';
        modalContent.style.alignItems = 'center';
        modalContent.style.position = 'relative';
        modalContent.style.minWidth = '320px';

        const closeBtn = document.createElement('span');
        closeBtn.className = 'material-symbols-outlined';
        closeBtn.textContent = 'close';
        closeBtn.style.position = 'absolute';
        closeBtn.style.top = '12px';
        closeBtn.style.right = '16px';
        closeBtn.style.fontSize = '2em';
        closeBtn.style.color = '#a259e6';
        closeBtn.style.cursor = 'pointer';
        closeBtn.addEventListener('click', () => resizeModal.style.display = 'none');

        const label = document.createElement('label');
        label.textContent = 'Resize Page';
        label.style.marginBottom = '18px';
        label.style.fontWeight = '600';
        label.style.color = '#712cca';
        label.style.fontSize = '1.1em';

        // Dropdown for mode
        const modeSelect = document.createElement('select');
        modeSelect.style.marginBottom = '14px';
        modeSelect.style.padding = '8px 12px';
        modeSelect.style.borderRadius = '8px';
        modeSelect.style.border = '1.5px solid #ece6f7';
        modeSelect.style.fontSize = '1em';
        modeSelect.innerHTML = `
            <option value="fixed">Fixed Width</option>
            <option value="good">Good Width (Responsive)</option>
        `;

        // Fixed width inputs
        const fixedDiv = document.createElement('div');
        fixedDiv.style.display = 'flex';
        fixedDiv.style.gap = '10px';
        fixedDiv.style.marginBottom = '12px';
        const widthInput = document.createElement('input');
        widthInput.type = 'number';
        widthInput.placeholder = 'Width (px)';
        widthInput.value = '794';
        widthInput.min = '100';
        widthInput.style.width = '90px';
        widthInput.style.padding = '8px 12px';
        widthInput.style.borderRadius = '8px';
        widthInput.style.border = '1.5px solid #ece6f7';
        widthInput.style.fontSize = '1em';
        const heightInput = document.createElement('input');
        heightInput.type = 'number';
        heightInput.placeholder = 'Height (px)';
        heightInput.value = '1123';
        heightInput.min = '100';
        heightInput.style.width = '90px';
        heightInput.style.padding = '8px 12px';
        heightInput.style.borderRadius = '8px';
        heightInput.style.border = '1.5px solid #ece6f7';
        heightInput.style.fontSize = '1em';
        fixedDiv.appendChild(widthInput);
        fixedDiv.appendChild(heightInput);

        // Good width input
        const goodDiv = document.createElement('div');
        goodDiv.style.display = 'none';
        goodDiv.style.marginBottom = '12px';
        const maxWidthInput = document.createElement('input');
        maxWidthInput.type = 'number';
        maxWidthInput.placeholder = 'Max Width (px)';
        maxWidthInput.value = '900';
        maxWidthInput.min = '100';
        maxWidthInput.style.width = '120px';
        maxWidthInput.style.padding = '8px 12px';
        maxWidthInput.style.borderRadius = '8px';
        maxWidthInput.style.border = '1.5px solid #ece6f7';
        maxWidthInput.style.fontSize = '1em';
        goodDiv.appendChild(maxWidthInput);

        // Apply button
        const applyBtn = document.createElement('button');
        applyBtn.textContent = 'Apply';
        applyBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
        applyBtn.style.color = '#fff';
        applyBtn.style.border = 'none';
        applyBtn.style.borderRadius = '18px';
        applyBtn.style.padding = '8px 24px';
        applyBtn.style.cursor = 'pointer';
        applyBtn.style.fontWeight = '600';
        applyBtn.style.fontSize = '1em';

        // Mode change logic
        modeSelect.addEventListener('change', function () {
            if (modeSelect.value === 'fixed') {
                fixedDiv.style.display = 'flex';
                goodDiv.style.display = 'none';
            } else {
                fixedDiv.style.display = 'none';
                goodDiv.style.display = 'block';
            }
        });

        applyBtn.addEventListener('click', function () {
            const editorCanvas = document.querySelector('.editor-canvas');
            const idx = sessionStorage.getItem('currentDocIndex');
            const docs = JSON.parse(localStorage.getItem('docs') || '[]');
            if (modeSelect.value === 'fixed') {
                const w = parseInt(widthInput.value, 10);
                const h = parseInt(heightInput.value, 10);
                if (!w || !h) {
                    showToast('Enter valid width and height.');
                    return;
                }
                editorCanvas.style.maxWidth = w + 'px';
                editorCanvas.style.minHeight = h + 'px';
                editorCanvas.style.width = w + 'px';
                editorCanvas.style.height = h + 'px';
                editorCanvas.style.aspectRatio = '';
                // Save to doc
                if (idx !== null && docs[idx]) {
                    docs[idx].resizeMode = 'fixed';
                    docs[idx].width = w;
                    docs[idx].height = h;
                    docs[idx].maxWidth = null;
                    localStorage.setItem('docs', JSON.stringify(docs));
                }
            } else {
                const mw = parseInt(maxWidthInput.value, 10);
                if (!mw) {
                    showToast('Enter valid max width.');
                    return;
                }
                editorCanvas.style.maxWidth = mw + 'px';
                editorCanvas.style.width = '';
                editorCanvas.style.height = '';
                editorCanvas.style.minHeight = '';
                editorCanvas.style.aspectRatio = '';
                // Save to doc
                if (idx !== null && docs[idx]) {
                    docs[idx].resizeMode = 'good';
                    docs[idx].maxWidth = mw;
                    docs[idx].width = null;
                    docs[idx].height = null;
                    localStorage.setItem('docs', JSON.stringify(docs));
                }
            }
            resizeModal.style.display = 'none';
            showToast('Page resized!');
        });

        modalContent.appendChild(closeBtn);
        modalContent.appendChild(label);
        modalContent.appendChild(modeSelect);
        modalContent.appendChild(fixedDiv);
        modalContent.appendChild(goodDiv);
        modalContent.appendChild(applyBtn);
        resizeModal.appendChild(modalContent);
        document.body.appendChild(resizeModal);
    }
    // Restore previous settings if available
    const idx = sessionStorage.getItem('currentDocIndex');
    const docs = JSON.parse(localStorage.getItem('docs') || '[]');
    if (idx !== null && docs[idx]) {
        if (docs[idx].resizeMode === 'fixed') {
            document.querySelector('#resize-modal select').value = 'fixed';
            document.querySelector('#resize-modal input[placeholder="Width (px)"]').value = docs[idx].width || '794';
            document.querySelector('#resize-modal input[placeholder="Height (px)"]').value = docs[idx].height || '1123';
            document.querySelector('#resize-modal div:nth-child(4)').style.display = 'flex';
            document.querySelector('#resize-modal div:nth-child(5)').style.display = 'none';
        } else if (docs[idx].resizeMode === 'good') {
            document.querySelector('#resize-modal select').value = 'good';
            document.querySelector('#resize-modal input[placeholder="Max Width (px)"]').value = docs[idx].maxWidth || '900';
            document.querySelector('#resize-modal div:nth-child(4)').style.display = 'none';
            document.querySelector('#resize-modal div:nth-child(5)').style.display = 'block';
        }
    }
    resizeModal.style.display = 'flex';
}

// Restore resize settings on editor load
function restoreResizeSettings() {
    const idx = sessionStorage.getItem('currentDocIndex');
    const docs = JSON.parse(localStorage.getItem('docs') || '[]');
    const editorCanvas = document.querySelector('.editor-canvas');
    if (idx !== null && docs[idx]) {
        if (docs[idx].resizeMode === 'fixed') {
            editorCanvas.style.maxWidth = docs[idx].width + 'px';
            editorCanvas.style.minHeight = docs[idx].height + 'px';
            editorCanvas.style.width = docs[idx].width + 'px';
            editorCanvas.style.height = docs[idx].height + 'px';
            editorCanvas.style.aspectRatio = '';
        } else if (docs[idx].resizeMode === 'good') {
            editorCanvas.style.maxWidth = docs[idx].maxWidth + 'px';
            editorCanvas.style.width = '';
            editorCanvas.style.height = '';
            editorCanvas.style.minHeight = '';
            editorCanvas.style.aspectRatio = '';
        } else {
            // Default
            editorCanvas.style.maxWidth = '794px';
            editorCanvas.style.minHeight = '1123px';
            editorCanvas.style.width = '';
            editorCanvas.style.height = '';
            editorCanvas.style.aspectRatio = '210/297';
        }
    }
}
const origShowEditorResize = window.showEditor;
window.showEditor = function(idx) {
    origShowEditorResize(idx);
    restoreResizeSettings();
};
document.addEventListener('DOMContentLoaded', function() {
    if (!document.querySelector('.editor').hidden) {
        restoreResizeSettings();
    }
});
    /* --- DETAILS FUNCTIONALITY --- */
    document.querySelectorAll('.dropdown-file .item#details, .more-options .item#details').forEach(btn => {
        btn.addEventListener('click', function () {
            openDetailsModal();
        });
    });
    function openDetailsModal() {
        let detailsModal = document.getElementById('details-modal');
        if (!detailsModal) {
            detailsModal = document.createElement('div');
            detailsModal.id = 'details-modal';
            detailsModal.style.position = 'fixed';
            detailsModal.style.top = '0';
            detailsModal.style.left = '0';
            detailsModal.style.width = '100vw';
            detailsModal.style.height = '100vh';
            detailsModal.style.background = 'rgba(0,0,0,0.15)';
            detailsModal.style.display = 'flex';
            detailsModal.style.alignItems = 'center';
            detailsModal.style.justifyContent = 'center';
            detailsModal.style.zIndex = '3000';

            const modalContent = document.createElement('div');
            modalContent.style.background = '#fff';
            modalContent.style.borderRadius = '18px';
            modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
            modalContent.style.padding = '28px 24px 20px 24px';
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
            modalContent.style.alignItems = 'center';
            modalContent.style.position = 'relative';
            modalContent.style.minWidth = '320px';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'material-symbols-outlined';
            closeBtn.textContent = 'close';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '12px';
            closeBtn.style.right = '16px';
            closeBtn.style.fontSize = '2em';
            closeBtn.style.color = '#a259e6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.addEventListener('click', () => detailsModal.style.display = 'none');

            const label = document.createElement('label');
            label.textContent = 'Document Details';
            label.style.marginBottom = '18px';
            label.style.fontWeight = '600';
            label.style.color = '#712cca';
            label.style.fontSize = '1.1em';

            const idx = getCurrentDocIndex();
            const docs = getDocs();
            let doc = docs[idx] || {};
            const detailsDiv = document.createElement('div');
            detailsDiv.style.textAlign = 'left';
            detailsDiv.innerHTML = `
                <b>Title:</b> ${doc.title || ''}<br>
                <b>Characters:</b> ${doc.content ? doc.content.replace(/<[^>]+>/g, '').length : 0}<br>
                <b>Words:</b> ${doc.content ? doc.content.replace(/<[^>]+>/g, '').split(/\s+/).filter(Boolean).length : 0}<br>
                <b>Font:</b> ${doc.fontFamily || 'Segoe UI'}<br>
                <b>Created:</b> ${doc.createdAt ? new Date(doc.createdAt).toLocaleString() : 'N/A'}<br>
                <b>Last Modified:</b> ${doc.updatedAt ? new Date(doc.updatedAt).toLocaleString() : 'N/A'}
            `;

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(label);
            modalContent.appendChild(detailsDiv);
            detailsModal.appendChild(modalContent);
            document.body.appendChild(detailsModal);
        }
        detailsModal.style.display = 'flex';
    }

    /* --- DOWNLOAD BUTTON FUNCTIONALITY --- */
    document.getElementById('downloadFile').addEventListener('click', function () {
        const idx = getCurrentDocIndex();
        const docs = getDocs();
        if (idx !== null && docs[idx]) {
            // Strip HTML tags for plain text download
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = docs[idx].content || '';
            const plainText = tempDiv.textContent || tempDiv.innerText || '';
            const blob = new Blob([plainText], { type: "text/plain" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = (docs[idx].title || 'document') + '.txt';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(a.href);
                a.remove();
            }, 100);
        }
    });
    document.querySelector('.dropdown-file .item#download').addEventListener('click', function () {
        document.getElementById('downloadFile').click();
    });

    /* --- PRINT FUNCTIONALITY --- */
    document.querySelectorAll('.dropdown-file .item#print, .more-options .item#print').forEach(btn => {
        btn.addEventListener('click', function () {
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Print</title></head><body>' + docCanvas.innerHTML + '</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        });
    });

    /* --- RENAME FUNCTIONALITY --- */
    document.querySelectorAll('.dropdown-file .item#rename, .more-options .item#rename').forEach(btn => {
        btn.addEventListener('click', function () {
            const docsNameInput = document.getElementById('docsName');
            docsNameInput.focus();
            docsNameInput.select();
        });
    });

    /* --- MAKE A COPY FUNCTIONALITY --- */
    document.querySelectorAll('.dropdown-file .item#make-a-copy, .more-options .item#make-a-copy').forEach(btn => {
        btn.addEventListener('click', function () {
            const idx = getCurrentDocIndex();
            const docs = getDocs();
            if (idx !== null && docs[idx]) {
                const copy = { ...docs[idx], title: docs[idx].title + ' (Copy)' };
                docs.push(copy);
                setDocs(docs);
                showToast('Document copied!');
            }
        });
    });

    /* --- DELETE FUNCTIONALITY (with custom modal) --- */
    document.querySelectorAll('.dropdown-file .item#delete, .more-options .item#delete').forEach(btn => {
        btn.addEventListener('click', function () {
            const idx = getCurrentDocIndex();
            const docs = getDocs();
            if (idx !== null && docs[idx]) {
                // Create or show a custom confirmation modal
                let deleteModal = document.getElementById('delete-confirm-modal');
                if (!deleteModal) {
                    deleteModal = document.createElement('div');
                    deleteModal.id = 'delete-confirm-modal';
                    deleteModal.style.position = 'fixed';
                    deleteModal.style.top = '0';
                    deleteModal.style.left = '0';
                    deleteModal.style.width = '100vw';
                    deleteModal.style.height = '100vh';
                    deleteModal.style.background = 'rgba(0,0,0,0.15)';
                    deleteModal.style.display = 'flex';
                    deleteModal.style.alignItems = 'center';
                    deleteModal.style.justifyContent = 'center';
                    deleteModal.style.zIndex = '3000';

                    const modalContent = document.createElement('div');
                    modalContent.style.background = '#fff';
                    modalContent.style.borderRadius = '18px';
                    modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
                    modalContent.style.padding = '28px 24px 20px 24px';
                    modalContent.style.display = 'flex';
                    modalContent.style.flexDirection = 'column';
                    modalContent.style.alignItems = 'center';
                    modalContent.style.position = 'relative';
                    modalContent.style.minWidth = '320px';

                    const closeBtn = document.createElement('span');
                    closeBtn.className = 'material-symbols-outlined';
                    closeBtn.textContent = 'close';
                    closeBtn.style.position = 'absolute';
                    closeBtn.style.top = '12px';
                    closeBtn.style.right = '16px';
                    closeBtn.style.fontSize = '2em';
                    closeBtn.style.color = '#a259e6';
                    closeBtn.style.cursor = 'pointer';
                    closeBtn.addEventListener('click', () => deleteModal.style.display = 'none');

                    const label = document.createElement('label');
                    label.textContent = 'Delete this document?';
                    label.style.marginBottom = '18px';
                    label.style.fontWeight = '600';
                    label.style.color = '#712cca';
                    label.style.fontSize = '1.1em';

                    const msg = document.createElement('div');
                    msg.textContent = 'Are you sure you want to delete this document? This action cannot be undone.';
                    msg.style.marginBottom = '18px';
                    msg.style.textAlign = 'center';
                    msg.style.color = '#333';

                    const btnRow = document.createElement('div');
                    btnRow.style.display = 'flex';
                    btnRow.style.gap = '16px';

                    const yesBtn = document.createElement('button');
                    yesBtn.textContent = 'Delete';
                    yesBtn.style.background = 'linear-gradient(90deg, #f44336 0%, #a259e6 100%)';
                    yesBtn.style.color = '#fff';
                    yesBtn.style.border = 'none';
                    yesBtn.style.borderRadius = '12px';
                    yesBtn.style.padding = '8px 24px';
                    yesBtn.style.cursor = 'pointer';
                    yesBtn.style.fontWeight = '600';
                    yesBtn.style.fontSize = '1em';

                    const noBtn = document.createElement('button');
                    noBtn.textContent = 'Cancel';
                    noBtn.style.background = '#ece6f7';
                    noBtn.style.color = '#712cca';
                    noBtn.style.border = 'none';
                    noBtn.style.borderRadius = '12px';
                    noBtn.style.padding = '8px 24px';
                    noBtn.style.cursor = 'pointer';
                    noBtn.style.fontWeight = '600';
                    noBtn.style.fontSize = '1em';

                    yesBtn.addEventListener('click', function () {
                        docs.splice(idx, 1);
                        setDocs(docs);
                        showToast('Document deleted!');
                        hideEditor();
                        renderDocs(currentView);
                        deleteModal.style.display = 'none';
                    });
                    noBtn.addEventListener('click', function () {
                        deleteModal.style.display = 'none';
                    });

                    btnRow.appendChild(yesBtn);
                    btnRow.appendChild(noBtn);

                    modalContent.appendChild(closeBtn);
                    modalContent.appendChild(label);
                    modalContent.appendChild(msg);
                    modalContent.appendChild(btnRow);
                    deleteModal.appendChild(modalContent);
                    document.body.appendChild(deleteModal);
                }
                deleteModal.style.display = 'flex';
            }
        });
    });

    /* --- INSERT DROPDOWN FUNCTIONALITY --- */
    document.getElementById('insert-dropdown').addEventListener('click', function () {
        openInsertDropdownModal();
    });
    document.querySelector('.dropdown-insert .item#insert-dropdown').addEventListener('click', function () {
        openInsertDropdownModal();
    });
    function openInsertDropdownModal() {
        let dropdownModal = document.getElementById('insert-dropdown-modal');
        if (!dropdownModal) {
            dropdownModal = document.createElement('div');
            dropdownModal.id = 'insert-dropdown-modal';
            dropdownModal.style.position = 'fixed';
            dropdownModal.style.top = '0';
            dropdownModal.style.left = '0';
            dropdownModal.style.width = '100vw';
            dropdownModal.style.height = '100vh';
            dropdownModal.style.background = 'rgba(0,0,0,0.15)';
            dropdownModal.style.display = 'flex';
            dropdownModal.style.alignItems = 'center';
            dropdownModal.style.justifyContent = 'center';
            dropdownModal.style.zIndex = '3000';

            const modalContent = document.createElement('div');
            modalContent.style.background = '#fff';
            modalContent.style.borderRadius = '18px';
            modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
            modalContent.style.padding = '28px 24px 20px 24px';
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
            modalContent.style.alignItems = 'center';
            modalContent.style.position = 'relative';
            modalContent.style.minWidth = '320px';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'material-symbols-outlined';
            closeBtn.textContent = 'close';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '12px';
            closeBtn.style.right = '16px';
            closeBtn.style.fontSize = '2em';
            closeBtn.style.color = '#a259e6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.addEventListener('click', () => dropdownModal.style.display = 'none');

            const label = document.createElement('label');
            label.textContent = 'Insert Dropdown';
            label.style.marginBottom = '18px';
            label.style.fontWeight = '600';
            label.style.color = '#712cca';
            label.style.fontSize = '1.1em';

            const optionsInput = document.createElement('textarea');
            optionsInput.placeholder = 'Enter options, one per line';
            optionsInput.style.marginBottom = '18px';
            optionsInput.style.padding = '10px 14px';
            optionsInput.style.borderRadius = '8px';
            optionsInput.style.border = '1.5px solid #ece6f7';
            optionsInput.style.fontSize = '1em';
            optionsInput.style.width = '220px';
            optionsInput.style.height = '80px';

            const applyBtn = document.createElement('button');
            applyBtn.textContent = 'Insert Dropdown';
            applyBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
            applyBtn.style.color = '#fff';
            applyBtn.style.border = 'none';
            applyBtn.style.borderRadius = '18px';
            applyBtn.style.padding = '8px 24px';
            applyBtn.style.cursor = 'pointer';
            applyBtn.style.fontWeight = '600';
            applyBtn.style.fontSize = '1em';

            applyBtn.addEventListener('click', function () {
                const options = optionsInput.value.split('\n').map(o => o.trim()).filter(Boolean);
                if (!options.length) {
                    showToast('Please enter at least one option.');
                    return;
                }
                docCanvas.focus();
                const sel = window.getSelection();
                const select = document.createElement('select');
                select.style.padding = '6px 12px';
                select.style.borderRadius = '6px';
                select.style.border = '1.5px solid #a259e6';
                select.style.fontSize = '1em';
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    select.appendChild(option);
                });
                if (sel && sel.rangeCount > 0 && (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)) {
                    const range = sel.getRangeAt(0);
                    range.insertNode(select);
                    sel.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.setStartAfter(select);
                    newRange.collapse(true);
                    sel.addRange(newRange);
                    docCanvas.dispatchEvent(new Event('input'));
                }
                dropdownModal.style.display = 'none';
            });

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(label);
            modalContent.appendChild(optionsInput);
            modalContent.appendChild(applyBtn);
            dropdownModal.appendChild(modalContent);
            document.body.appendChild(dropdownModal);
        }
        dropdownModal.style.display = 'flex';
    }
    /* --- RICH TEXT EDITOR BUTTONS FUNCTIONALITY --- */

    // Ensure docCanvas is defined before using it
    const docCanvas = document.getElementById('docCanvas');

    // Helper: Get current font family from docCanvas style or fallback to fontSelect value
    function getCurrentFontFamily() {
        let fam = docCanvas.style.fontFamily;
        if (!fam || fam === 'inherit') fam = document.getElementById('fontSelect').value || 'Segoe UI';
        return fam;
    }

    // Helper: focus and execCommand wrapper, preserves selection after formatting and applies font family
    function execEditorCommand(cmd, value = null) {
        docCanvas.focus();
        // For bold, italic, underline, strikethrough, use browser default
        if (['bold', 'italic', 'underline', 'strikeThrough'].includes(cmd)) {
            document.execCommand(cmd, false, value);
            docCanvas.dispatchEvent(new Event('input'));
            return;
        }
        // For align, use browser default
        if (['justifyLeft', 'justifyCenter', 'justifyRight'].includes(cmd)) {
            document.execCommand(cmd, false, value);
            docCanvas.dispatchEvent(new Event('input'));
            return;
        }
        // For other commands (like color/font-size), use manual span logic
        const sel = window.getSelection();
        const fontFamily = getCurrentFontFamily();
        if (
            sel &&
            sel.rangeCount > 0 &&
            docCanvas.contains(sel.getRangeAt(0).commonAncestorContainer)
        ) {
            if (!sel.isCollapsed) {
                const range = sel.getRangeAt(0);
                if (cmd === 'foreColor' || cmd === 'hiliteColor') {
                    // Wrap selection in a span with color style and font family
                    const span = document.createElement('span');
                    if (cmd === 'foreColor') span.style.color = value;
                    if (cmd === 'hiliteColor') span.style.backgroundColor = value;
                    span.style.fontFamily = fontFamily;
                    range.surroundContents(span);
                    // Restore selection
                    sel.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.selectNodeContents(span);
                    sel.addRange(newRange);
                    docCanvas.dispatchEvent(new Event('input'));
                } else {
                    document.execCommand(cmd, false, value);
                    docCanvas.dispatchEvent(new Event('input'));
                }
            } else {
                // No selection: insert a span at caret for future typing
                const range = sel.getRangeAt(0);
                const span = document.createElement('span');
                if (cmd === 'foreColor' || cmd === 'hiliteColor') {
                    if (cmd === 'foreColor') span.style.color = value;
                    if (cmd === 'hiliteColor') span.style.backgroundColor = value;
                }
                span.style.fontFamily = fontFamily;
                span.appendChild(document.createTextNode('\u200b')); // zero-width space
                range.insertNode(span);
                // Move caret inside the span
                sel.removeAllRanges();
                const newRange = document.createRange();
                newRange.setStart(span.firstChild, 1);
                newRange.collapse(true);
                sel.addRange(newRange);
                docCanvas.dispatchEvent(new Event('input'));
            }
        } else {
            // Instead of selecting all, just insert at caret or at the end
            docCanvas.focus();
            let sel2 = window.getSelection();
            let range2 = sel2 && sel2.rangeCount > 0 ? sel2.getRangeAt(0) : null;
            if (!range2) {
                range2 = document.createRange();
                range2.selectNodeContents(docCanvas);
                range2.collapse(false);
            }
            if (cmd === 'foreColor' || cmd === 'hiliteColor') {
                const span = document.createElement('span');
                if (cmd === 'foreColor') span.style.color = value;
                if (cmd === 'hiliteColor') span.style.backgroundColor = value;
                span.style.fontFamily = fontFamily;
                span.appendChild(document.createTextNode('\u200b'));
                range2.insertNode(span);
                sel2.removeAllRanges();
                const newRange = document.createRange();
                newRange.setStart(span.firstChild, 1);
                newRange.collapse(true);
                sel2.addRange(newRange);
                docCanvas.dispatchEvent(new Event('input'));
            } else {
                document.execCommand(cmd, false, value);
                docCanvas.dispatchEvent(new Event('input'));
            }
        }
    }

    // Helper to find a tag in the range
    function findTagInRange(node, ...tags) {
        if (!node) return null;
        if (node.nodeType === 1 && tags.includes(node.tagName)) return node;
        for (let tag of tags) {
            const el = node.querySelector && node.querySelector(tag) || null;
            if (el) return el;
        }
        return null;
    }

    // --- Bold ---
    document.getElementById('toolbar-bold').addEventListener('click', function () {
        execEditorCommand('bold');
    });
    document.querySelector('.dropdown-format .item#bold').addEventListener('click', function () {
        execEditorCommand('bold');
    });

    // --- Italic ---
    document.getElementById('toolbar-italic').addEventListener('click', function () {
        execEditorCommand('italic');
    });
    document.querySelector('.dropdown-format .item#italic').addEventListener('click', function () {
        execEditorCommand('italic');
    });

    // --- Underline ---
    document.getElementById('toolbar-underline').addEventListener('click', function () {
        execEditorCommand('underline');
    });
    document.querySelector('.dropdown-format .item#underline').addEventListener('click', function () {
        execEditorCommand('underline');
    });

    // --- Strikethrough ---
    document.getElementById('toolbar-strikethrough').addEventListener('click', function () {
        execEditorCommand('strikeThrough');
    });
    document.querySelector('.dropdown-format .item#strikethrough').addEventListener('click', function () {
        execEditorCommand('strikeThrough');
    });

    // --- Text Color ---
    function openTextColorModal() {
        let colorModal = document.getElementById('text-color-modal');
        if (!colorModal) {
            colorModal = document.createElement('div');
            colorModal.id = 'text-color-modal';
            colorModal.style.position = 'fixed';
            colorModal.style.top = '0';
            colorModal.style.left = '0';
            colorModal.style.width = '100vw';
            colorModal.style.height = '100vh';
            colorModal.style.background = 'rgba(0,0,0,0.15)';
            colorModal.style.display = 'flex';
            colorModal.style.alignItems = 'center';
            colorModal.style.justifyContent = 'center';
            colorModal.style.zIndex = '3000';

            const modalContent = document.createElement('div');
            modalContent.style.background = '#fff';
            modalContent.style.borderRadius = '18px';
    // Ensure docCanvas is defined before using it
    const docCanvas = document.getElementById('docCanvas');

    // --- MAKE QUOTES MOVEABLE AND COLOR-CHANGEABLE (moved here to fix errors) ---
    // Helper: Add move/color controls to all blockquotes in docCanvas
    function enhanceBlockquotes() {
        docCanvas.querySelectorAll('blockquote').forEach(bq => {
            // Prevent duplicate controls
            if (bq.querySelector('.bq-controls')) return;

            // Controls container
            const controls = document.createElement('span');
            controls.className = 'bq-controls';
            controls.style.display = 'inline-flex';
            controls.style.alignItems = 'center';
            controls.style.gap = '4px';
            controls.style.marginLeft = '8px';

            // Move icon
            const moveIcon = document.createElement('span');
            moveIcon.className = 'material-symbols-outlined';
            moveIcon.textContent = 'open_with';
            moveIcon.title = 'Move quote';
            moveIcon.style.cursor = 'grab';
            moveIcon.style.fontSize = '1.1em';
            moveIcon.style.color = '#a259e6';
            moveIcon.draggable = true;

            // Color icon
            const colorIcon = document.createElement('span');
            colorIcon.className = 'material-symbols-outlined';
            colorIcon.textContent = 'palette';
            colorIcon.title = 'Change quote color';
            colorIcon.style.cursor = 'pointer';
            colorIcon.style.fontSize = '1.1em';
            colorIcon.style.color = '#712cca';

            // Insert controls at end of blockquote
            controls.appendChild(moveIcon);
            controls.appendChild(colorIcon);
            bq.appendChild(controls);

            // --- Drag and drop logic ---
            moveIcon.addEventListener('dragstart', function (e) {
                window.__draggedBlockquote = bq;
                e.dataTransfer.effectAllowed = 'move';
                // For Firefox compatibility
                e.dataTransfer.setData('text/plain', 'blockquote');
            });

            // Allow dropping blockquotes anywhere in docCanvas
            docCanvas.addEventListener('dragover', function (e) {
                if (window.__draggedBlockquote) {
                    e.preventDefault();
                }
            });
            docCanvas.addEventListener('drop', function (e) {
                if (window.__draggedBlockquote) {
                    e.preventDefault();
                    let range;
                    if (document.caretRangeFromPoint) {
                        range = document.caretRangeFromPoint(e.clientX, e.clientY);
                    } else if (e.rangeParent) {
                        range = document.createRange();
                        range.setStart(e.rangeParent, e.rangeOffset);
                    }
                    if (range) {
                        window.__draggedBlockquote.remove();
                        range.insertNode(window.__draggedBlockquote);
                    }
                    window.__draggedBlockquote = null;
                    docCanvas.dispatchEvent(new Event('input'));
                    setTimeout(enhanceBlockquotes, 10);
                }
            });

            // --- Color picker logic ---
            colorIcon.addEventListener('click', function (e) {
                e.stopPropagation();
                // Remove any existing palette
                const oldPalette = document.getElementById('bq-color-palette');
                if (oldPalette) oldPalette.remove();

                // Palette popup
                const palette = document.createElement('div');
                palette.id = 'bq-color-palette';
                palette.style.position = 'absolute';
                palette.style.zIndex = '4000';
                palette.style.background = '#fff';
                palette.style.border = '1.5px solid #ece6f7';
                palette.style.borderRadius = '10px';
                palette.style.boxShadow = '0 2px 8px rgba(113,44,202,0.13)';
                palette.style.padding = '8px 10px';
                palette.style.display = 'flex';
                palette.style.gap = '8px';
                palette.style.top = (colorIcon.getBoundingClientRect().bottom + window.scrollY + 4) + 'px';
                palette.style.left = (colorIcon.getBoundingClientRect().left + window.scrollX - 10) + 'px';

                // Color options
                const colors = [
                    { border: '#a259e6', bg: '#f7f3ff' },
                    { border: '#712cca', bg: '#ece6f7' },
                    { border: '#ff9800', bg: '#fffbe6' },
                    { border: '#4caf50', bg: '#e8f5e9' },
                    { border: '#2196f3', bg: '#e3f2fd' },
                    { border: '#f44336', bg: '#ffebee' },
                    { border: '#333', bg: '#f0f0f0' }
                ];
                colors.forEach(c => {
                    const btn = document.createElement('button');
                    btn.style.width = '26px';
                    btn.style.height = '26px';
                    btn.style.borderRadius = '50%';
                    btn.style.border = `2.5px solid ${c.border}`;
                    btn.style.background = c.bg;
                    btn.style.cursor = 'pointer';
                    btn.style.outline = 'none';
                    btn.addEventListener('click', function () {
                        bq.style.borderLeft = `4px solid ${c.border}`;
                        bq.style.background = c.bg;
                        palette.remove();
                        docCanvas.dispatchEvent(new Event('input'));
                    });
                    palette.appendChild(btn);
                });

                // Custom color input
                const custom = document.createElement('input');
                custom.type = 'color';
                custom.title = 'Custom color';
                custom.style.width = '26px';
                custom.style.height = '26px';
                custom.style.border = 'none';
                custom.style.borderRadius = '50%';
                custom.style.cursor = 'pointer';
                custom.style.background = 'none';
                custom.addEventListener('input', function () {
                    bq.style.borderLeft = `4px solid ${custom.value}`;
                    bq.style.background = '#fff';
                    palette.remove();
                    docCanvas.dispatchEvent(new Event('input'));
                });
                palette.appendChild(custom);

                document.body.appendChild(palette);

                // Remove palette on outside click
                setTimeout(() => {
                    document.addEventListener('mousedown', function handler(ev) {
                        if (!palette.contains(ev.target)) {
                            palette.remove();
                            document.removeEventListener('mousedown', handler);
                        }
                    });
                }, 10);
            });
        });
    }

    // Enhance blockquotes on input/change
    docCanvas.addEventListener('input', () => setTimeout(enhanceBlockquotes, 10));
    docCanvas.addEventListener('DOMSubtreeModified', () => setTimeout(enhanceBlockquotes, 10));

    // Enhance on page load and after showing editor
    document.addEventListener('DOMContentLoaded', () => setTimeout(enhanceBlockquotes, 10));
    const origShowEditorQuotes = window.showEditor;
    window.showEditor = function(idx) {
        origShowEditorQuotes(idx);
        setTimeout(enhanceBlockquotes, 10);
    };
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
            modalContent.style.alignItems = 'center';
            modalContent.style.position = 'relative';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'material-symbols-outlined';
            closeBtn.textContent = 'close';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '12px';
            closeBtn.style.right = '16px';
            closeBtn.style.fontSize = '2em';
            closeBtn.style.color = '#a259e6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.addEventListener('click', () => colorModal.style.display = 'none');

            const label = document.createElement('label');
            label.textContent = 'Pick text color:';
            label.style.marginBottom = '18px';
            label.style.fontWeight = '600';
            label.style.color = '#712cca';

            const input = document.createElement('input');
            input.type = 'color';
            input.value = '#333333';
            input.style.width = '60px';
            input.style.height = '60px';
            input.style.border = 'none';
            input.style.borderRadius = '50%';
            input.style.marginBottom = '18px';
            input.style.cursor = 'pointer';
            input.style.boxShadow = '0 2px 8px rgba(113,44,202,0.13)';

            const applyBtn = document.createElement('button');
            applyBtn.textContent = 'Apply';
            applyBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
            applyBtn.style.color = '#fff';
            applyBtn.style.border = 'none';
            applyBtn.style.borderRadius = '18px';
            applyBtn.style.padding = '8px 24px';
            applyBtn.style.cursor = 'pointer';
            applyBtn.style.fontWeight = '600';
            applyBtn.style.fontSize = '1em';

            applyBtn.addEventListener('click', function () {
                docCanvas.focus();
                const sel = window.getSelection();
                const fontFamily = getCurrentFontFamily();
                if (
                    sel &&
                    sel.rangeCount > 0 &&
                    docCanvas.contains(sel.getRangeAt(0).commonAncestorContainer)
                ) {
                    if (!sel.isCollapsed) {
                        const range = sel.getRangeAt(0).cloneRange();
                        // Wrap selection in a span with color style and font family
                        const span = document.createElement('span');
                        span.style.color = input.value;
                        span.style.fontFamily = fontFamily;
                        range.surroundContents(span);
                        // Restore selection
                        sel.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        sel.addRange(newRange);
                        docCanvas.dispatchEvent(new Event('input'));
                        colorModal.style.display = 'none';
                    } else {
                        // No selection: insert a span at caret for future typing
                        const range = sel.getRangeAt(0);
                        const span = document.createElement('span');
                        span.style.color = input.value;
                        span.style.fontFamily = fontFamily;
                        span.appendChild(document.createTextNode('\u200b')); // zero-width space
                        range.insertNode(span);
                        // Move caret inside the span
                        sel.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.setStart(span.firstChild, 1);
                        newRange.collapse(true);
                        sel.addRange(newRange);
                        docCanvas.dispatchEvent(new Event('input'));
                        colorModal.style.display = 'none';
                    }
                } else {
                    // No selection at all: insert a span at caret for future typing
                    let sel2 = window.getSelection();
                    let range2 = sel2 && sel2.rangeCount > 0 ? sel2.getRangeAt(0) : null;
                    if (!range2) {
                        range2 = document.createRange();
                        range2.selectNodeContents(docCanvas);
                        range2.collapse(false);
                    }
                    const span = document.createElement('span');
                    span.style.color = input.value;
                    span.style.fontFamily = fontFamily;
                    span.appendChild(document.createTextNode('\u200b'));
                    range2.insertNode(span);
                    sel2.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.setStart(span.firstChild, 1);
                    newRange.collapse(true);
                    sel2.addRange(newRange);
                    docCanvas.dispatchEvent(new Event('input'));
                    colorModal.style.display = 'none';
                }
            });

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(label);
            modalContent.appendChild(input);
            modalContent.appendChild(applyBtn);
            colorModal.appendChild(modalContent);
            document.body.appendChild(colorModal);
        }
        colorModal.style.display = 'flex';
    }
    document.getElementById('toolbar-text-color').addEventListener('click', openTextColorModal);
    document.querySelector('.dropdown-format .item#text-color').addEventListener('click', openTextColorModal);

    // --- Align Left ---
    document.getElementById('toolbar-align-left').addEventListener('click', function () {
        execEditorCommand('justifyLeft');
    });
    document.querySelector('.dropdown-format .item#align-left').addEventListener('click', function () {
        execEditorCommand('justifyLeft');
    });

    // --- Align Center ---
    document.getElementById('toolbar-align-center').addEventListener('click', function () {
        execEditorCommand('justifyCenter');
    });
    document.querySelector('.dropdown-format .item#align-center').addEventListener('click', function () {
        execEditorCommand('justifyCenter');
    });

    // --- Align Right ---
    document.getElementById('toolbar-align-right').addEventListener('click', function () {
        execEditorCommand('justifyRight');
    });
    document.querySelector('.dropdown-format .item#align-right').addEventListener('click', function () {
        execEditorCommand('justifyRight');
    });

    // --- Quote ---
    document.getElementById('quote').addEventListener('click', function () {
        docCanvas.focus();
        const sel = window.getSelection();
        const fontFamily = getCurrentFontFamily();
        if (sel && sel.rangeCount > 0 && (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)) {
            const range = sel.getRangeAt(0);
            // If selection, wrap in blockquote; else insert empty blockquote
            let blockquote = document.createElement('blockquote');
            blockquote.style.borderLeft = '4px solid #a259e6';
            blockquote.style.margin = '8px 0';
            blockquote.style.padding = '8px 16px';
            blockquote.style.background = '#f7f3ff';
            blockquote.style.fontFamily = fontFamily;
            if (!range.collapsed) {
                blockquote.appendChild(range.extractContents());
                range.insertNode(blockquote);
                // Restore selection
                sel.removeAllRanges();
                const newRange = document.createRange();
                newRange.selectNodeContents(blockquote);
                sel.addRange(newRange);
            } else {
                blockquote.innerHTML = 'Quote';
                range.insertNode(blockquote);
            }
        }
    });

    // --- Horizontal Line ---
    document.getElementById('divider').addEventListener('click', function () {
        docCanvas.focus();
        const sel = window.getSelection();
        if (
            sel &&
            sel.rangeCount > 0 &&
            (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)
        ) {
            const range = sel.getRangeAt(0);
            // Create a styled, draggable HR that spans the full width
            const hr = document.createElement('hr');
            hr.setAttribute('draggable', 'true');
            hr.style.width = '100%';
            hr.style.border = 'none';
            hr.style.borderTop = '2px solid #a259e6';
            hr.style.margin = '18px 0';
            hr.style.cursor = 'move';
            hr.addEventListener('dragstart', function (e) {
                e.dataTransfer.setData('text/plain', 'hr');
                window.__draggedHR = hr;
            });
            range.insertNode(hr);
            // Move caret after the HR
            sel.removeAllRanges();
            const after = document.createRange();
            after.setStartAfter(hr);
            after.collapse(true);
            sel.addRange(after);
            docCanvas.dispatchEvent(new Event('input'));
        }
    });

    // Allow dropping/moving <hr> inside docCanvas
    docCanvas.addEventListener('dragover', function (e) {
        if (window.__draggedHR) {
            e.preventDefault();
        }
    });
    docCanvas.addEventListener('drop', function (e) {
        if (window.__draggedHR) {
            e.preventDefault();
            let range;
            if (document.caretRangeFromPoint) {
                range = document.caretRangeFromPoint(e.clientX, e.clientY);
            } else if (e.rangeParent) {
                range = document.createRange();
                range.setStart(e.rangeParent, e.rangeOffset);
            }
            if (range) {
                window.__draggedHR.remove();
                range.insertNode(window.__draggedHR);
            }
            window.__draggedHR = null;
        }
    });

    // --- Link (with modal, no prompt) ---
    document.getElementById('link').addEventListener('click', function () {
        docCanvas.focus();
        let linkModal = document.getElementById('link-modal');
        if (!linkModal) {
            linkModal = document.createElement('div');
            linkModal.id = 'link-modal';
            linkModal.style.position = 'fixed';
            linkModal.style.top = '0';
            linkModal.style.left = '0';
            linkModal.style.width = '100vw';
            linkModal.style.height = '100vh';
            linkModal.style.background = 'rgba(0,0,0,0.15)';
            linkModal.style.display = 'flex';
            linkModal.style.alignItems = 'center';
            linkModal.style.justifyContent = 'center';
            linkModal.style.zIndex = '3000';

            const modalContent = document.createElement('div');
            modalContent.style.background = '#fff';
            modalContent.style.borderRadius = '18px';
            modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
            modalContent.style.padding = '28px 24px 20px 24px';
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
            modalContent.style.alignItems = 'center';
            modalContent.style.position = 'relative';
            modalContent.style.minWidth = '320px';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'material-symbols-outlined';
            closeBtn.textContent = 'close';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '12px';
            closeBtn.style.right = '16px';
            closeBtn.style.fontSize = '2em';
            closeBtn.style.color = '#a259e6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.addEventListener('click', () => linkModal.style.display = 'none');

            const label = document.createElement('label');
            label.textContent = 'Insert Link';
            label.style.marginBottom = '18px';
            label.style.fontWeight = '600';
            label.style.color = '#712cca';
            label.style.fontSize = '1.1em';

            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.placeholder = 'Text to display';
            textInput.style.marginBottom = '12px';
            textInput.style.padding = '10px 14px';
            textInput.style.borderRadius = '8px';
            textInput.style.border = '1.5px solid #ece6f7';
            textInput.style.fontSize = '1em';
            textInput.style.width = '220px';

            const urlInput = document.createElement('input');
            urlInput.type = 'url';
            urlInput.placeholder = 'https://example.com';
            urlInput.style.marginBottom = '18px';
            urlInput.style.padding = '10px 14px';
            urlInput.style.borderRadius = '8px';
            urlInput.style.border = '1.5px solid #ece6f7';
            urlInput.style.fontSize = '1em';
            urlInput.style.width = '220px';

            const applyBtn = document.createElement('button');
            applyBtn.textContent = 'Insert Link';
            applyBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
            applyBtn.style.color = '#fff';
            applyBtn.style.border = 'none';
            applyBtn.style.borderRadius = '18px';
            applyBtn.style.padding = '8px 24px';
            applyBtn.style.cursor = 'pointer';
            applyBtn.style.fontWeight = '600';
            applyBtn.style.fontSize = '1em';

            applyBtn.addEventListener('click', function () {
                const url = urlInput.value.trim();
                const text = textInput.value.trim();
                if (!url || !/^https?:\/\//i.test(url)) {
                    showToast('Please enter a valid URL (must start with http:// or https://)');
                    return;
                }
                docCanvas.focus();
                const sel = window.getSelection();
                if (sel && sel.rangeCount > 0 && (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)) {
                    const range = sel.getRangeAt(0);
                    if (!range.collapsed) {
                        // If text is selected, use it as link text
                        execEditorCommand('createLink', url);
                    } else if (text) {
                        // No selection, insert link with provided text
                        const a = document.createElement('a');
                        a.href = url;
                        a.textContent = text;
                        a.target = '_blank';
                        range.insertNode(a);
                        // Move caret after link
                        sel.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.setStartAfter(a);
                        newRange.collapse(true);
                        sel.addRange(newRange);
                        docCanvas.dispatchEvent(new Event('input'));
                    } else {
                        showToast('Enter link text or select text in document.');
                        return;
                    }
                }
                linkModal.style.display = 'none';
            });

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(label);
            modalContent.appendChild(textInput);
            modalContent.appendChild(urlInput);
            modalContent.appendChild(applyBtn);
            linkModal.appendChild(modalContent);
            document.body.appendChild(linkModal);
        }

        // Pre-fill text input with selected text if any
        const sel = window.getSelection();
        let selectedText = '';
        if (sel && sel.rangeCount > 0 && (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)) {
            selectedText = sel.toString();
        }
        const textInput = linkModal.querySelector('input[type="text"]');
        if (textInput) textInput.value = selectedText;

        const urlInput = linkModal.querySelector('input[type="url"]');
        if (urlInput) urlInput.value = '';

        linkModal.style.display = 'flex';
        // Focus URL input if no selection, else focus text input
        setTimeout(() => {
            if (selectedText) {
                urlInput && urlInput.focus();
            } else {
                textInput && textInput.focus();
            }
        }, 50);
    });
    // --- Bulleted List & Numbered List ---
    document.getElementById('bulleted-list').addEventListener('click', function () {
        docCanvas.focus();
        document.execCommand('insertUnorderedList');
        docCanvas.dispatchEvent(new Event('input'));
    });
    document.getElementById('numbered-list').addEventListener('click', function () {
        docCanvas.focus();
        document.execCommand('insertOrderedList');
        docCanvas.dispatchEvent(new Event('input'));
    });

    // --- Checklist (simulate with custom checkbox list) ---
    document.getElementById('checklist').addEventListener('click', function () {
        docCanvas.focus();
        const sel = window.getSelection();
        if (sel && sel.rangeCount > 0 && (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)) {
            const range = sel.getRangeAt(0);
            // If selection, wrap each line in a checklist item
            let text = sel.toString();
            if (text.trim()) {
                let lines = text.split('\n');
                let ul = document.createElement('ul');
                ul.style.listStyle = 'none';
                ul.style.paddingLeft = '0';
                lines.forEach(line => {
                    let li = document.createElement('li');
                    li.style.display = 'flex';
                    li.style.alignItems = 'center';
                    let checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.style.marginRight = '8px';
                    li.appendChild(checkbox);
                    li.appendChild(document.createTextNode(line));
                    ul.appendChild(li);
                });
                range.deleteContents();
                range.insertNode(ul);
                sel.removeAllRanges();
                let newRange = document.createRange();
                newRange.selectNodeContents(ul);
                sel.addRange(newRange);
            } else {
                // Insert a single checklist item
                let ul = document.createElement('ul');
                ul.style.listStyle = 'none';
                ul.style.paddingLeft = '0';
                let li = document.createElement('li');
                li.style.display = 'flex';
                li.style.alignItems = 'center';
                let checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.style.marginRight = '8px';
                li.appendChild(checkbox);
                li.appendChild(document.createTextNode('Checklist item'));
                ul.appendChild(li);
                range.insertNode(ul);
                sel.removeAllRanges();
                let newRange = document.createRange();
                newRange.selectNodeContents(ul);
                sel.addRange(newRange);
            }
            docCanvas.dispatchEvent(new Event('input'));
        }
    });
    /* --- PATCH: Make "Find in document" in View dropdown work --- */
    document.querySelector('.dropdown-view .item#find-document').addEventListener('click', function () {
        // Close the dropdown
        document.querySelector('.dropdown-view').style.display = 'none';
        // Show the editor search box
        if (typeof showEditorSearchBox === 'function') showEditorSearchBox();
    });

    /* --- PATCH: Make "Version history" in File dropdown work --- */
    document.querySelector('.dropdown-file .item#history').addEventListener('click', function () {
        // Close the dropdown
        document.querySelector('.dropdown-file').style.display = 'none';
        // Show the version history modal
        if (typeof historyBtn !== 'undefined' && historyBtn) historyBtn.click();
    });
    /* --- THEME COLOR PICKER FUNCTIONALITY --- */
    const bgColorBtn = document.getElementById('bg-color-btn');
    let colorPickerModal = null;

    bgColorBtn.addEventListener('click', function () {
        if (!colorPickerModal) {
            colorPickerModal = document.createElement('div');
            colorPickerModal.style.position = 'fixed';
            colorPickerModal.style.top = '0';
            colorPickerModal.style.left = '0';
            colorPickerModal.style.width = '100vw';
            colorPickerModal.style.height = '100vh';
            colorPickerModal.style.background = 'rgba(0,0,0,0.25)';
            colorPickerModal.style.display = 'flex';
            colorPickerModal.style.alignItems = 'center';
            colorPickerModal.style.justifyContent = 'center';
            colorPickerModal.style.zIndex = '2000';

            const modalContent = document.createElement('div');
            modalContent.style.background = '#fff';
            modalContent.style.borderRadius = '18px';
            modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
            modalContent.style.padding = '32px 28px 24px 28px';
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
            modalContent.style.alignItems = 'center';
            modalContent.style.position = 'relative';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'material-symbols-outlined';
            closeBtn.textContent = 'close';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '16px';
            closeBtn.style.right = '20px';
            closeBtn.style.fontSize = '2em';
            closeBtn.style.color = '#a259e6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.addEventListener('click', () => colorPickerModal.style.display = 'none');

            const label = document.createElement('label');
            label.textContent = 'Pick background color:';
            label.style.marginBottom = '18px';
            label.style.fontWeight = '600';
            label.style.color = '#712cca';

            const input = document.createElement('input');
            input.type = 'color';
            input.value = rgbToHex(window.getComputedStyle(editorCanvas).backgroundColor || '#ffffff');
            input.style.width = '60px';
            input.style.height = '60px';
            input.style.border = 'none';
            input.style.borderRadius = '50%';
            input.style.marginBottom = '18px';
            input.style.cursor = 'pointer';
            input.style.boxShadow = '0 2px 8px rgba(113,44,202,0.13)';

            input.addEventListener('input', function () {
                editorCanvas.style.background = input.value;
                // Save to doc
                const idx = getCurrentDocIndex();
                if (idx !== null) {
                    const docs = getDocs();
                    docs[idx].bgColor = input.value;
                    setDocs(docs);
                }
            });

            // Restore color from doc
            const idx = getCurrentDocIndex();
            if (idx !== null) {
                const docs = getDocs();
                if (docs[idx] && docs[idx].bgColor) {
                    input.value = docs[idx].bgColor;
                    editorCanvas.style.background = docs[idx].bgColor;
                }
            }

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(label);
            modalContent.appendChild(input);
            colorPickerModal.appendChild(modalContent);
            document.body.appendChild(colorPickerModal);
        }
        colorPickerModal.style.display = 'flex';
    });

    // Helper: RGB to HEX
    function rgbToHex(rgb) {
        if (!rgb) return '#ffffff';
        const result = rgb.match(/\d+/g);
        if (!result) return '#ffffff';
        return (
            '#' +
            result
                .slice(0, 3)
                .map(x => ('0' + parseInt(x).toString(16)).slice(-2))
                .join('')
        );
    }

    // Restore bg color on editor load
    function restoreBgColor() {
        const idx = getCurrentDocIndex();
        if (idx !== null) {
            const docs = getDocs();
            if (docs[idx] && docs[idx].bgColor) {
                editorCanvas.style.background = docs[idx].bgColor;
            } else {
                editorCanvas.style.background = '#fff';
            }
        }
    }
    const origShowEditorBg = window.showEditor;
    window.showEditor = function(idx) {
        origShowEditorBg(idx);
        restoreBgColor();
    };
    document.addEventListener('DOMContentLoaded', function() {
        if (!document.querySelector('.editor').hidden) {
            restoreBgColor();
        }
    });

    /* --- VERSION HISTORY FUNCTIONALITY --- */
    const historyBtn = document.getElementById('history-btn');
    let versionHistoryModal = null;
    let versionHistory = [];
    let versionTimer = null;

    // Save version every 1s if changed
    function startVersionTracking() {
        if (versionTimer) clearInterval(versionTimer);
        let lastContent = docCanvas.innerHTML;
        versionTimer = setInterval(() => {
            const idx = getCurrentDocIndex();
            if (idx === null) return;
            const docs = getDocs();
            if (!docs[idx]) return;
            const nowContent = docCanvas.innerHTML;
            if (nowContent !== lastContent) {
                // Save new version
                const now = new Date();
                const entry = {
                    time: now.toISOString(),
                    content: nowContent
                };
                // Load history from doc
                docs[idx].history = docs[idx].history || [];
                docs[idx].history.push(entry);
                // Limit to last 50 versions
                if (docs[idx].history.length > 50) docs[idx].history = docs[idx].history.slice(-50);
                setDocs(docs);
                lastContent = nowContent;
            }
        }, 1000);
    }

    // Load version history for current doc
    function loadVersionHistory() {
        const idx = getCurrentDocIndex();
        if (idx === null) return [];
        const docs = getDocs();
        return (docs[idx] && docs[idx].history) ? docs[idx].history : [];
    }

    // Show version history modal
    historyBtn.addEventListener('click', function () {
        if (!versionHistoryModal) {
            versionHistoryModal = document.createElement('div');
            versionHistoryModal.style.position = 'fixed';
            versionHistoryModal.style.top = '0';
            versionHistoryModal.style.left = '0';
            versionHistoryModal.style.width = '100vw';
            versionHistoryModal.style.height = '100vh';
            versionHistoryModal.style.background = 'rgba(0,0,0,0.25)';
            versionHistoryModal.style.display = 'flex';
            versionHistoryModal.style.alignItems = 'center';
            versionHistoryModal.style.justifyContent = 'center';
            versionHistoryModal.style.zIndex = '2000';

            const modalContent = document.createElement('div');
            modalContent.style.background = '#fff';
            modalContent.style.borderRadius = '18px';
            modalContent.style.boxShadow = '0 8px 32px rgba(113,44,202,0.18)';
            modalContent.style.padding = '32px 28px 24px 28px';
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
            modalContent.style.alignItems = 'stretch';
            modalContent.style.position = 'relative';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflowY = 'auto';
            modalContent.style.minWidth = '340px';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'material-symbols-outlined';
            closeBtn.textContent = 'close';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '16px';
            closeBtn.style.right = '20px';
            closeBtn.style.fontSize = '2em';
            closeBtn.style.color = '#a259e6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.addEventListener('click', () => versionHistoryModal.style.display = 'none');

            const title = document.createElement('h2');
            title.textContent = 'Version History';
            title.style.textAlign = 'center';
            title.style.color = '#712cca';
            title.style.marginBottom = '18px';

            const historyList = document.createElement('div');
            historyList.style.display = 'flex';
            historyList.style.flexDirection = 'column';
            historyList.style.gap = '10px';

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(title);
            modalContent.appendChild(historyList);
            versionHistoryModal.appendChild(modalContent);
            document.body.appendChild(versionHistoryModal);
        }

        // Populate history
        const historyList = versionHistoryModal.querySelector('div:nth-child(3)');
        historyList.innerHTML = '';
        const history = loadVersionHistory();
        if (!history.length) {
            historyList.innerHTML = '<p style="text-align:center; color:#888;">No history yet.</p>';
        } else {
            history.slice().reverse().forEach((entry, idx) => {
                const item = document.createElement('div');
                item.style.background = '#f7f3ff';
                item.style.borderRadius = '10px';
                item.style.padding = '12px 14px';
                item.style.boxShadow = '0 1px 4px rgba(113,44,202,0.07)';
                item.style.display = 'flex';
                item.style.flexDirection = 'column';
                item.style.gap = '6px';

                const time = document.createElement('div');
                time.textContent = new Date(entry.time).toLocaleString();
                time.style.fontSize = '0.95em';
                time.style.color = '#712cca';
                time.style.fontWeight = '600';

                const expandBtn = document.createElement('button');
                expandBtn.textContent = 'Show';
                expandBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
                expandBtn.style.color = '#fff';
                expandBtn.style.border = 'none';
                expandBtn.style.borderRadius = '18px';
                expandBtn.style.padding = '6px 18px';
                expandBtn.style.cursor = 'pointer';
                expandBtn.style.fontWeight = '600';
                expandBtn.style.fontSize = '1em';
                expandBtn.style.alignSelf = 'flex-start';

                const contentDiv = document.createElement('div');
                contentDiv.style.display = 'none';
                contentDiv.style.background = '#fff';
                contentDiv.style.border = '1px solid #ece6f7';
                contentDiv.style.borderRadius = '8px';
                contentDiv.style.padding = '10px';
                contentDiv.style.marginTop = '6px';
                contentDiv.style.fontSize = '0.98em';
                contentDiv.style.maxHeight = '200px';
                contentDiv.style.overflowY = 'auto';
                contentDiv.innerHTML = entry.content;

                expandBtn.addEventListener('click', function () {
                    if (contentDiv.style.display === 'none') {
                        contentDiv.style.display = 'block';
                        expandBtn.textContent = 'Hide';
                    } else {
                        contentDiv.style.display = 'none';
                        expandBtn.textContent = 'Show';
                    }
                });

                const restoreBtn = document.createElement('button');
                restoreBtn.textContent = 'Restore';
                restoreBtn.style.background = 'linear-gradient(90deg, #a259e6 0%, #712cca 100%)';
                restoreBtn.style.color = '#fff';
                restoreBtn.style.border = 'none';
                restoreBtn.style.borderRadius = '18px';
                restoreBtn.style.padding = '6px 18px';
                restoreBtn.style.cursor = 'pointer';
                restoreBtn.style.fontWeight = '600';
                restoreBtn.style.fontSize = '1em';
                restoreBtn.style.alignSelf = 'flex-start';
                restoreBtn.style.marginLeft = '10px';

                // Custom restore confirmation UI (no confirm())
                restoreBtn.addEventListener('click', function () {
                    // Show a custom confirmation inline
                    let confirmDiv = item.querySelector('.restore-confirm');
                    if (!confirmDiv) {
                        confirmDiv = document.createElement('div');
                        confirmDiv.className = 'restore-confirm';
                        confirmDiv.style.marginTop = '8px';
                        confirmDiv.style.display = 'flex';
                        confirmDiv.style.alignItems = 'center';
                        confirmDiv.style.gap = '10px';
                        confirmDiv.style.background = '#fffbe6';
                        confirmDiv.style.border = '1px solid #ffe066';
                        confirmDiv.style.borderRadius = '8px';
                        confirmDiv.style.padding = '8px 12px';
                        confirmDiv.style.fontSize = '0.98em';
                        confirmDiv.innerHTML = `<span style="color:#712cca;">Restore this version?</span>`;
                        const yesBtn = document.createElement('button');
                        yesBtn.textContent = 'Yes';
                        yesBtn.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
                        yesBtn.style.color = '#fff';
                        yesBtn.style.border = 'none';
                        yesBtn.style.borderRadius = '12px';
                        yesBtn.style.padding = '4px 16px';
                        yesBtn.style.cursor = 'pointer';
                        yesBtn.style.fontWeight = '600';
                        yesBtn.style.fontSize = '1em';

                        const noBtn = document.createElement('button');
                        noBtn.textContent = 'No';
                        noBtn.style.background = '#ece6f7';
                        noBtn.style.color = '#712cca';
                        noBtn.style.border = 'none';
                        noBtn.style.borderRadius = '12px';
                        noBtn.style.padding = '4px 16px';
                        noBtn.style.cursor = 'pointer';
                        noBtn.style.fontWeight = '600';
                        noBtn.style.fontSize = '1em';

                        yesBtn.addEventListener('click', function () {
                            docCanvas.innerHTML = entry.content;
                            // Save to doc and update history
                            const idx = getCurrentDocIndex();
                            if (idx !== null) {
                                const docs = getDocs();
                                docs[idx].content = entry.content;
                                setDocs(docs);
                                showToast('Version restored!');
                            }
                            versionHistoryModal.style.display = 'none';
                        });
                        noBtn.addEventListener('click', function () {
                            confirmDiv.remove();
                        });
                        confirmDiv.appendChild(yesBtn);
                        confirmDiv.appendChild(noBtn);
                        item.appendChild(confirmDiv);
                    }
                });

                const btnRow = document.createElement('div');
                btnRow.style.display = 'flex';
                btnRow.style.gap = '8px';
                btnRow.appendChild(expandBtn);
                btnRow.appendChild(restoreBtn);

                item.appendChild(time);
                item.appendChild(btnRow);
                item.appendChild(contentDiv);

                historyList.appendChild(item);
            });
        }
        versionHistoryModal.style.display = 'flex';
    });

    // Start version tracking when editor is shown
    const origShowEditorHistory = window.showEditor;
    window.showEditor = function(idx) {
        origShowEditorHistory(idx);
        startVersionTracking();
    };
    // Also start on page load if editor is visible
    document.addEventListener('DOMContentLoaded', function() {
        if (!document.querySelector('.editor').hidden) {
            startVersionTracking();
        }
    });
    /* --- Clipboard and Selection Functionality for Edit Dropdown --- */

    // Ensure docCanvas is defined before using it

    // Helper: Get selection inside docCanvas
    function getDocSelection() {
        const sel = window.getSelection();
        if (
            sel &&
            sel.rangeCount > 0 &&
            (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)
        ) {
            return sel;
        }
        return null;
    }

    // Copy
    document.querySelector('.dropdown-edit .item#copy').addEventListener('click', async function () {
        const sel = getDocSelection();
        if (sel && !sel.isCollapsed) {
            try {
                const selectedText = sel.toString();
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(selectedText);
                } else {
                    docCanvas.focus();
                    document.execCommand('copy');
                }
                showToast('Copied!');
            } catch (e) {
                showToast('Copy failed.');
            }
        } else {
            showToast('Select some text to copy.');
        }
    });

    // Select All
    document.querySelector('.dropdown-edit .item#select-all').addEventListener('click', function () {
        docCanvas.focus();
        const range = document.createRange();
        range.selectNodeContents(docCanvas);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    });

    // Cut
    document.querySelector('.dropdown-edit .item#cut').addEventListener('click', async function () {
        // Always get the latest selection
        docCanvas.focus();
        const sel = window.getSelection();
        if (
            sel &&
            sel.rangeCount > 0 &&
            (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode) &&
            !sel.isCollapsed
        ) {
            try {
            // Try to copy HTML if possible, fallback to plain text
            let success = false;
            if (navigator.clipboard && window.isSecureContext) {
                // Try to copy HTML first
                const range = sel.getRangeAt(0);
                const fragment = range.cloneContents();
                const div = document.createElement('div');
                div.appendChild(fragment);
                const html = div.innerHTML;
                const text = sel.toString();
                await navigator.clipboard.write([
                new ClipboardItem({
                    "text/html": new Blob([html], { type: "text/html" }),
                    "text/plain": new Blob([text], { type: "text/plain" })
                })
                ]);
                success = true;
            } else {
                // Fallback to execCommand
                success = document.execCommand('cut');
            }
            // Remove the selected content from docCanvas
            if (!success) {
                // If Clipboard API did not cut, manually delete
                const range = sel.getRangeAt(0);
                range.deleteContents();
            }
            sel.removeAllRanges();
            showToast('Cut!');
            // Save after cut
            docCanvas.dispatchEvent(new Event('input'));
            } catch (e) {
            // Fallback to execCommand
            const success = document.execCommand('cut');
            if (success) {
                showToast('Cut!');
                docCanvas.dispatchEvent(new Event('input'));
            } else {
                showToast('Cut failed.');
            }
            }
        } else {
            showToast('Select some text to cut.');
        }
        });

        // Paste
        document.querySelector('.dropdown-edit .item#paste').addEventListener('click', async function () {
        docCanvas.focus();
        try {
            if (navigator.clipboard && window.isSecureContext) {
            const text = await navigator.clipboard.readText();
            document.execCommand('insertText', false, text);
            } else {
            document.execCommand('paste');
            }
            showToast('Pasted!');
        } catch (e) {
            showToast('Paste failed or not supported by browser.');
        }
        });

    // Load document content into the canvas when editor is shown
            function loadDocContent(idx) {
                const docs = JSON.parse(localStorage.getItem('docs') || '[]');
                const docCanvas = document.getElementById('docCanvas');
                if (idx !== null && idx >= 0 && idx < docs.length) {
                    docCanvas.innerHTML = docs[idx].content || '';
                } else {
                    docCanvas.innerHTML = '';
                }
            }
            // Save content on input
            document.getElementById('docCanvas').addEventListener('input', function () {
                const idx = sessionStorage.getItem('currentDocIndex');
                if (idx !== null) {
                    const docs = JSON.parse(localStorage.getItem('docs') || '[]');
                    docs[idx].content = this.innerHTML;
                    localStorage.setItem('docs', JSON.stringify(docs));
                }
            });
            // Patch showEditor to load content
            const origShowEditor2 = window.showEditor;
            window.showEditor = function(idx) {
                origShowEditor2(idx);
                loadDocContent(idx);
            };
            // On page load, if editor is visible, load content
            document.addEventListener('DOMContentLoaded', function() {
                if (!document.querySelector('.editor').hidden) {
                    loadDocContent(sessionStorage.getItem('currentDocIndex'));
                }
            });
        // Functional more icon
        const moreBtn = document.getElementById('moreBtn');
        if (moreBtn) {
            const moreDropdown = moreBtn.querySelector('.more-options');
            moreBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                // Toggle display manually for this dropdown (since it's not in tab-btn-bar)
                const isOpen = moreDropdown.style.display === 'flex';
                document.querySelectorAll('.more-options').forEach(dd => dd.style.display = 'none');
                if (!isOpen) {
                    moreDropdown.style.display = 'flex';
                }
            });
            // Prevent closing when clicking inside the dropdown
            moreDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            // Hide on outside click
            document.addEventListener('click', function (e) {
                if (!moreBtn.contains(e.target)) {
                    moreDropdown.style.display = 'none';
                }
            });
            // Hide on ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') moreDropdown.style.display = 'none';
            });
        }

        // Ensure text wraps in the canvas
        docCanvas.style.whiteSpace = 'pre-wrap';
        docCanvas.style.wordBreak = 'break-word';

        // Make sure only the canvas can overflow horizontally
        // Remove overflow from .editor, set only on .editor-canvas
        document.querySelector('.editor').style.overflowX = '';
        document.querySelector('.editor').style.overflowY = '';
        document.querySelector('.editor-canvas').style.overflowX = 'auto';
        document.querySelector('.editor-canvas').style.overflowY = 'auto';

        // Make the canvas document look like a portrait paper
        const editorCanvas = document.querySelector('.editor-canvas');
        editorCanvas.style.maxWidth = '794px'; // A4 width at 96dpi
        editorCanvas.style.margin = '32px auto';
        editorCanvas.style.background = '#fff';
        editorCanvas.style.borderRadius = '12px';
        editorCanvas.style.boxShadow = '0 4px 24px rgba(113,44,202,0.10)';
        editorCanvas.style.minHeight = '1123px'; // A4 height at 96dpi
        editorCanvas.style.aspectRatio = '210/297'; // A4 aspect ratio
        editorCanvas.style.display = 'flex';
        editorCanvas.style.flexDirection = 'column';
        editorCanvas.style.justifyContent = 'flex-start';

        // --- FONT SIZE FUNCTIONALITY ---
        const fontSizeInput = document.getElementById('fontSizeInput');
        const addFontSizeBtn = document.getElementById('addFontSize');
        const removeFontSizeBtn = document.getElementById('removeFontSize');

        // --- FONT SELECTOR FUNCTIONALITY ---
        const fontSelect = document.getElementById('fontSelect');
        function setFontFamily(family) {
            // Change the whole document's font in the editor
            docCanvas.style.fontFamily = family;
            // Also update all child elements to inherit the new font
            docCanvas.querySelectorAll('*').forEach(el => {
                el.style.fontFamily = 'inherit';
            });
            // Save font family to the current doc
            const idx = getCurrentDocIndex();
            if (idx !== null) {
                const docs = getDocs();
                docs[idx].fontFamily = family;
                setDocs(docs);
            }
        }
        fontSelect.addEventListener('change', function () {
            setFontFamily(this.value);
        });

        // On editor load, restore font family from doc
        function restoreFontFamily() {
            const idx = getCurrentDocIndex();
            if (idx !== null) {
                const docs = getDocs();
                const doc = docs[idx];
                if (doc && doc.fontFamily) {
                    fontSelect.value = doc.fontFamily;
                    setFontFamily(doc.fontFamily);
                } else {
                    fontSelect.value = "Segoe UI";
                    setFontFamily("Segoe UI");
                }
            }
        }
        // Patch showEditor to restore font family
        const origShowEditorFont = window.showEditor;
        window.showEditor = function(idx) {
            origShowEditorFont(idx);
            restoreFontFamily();
        };
        // Also restore on page load if editor is visible
        document.addEventListener('DOMContentLoaded', function() {
            if (!document.querySelector('.editor').hidden) {
                restoreFontFamily();
            }
        });

        // --- SEARCH DOCUMENT FUNCTIONALITY ---
        // Toolbar search (in editor)
        const findInDocBtn = document.getElementById('find-in-doc');
        let lastSearchTerm = '';
        let lastRange = null;

        // Create a floating search input for the editor
        let editorSearchBox = null;
        function showEditorSearchBox() {
            if (editorSearchBox) {
            editorSearchBox.style.display = 'flex';
            editorSearchInput.focus();
            return;
            }
            editorSearchBox = document.createElement('div');
            editorSearchBox.style.position = 'absolute';
            editorSearchBox.style.top = '16px';
            editorSearchBox.style.right = '32px';
            editorSearchBox.style.zIndex = '1001';
            editorSearchBox.style.background = '#fff';
            editorSearchBox.style.borderRadius = '24px';
            editorSearchBox.style.boxShadow = '0 2px 8px rgba(113,44,202,0.13)';
            editorSearchBox.style.display = 'flex';
            editorSearchBox.style.alignItems = 'center';
            editorSearchBox.style.padding = '6px 12px';
            editorSearchBox.style.gap = '8px';
            editorSearchBox.style.border = '1.5px solid #ece6f7';

            const icon = document.createElement('span');
            icon.className = 'material-symbols-outlined';
            icon.textContent = 'search';
            icon.style.color = '#712cca';

            const editorSearchInput = document.createElement('input');
            editorSearchInput.type = 'text';
            editorSearchInput.placeholder = 'Find in document...';
            editorSearchInput.style.border = 'none';
            editorSearchInput.style.outline = 'none';
            editorSearchInput.style.fontSize = '1em';
            editorSearchInput.style.background = 'transparent';
            editorSearchInput.style.padding = '6px 0';
            editorSearchInput.style.width = '180px';

            // Close button
            const closeBtn = document.createElement('span');
            closeBtn.className = 'material-symbols-outlined';
            closeBtn.textContent = 'close';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.color = '#a259e6';
            closeBtn.addEventListener('click', () => {
            editorSearchBox.style.display = 'none';
            clearHighlights();
            });

            editorSearchBox.appendChild(icon);
            editorSearchBox.appendChild(editorSearchInput);
            editorSearchBox.appendChild(closeBtn);

            // Insert into .editor
            document.querySelector('.editor').appendChild(editorSearchBox);

            // Listen for input
            editorSearchInput.addEventListener('input', function () {
            lastSearchTerm = this.value;
            highlightTerm(this.value);
            });

            // ESC to close
            editorSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeBtn.click();
            }
            });

            editorSearchInput.focus();
        }

        // Remove all <mark> tags in docCanvas
        function clearHighlights() {
            const marks = docCanvas.querySelectorAll('mark.__search__');
            marks.forEach(mark => {
            const parent = mark.parentNode;
            parent.replaceChild(document.createTextNode(mark.textContent), mark);
            parent.normalize();
            });
        }

        // Highlight all matches of term in docCanvas
        function highlightTerm(term) {
            clearHighlights();
            if (!term) return;
            const walk = document.createTreeWalker(docCanvas, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            while ((node = walk.nextNode())) {
            if (node.nodeValue.match(regex)) {
                const span = document.createElement('span');
                span.innerHTML = node.nodeValue.replace(regex, m => `<mark class="__search__" style="background: #ffe066; color: #333;">${m}</mark>`);
                node.parentNode.replaceChild(span, node);
            }
            }
        }

        findInDocBtn.addEventListener('click', showEditorSearchBox);

        // Home page search (searches document titles)
        const searchBar = document.querySelector('.search-bar input');
        if (searchBar) {
            searchBar.addEventListener('input', function () {
            const val = this.value.trim().toLowerCase();
            const docs = getDocs();
            let filtered = docs;
            if (val) {
                filtered = docs.filter(doc => doc.title.toLowerCase().includes(val));
            }
            // Render filtered docs
            documentsList.innerHTML = '';
            if (filtered.length === 0) {
                documentsList.innerHTML = '<span style="font-size: 48px; align-items: center; display: flex; justify-content: center;" class="material-symbols-outlined">description</span><p style="text-align: center;">No documents found.</p>';
                return;
            }
            filtered.forEach((doc, idx) => {
                const docDiv = document.createElement('div');
                docDiv.className = 'document';
                docDiv.style.cursor = 'pointer';
                docDiv.style.padding = '18px 20px';
                docDiv.style.background = '#f7f3ff';
                docDiv.style.borderRadius = '12px';
                docDiv.style.boxShadow = '0 1px 4px rgba(113,44,202,0.07)';
                docDiv.innerHTML = `
                <span class="material-symbols-outlined" style="margin-right:12px;">description</span>
                <span>${doc.title}</span>
                `;
                docDiv.addEventListener('click', () => openEditor(docs.indexOf(doc)));
                documentsList.appendChild(docDiv);
            });
            });
        }

        // Mobile search (searches document titles)
        const searchBarMobile = document.querySelector('.search-bar-mobile input');
        if (searchBarMobile) {
            searchBarMobile.addEventListener('input', function () {
            const val = this.value.trim().toLowerCase();
            const docs = getDocs();
            let filtered = docs;
            if (val) {
                filtered = docs.filter(doc => doc.title.toLowerCase().includes(val));
            }
            // Render filtered docs
            documentsList.innerHTML = '';
            if (filtered.length === 0) {
                documentsList.innerHTML = '<span style="font-size: 48px; align-items: center; display: flex; justify-content: center;" class="material-symbols-outlined">description</span><p style="text-align: center;">No documents found.</p>';
                return;
            }
            filtered.forEach((doc, idx) => {
                const docDiv = document.createElement('div');
                docDiv.className = 'document';
                docDiv.style.cursor = 'pointer';
                docDiv.style.padding = '18px 20px';
                docDiv.style.background = '#f7f3ff';
                docDiv.style.borderRadius = '12px';
                docDiv.style.boxShadow = '0 1px 4px rgba(113,44,202,0.07)';
                docDiv.innerHTML = `
                <span class="material-symbols-outlined" style="margin-right:12px;">description</span>
                <span>${doc.title}</span>
                `;
                docDiv.addEventListener('click', () => {
                openEditor(docs.indexOf(doc));
                searchOverlayMobile.style.display = 'none';
                });
                documentsList.appendChild(docDiv);
            });
            });
        }

        // --- ZOOM FUNCTIONALITY ---
        const zoomInBtns = Array.from(document.querySelectorAll('#zoom-in'));
        const zoomOutBtns = Array.from(document.querySelectorAll('#zoom-out'));
        let currentZoom = 1;
        const minZoom = 0.5;
        const maxZoom = 16; // 1600% = 16x

        // Ensure zoom applies to the canvas, not the whole editor
        function setZoom(zoom) {
            currentZoom = Math.max(minZoom, Math.min(maxZoom, zoom));
            docCanvas.style.transform = `scale(${currentZoom})`;
            docCanvas.style.transformOrigin = 'top left';
        }
        const zoomStep = 0.1;

        zoomInBtns.forEach(btn => btn.addEventListener('click', () => setZoom(currentZoom + zoomStep)));
        zoomOutBtns.forEach(btn => btn.addEventListener('click', () => setZoom(currentZoom - zoomStep)));

        // Optional: Reset zoom button in View dropdown
        const resetZoomBtn = document.querySelector('.dropdown-view .item#reset-zoom');
        if (resetZoomBtn) {
            resetZoomBtn.addEventListener('click', () => setZoom(1));
        }

        /* --- Undo/Redo Functionality --- */

        let undoStack = [];
        let redoStack = [];
        let isRestoring = false;

        // Save current state to undo stack
        function saveState() {
            if (isRestoring) return;
            const idx = getCurrentDocIndex();
            if (idx === null) return;
            undoStack.push(docCanvas.innerHTML);
            // No stack size limit
            // Clear redo stack on new input
            redoStack = [];
        }

        // Restore state from stack
        function restoreState(state) {
            isRestoring = true;
            docCanvas.innerHTML = state;
            // Save to localStorage
            const idx = getCurrentDocIndex();
            if (idx !== null) {
            const docs = getDocs();
            docs[idx].content = state;
            setDocs(docs);
            }
            isRestoring = false;
        }

        // Listen for input to save state
        docCanvas.addEventListener('input', saveState);

        // Undo button
        document.getElementById('undo-btn').addEventListener('click', function () {
            if (undoStack.length > 1) {
            redoStack.push(undoStack.pop());
            restoreState(undoStack[undoStack.length - 1]);
            }
        });

        // Redo button
        document.getElementById('redo-btn').addEventListener('click', function () {
            if (redoStack.length > 0) {
            const state = redoStack.pop();
            undoStack.push(state);
            restoreState(state);
            }
        });

        // Keyboard shortcuts: Ctrl+Z / Ctrl+Y
        docCanvas.addEventListener('keydown', function (e) {
            if (e.ctrlKey && !e.shiftKey && e.key.toLowerCase() === 'z') {
            e.preventDefault();
            document.getElementById('undo-btn').click();
            }
            if ((e.ctrlKey && e.key.toLowerCase() === 'y') || (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'z')) {
            e.preventDefault();
            document.getElementById('redo-btn').click();
            }
        });

        // Also support undo/redo from Edit dropdown menu
        document.querySelector('.dropdown-edit .item#undo').addEventListener('click', function () {
            document.getElementById('undo-btn').click();
        });
        document.querySelector('.dropdown-edit .item#redo').addEventListener('click', function () {
            document.getElementById('redo-btn').click();
        });

        // Initialize undo stack when loading a doc
        function initUndoStack() {
            undoStack = [docCanvas.innerHTML];
            redoStack = [];
        }

        // Patch showEditor to initialize undo stack
        const origShowEditorUndo = window.showEditor;
        window.showEditor = function(idx) {
            origShowEditorUndo(idx);
            setTimeout(initUndoStack, 0);
        };
        // --- IMPROVED FONT SIZE FUNCTIONALITY ---
        // Applies font size to selection or at caret for future input
        function setFontSize(size) {
            size = Math.max(1, Math.min(200, size));
            fontSizeInput.value = size;
            docCanvas.focus();
            const sel = window.getSelection();
            if (
                sel &&
                sel.rangeCount > 0 &&
                (docCanvas.contains(sel.anchorNode) || docCanvas === sel.anchorNode)
            ) {
                const range = sel.getRangeAt(0);
                if (!range.collapsed) {
                    // There is a selection: wrap it in a span with font-size
                    const span = document.createElement('span');
                    span.style.fontSize = size + 'px';
                    range.surroundContents(span);
                    // Restore selection
                    sel.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.selectNodeContents(span);
                    sel.addRange(newRange);
                } else {
                    // No selection: insert a span at caret for future typing
                    const span = document.createElement('span');
                    span.style.fontSize = size + 'px';
                    span.appendChild(document.createTextNode('\u200b')); // zero-width space
                    range.insertNode(span);
                    // Move caret inside the span
                    sel.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.setStart(span.firstChild, 1);
                    newRange.collapse(true);
                    sel.addRange(newRange);
                }
            }
        }

        fontSizeInput.addEventListener('change', function () {
            setFontSize(parseInt(this.value, 10));
        });
        addFontSizeBtn.addEventListener('click', function () {
            setFontSize(parseInt(fontSizeInput.value, 10) + 1);
        });
        removeFontSizeBtn.addEventListener('click', function () {
            setFontSize(parseInt(fontSizeInput.value, 10) - 1);
        });

        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-file, .dropdown-edit, .dropdown-view, .dropdown-insert, .dropdown-format')
            .forEach(dd => dd.style.display = 'none');
        }

        // Helper to position dropdown under its button
        function positionDropdown(btn, dropdown) {
            // Reset so we can measure
            dropdown.style.display = 'flex';
            dropdown.style.position = 'absolute';
            dropdown.style.left = '';
            dropdown.style.top = '';
            dropdown.style.right = '';
            // Get button position relative to .topbar
            const btnRect = btn.getBoundingClientRect();
            const barRect = btn.closest('.topbar').getBoundingClientRect();
            dropdown.style.left = (btnRect.left - barRect.left) + 'px';
            dropdown.style.top = (btnRect.bottom - barRect.top) + 'px';
        }

        // Toggle dropdown helper
        function toggleDropdown(btn, dropdown) {
            const isOpen = dropdown.style.display === 'flex';
            closeAllDropdowns();
            if (!isOpen) {
            positionDropdown(btn, dropdown);
            dropdown.style.display = 'flex';
            }
        }
        // File
        const fileBtn = document.getElementById('file-btn');
        const fileDropdown = fileBtn.querySelector('.dropdown-file');
        fileBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            // Toggle: if open, close; if closed, open
            if (fileDropdown.style.display === 'flex') {
                fileDropdown.style.display = 'none';
            } else {
                closeAllDropdowns();
                toggleDropdown(fileBtn, fileDropdown);
            }
            });

            // Edit
            const editBtn = document.getElementById('edit-btn');
            const editDropdown = editBtn.querySelector('.dropdown-edit');
            editBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            if (editDropdown.style.display === 'flex') {
                editDropdown.style.display = 'none';
            } else {
                closeAllDropdowns();
                toggleDropdown(editBtn, editDropdown);
            }
            });

            // View
            const viewBtn = document.getElementById('view-btn');
            const viewDropdown = viewBtn.querySelector('.dropdown-view');
            viewBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            if (viewDropdown.style.display === 'flex') {
                viewDropdown.style.display = 'none';
            } else {
                closeAllDropdowns();
                toggleDropdown(viewBtn, viewDropdown);
            }
            });

            // Insert
            const insertBtn = document.getElementById('insert-btn');
            const insertDropdown = insertBtn.querySelector('.dropdown-insert');
            insertBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            if (insertDropdown.style.display === 'flex') {
                insertDropdown.style.display = 'none';
            } else {
                closeAllDropdowns();
                toggleDropdown(insertBtn, insertDropdown);
            }
            });

            // Format
            const formatBtn = document.getElementById('format-btn');
            const formatDropdown = formatBtn.querySelector('.dropdown-format');
            formatBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            if (formatDropdown.style.display === 'flex') {
                formatDropdown.style.display = 'none';
            } else {
                closeAllDropdowns();
                toggleDropdown(formatBtn, formatDropdown);
            }
            });

            // Prevent closing dropdowns when clicking outside for file/edit/view/insert/format
            // Do NOT close the create-wrapper when clicking outside
            function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-file, .dropdown-edit, .dropdown-view, .dropdown-insert, .dropdown-format')
                .forEach(dd => dd.style.display = 'none');
            // Do NOT close .create-wrapper here
            }

        // (Removed global click handler to prevent dropdowns from closing when clicking outside)

        // Optional: Hide dropdowns on ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeAllDropdowns();
        });
          // Set the input value to the current doc name when editor is shown
                    function setEditorDocNameInput(idx) {
                        const docs = JSON.parse(localStorage.getItem('docs') || '[]');
                        const docsNameInput = document.getElementById('docsName');
                        if (idx !== null && idx >= 0 && idx < docs.length) {
                            docsNameInput.value = docs[idx].title || 'Untitled Document';
                        } else {
                            docsNameInput.value = 'Untitled Document';
                        }
                    }
                    // Patch showEditor to update input value
                    const origShowEditor = window.showEditor;
                    window.showEditor = function(idx) {
                        origShowEditor(idx);
                        setEditorDocNameInput(idx);
                    };
                    // Also update on page load if editor is visible
                    document.addEventListener('DOMContentLoaded', function() {
                        if (!document.querySelector('.editor').hidden) {
                            setEditorDocNameInput(getCurrentDocIndex());
                        }
                    });
        // Update document name in localStorage and on home when edited in editor
                    const docsNameInput = document.getElementById('docsName');
                    docsNameInput.addEventListener('change', function () {
                        const idx = getCurrentDocIndex();
                        if (idx !== null && idx >= 0) {
                            const docs = getDocs();
                            docs[idx].title = docsNameInput.value.trim() || 'Untitled Document';
                            setDocs(docs);
                            renderDocs(currentView);
                        }
                    });

                    // Also update input value when switching docs
                    function updateEditorTitle(idx) {
                        const docs = getDocs();
                        if (idx !== null && idx >= 0 && idx < docs.length) {
                            docsNameInput.value = docs[idx].title || 'Untitled Document';
                        } else {
                            docsNameInput.value = 'Untitled Document';
                        }
                    }
        // Modals functionality
        const createDocModal = document.getElementById('createDocModal');
        const closeCreateDocModal = document.getElementById('closeCreateDocModal');
        const createDocBtn = document.getElementById('create-doc-btn');
        const saveDocBtn = document.getElementById('saveDocBtn');
        const newDocTitle = document.getElementById('newDocTitle');
        const documentsList = document.getElementById('documentsList');
        const createWrapper = document.querySelector('.create-wrapper');
        const homePage = document.querySelector('.home-page');
        const editor = document.querySelector('.editor');
        const gridViewBtn = document.getElementById('grid-view');
        const listViewBtn = document.getElementById('list-view');

        // Helper: Get/set docs from localStorage
        function getDocs() {
            return JSON.parse(localStorage.getItem('docs') || '[]');
        }
        function setDocs(docs) {
            localStorage.setItem('docs', JSON.stringify(docs));
        }

        // Render documents
        function renderDocs(view = 'grid') {
            const docs = getDocs();
            if (docs.length === 0) {
            documentsList.innerHTML = '<span style="font-size: 48px; align-items: center; display: flex; justify-content: center;" class="material-symbols-outlined">description</span><p style="text-align: center;">No documents found.</p>';
            documentsList.className = 'documents ' + (view === 'list' ? 'list-view' : 'grid-view');
            return;
            }
            documentsList.innerHTML = '';
            documentsList.className = 'documents ' + (view === 'list' ? 'list-view' : 'grid-view');

            // Add grid/list CSS if not present
            if (!document.getElementById('docs-view-style')) {
            const style = document.createElement('style');
            style.id = 'docs-view-style';
            style.innerHTML = `
            .documents.grid-view {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 18px;
            }
            .documents.list-view {
                display: flex;
                flex-direction: column;
                gap: 0;
            }
            .documents .document {
                transition: box-shadow 0.2s, transform 0.2s;
            }
            .documents.grid-view .document:hover {
                box-shadow: 0 4px 16px rgba(113,44,202,0.13);
                transform: translateY(-2px) scale(1.03);
            }
            .documents.list-view .document {
                display: flex !important;
                align-items: center;
            }
            `;
            document.head.appendChild(style);
            }

            docs.forEach((doc, idx) => {
            const docDiv = document.createElement('div');
            docDiv.className = 'document';
            docDiv.style.cursor = 'pointer';
            docDiv.style.padding = '18px 20px';
            docDiv.style.margin = view === 'list' ? '10px 0' : '0';
            docDiv.style.background = '#f7f3ff';
            docDiv.style.borderRadius = '12px';
            docDiv.style.boxShadow = '0 1px 4px rgba(113,44,202,0.07)';
            docDiv.style.display = view === 'list' ? 'flex' : 'block';
            docDiv.style.alignItems = 'center';
            docDiv.innerHTML = `
                <span class="material-symbols-outlined" style="margin-right:12px;">description</span>
                <span>${doc.title}</span>
            `;
            docDiv.addEventListener('click', () => openEditor(idx));
            documentsList.appendChild(docDiv);
            });
        }

        // Open editor for a document
        function openEditor(idx) {
            const docs = getDocs();
            if (idx < 0 || idx >= docs.length) return;
            editor.hidden = false;
            homePage.hidden = true;

        }

        // Modal open/close
        createDocBtn.addEventListener('click', () => {
            createDocModal.style.display = 'flex';
        });
        closeCreateDocModal.addEventListener('click', () => {
            createDocModal.style.display = 'none';
        });

        // Save new doc
        saveDocBtn.addEventListener('click', () => {
            const docTitle = newDocTitle.value.trim();
            if (!docTitle) {
            showToast('Please enter a document title.');
            return;
            }
            const docs = getDocs();
            docs.push({ title: docTitle, content: '' });
            setDocs(docs);
            newDocTitle.value = '';
            createDocModal.style.display = 'none';
            renderDocs(currentView);
        });
        // editor doc title
        const docsName = document.getElementById('docsName');

        function updateEditorTitle(idx) {
            const docs = getDocs();
            if (idx !== null && idx >= 0 && idx < docs.length) {
            docsName.textContent = docs[idx].title || 'Untitled Document';
            } else {
            docsName.textContent = 'Untitled Document';
            }
        }

        // Update showEditor to set the doc name
        function showEditor(idx) {
            editor.hidden = false;
            homePage.hidden = true;
            setCurrentDocIndex(idx);
            updateEditorTitle(idx);
            // You can add code here to load the document content into the editor
        }

        // Grid/List view logic
        let currentView = 'grid';
        gridViewBtn.addEventListener('click', () => {
            currentView = 'grid';
            renderDocs('grid');
        });
        listViewBtn.addEventListener('click', () => {
            currentView = 'list';
            renderDocs('list');
        });

        // Initial render
        renderDocs(currentView);

        const importBtn = document.getElementById('import-btn');
        const importModal = document.getElementById('importModal');
        const closeImportModal = document.getElementById('closeImportModal');
        const importFileInput = document.getElementById('importFileInput');
        const importFilesBtn = document.getElementById('importFilesBtn');

        // Show import modal
        importBtn.addEventListener('click', () => {
            importModal.style.display = 'flex';
        });

        // Close import modal
        closeImportModal.addEventListener('click', () => {
            importModal.style.display = 'none';
            importFileInput.value = '';
        });

        // Import files handler
        importFilesBtn.addEventListener('click', () => {
            const files = importFileInput.files;
            if (!files || files.length === 0) {
                showToast('Please select files to import.');
                return;
            }
            const docs = getDocs();
            let importedCount = 0;
            let processed = 0;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    let content = e.target.result;
                    // Try to parse as JSON (for .json files)
                    let title = file.name.replace(/\.[^/.]+$/, "");
                    if (file.type === "application/json" || file.name.endsWith('.json')) {
                        try {
                            const json = JSON.parse(content);
                            if (Array.isArray(json)) {
                                // Import array of docs
                                json.forEach(doc => {
                                    if (doc.title && typeof doc.content === 'string') {
                                        docs.push({ title: doc.title, content: doc.content, fontFamily: doc.fontFamily || "Segoe UI" });
                                        importedCount++;
                                    }
                                });
                                processed++;
                                if (processed === files.length) finishImport();
                                return;
                            } else if (json.title && typeof json.content === 'string') {
                                docs.push({ title: json.title, content: json.content, fontFamily: json.fontFamily || "Segoe UI" });
                                importedCount++;
                                processed++;
                                if (processed === files.length) finishImport();
                                return;
                            }
                        } catch (err) {
                            // Not valid JSON, treat as plain text
                        }
                    }
                    // Otherwise, treat as plain text
                    docs.push({ title, content, fontFamily: "Segoe UI" });
                    importedCount++;
                    processed++;
                    if (processed === files.length) finishImport();
                };
                reader.readAsText(file);
            }
            function finishImport() {
                setDocs(docs);
                renderDocs(currentView);
                importModal.style.display = 'none';
                importFileInput.value = '';
                showToast(importedCount > 0 ? `Imported ${importedCount} document${importedCount > 1 ? 's' : ''}.` : 'No valid documents imported.');
            }
        });


        // Track which document is open and persist it
        function setCurrentDocIndex(idx) {
            sessionStorage.setItem('currentDocIndex', idx);
        }
        function getCurrentDocIndex() {
            const idx = sessionStorage.getItem('currentDocIndex');
            return idx !== null ? parseInt(idx, 10) : null;
        }
        function clearCurrentDocIndex() {
            sessionStorage.removeItem('currentDocIndex');
        }

        // Show editor for a document index
        // (Removed duplicate definition to ensure updateEditorTitle is called)

        // Hide editor and go back to home
        function hideEditor() {
            editor.hidden = true;
            homePage.hidden = false;
            clearCurrentDocIndex();
        }

        // Replace openEditor to use showEditor
        function openEditor(idx) {
            const docs = getDocs();
            if (idx < 0 || idx >= docs.length) return;
            showEditor(idx);
        }

        // Add a way to go back from editor to home (example: clicking #goHome)
        document.getElementById('goHome').addEventListener('click', hideEditor);

        // On page load, check if a document was open
        window.addEventListener('DOMContentLoaded', () => {
            const idx = getCurrentDocIndex();
            const docs = getDocs();
            if (idx !== null && idx >= 0 && idx < docs.length) {
            showEditor(idx);
            } else {
            hideEditor();
            }
        });


        const searchIconMobile = document.getElementById('searchIconMobile');
        const searchOverlayMobile = document.querySelector('.search-overlay-mobile');
        const backBtn = document.getElementById('back');

        searchIconMobile.addEventListener('click', () => {
            searchOverlayMobile.style.display = 'flex';
        });

        backBtn.addEventListener('click', () => {
            searchOverlayMobile.style.display = 'none';
        });

        //documents
        // (Removed duplicate declarations and unnecessary code)
        const createBtn = document.querySelector('#create-btn > button');
        // createWrapper is already declared above
        createBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            createWrapper.style.display = createWrapper.style.display === 'flex' ? 'none' : 'flex';
        });
        createWrapper.addEventListener('click', (event) => {
            event.stopPropagation();
        });
        document.addEventListener('click', (event) => {
            if (!createBtn.contains(event.target) && !createWrapper.contains(event.target)) {
                createWrapper.style.display = 'none';
            }
        });

        //toast 
        function showToast(message, duration = 2500) {
            // Remove existing toast if present
            const oldToast = document.getElementById('custom-toast');
            if (oldToast) oldToast.remove();

            const toast = document.createElement('div');
            toast.id = 'custom-toast';
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '40px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = 'linear-gradient(90deg, #712cca 0%, #a259e6 100%)';
            toast.style.color = '#fff';
            toast.style.padding = '14px 32px';
            toast.style.borderRadius = '32px';
            toast.style.boxShadow = '0 4px 16px rgba(113,44,202,0.18)';
            toast.style.fontSize = '1.1em';
            toast.style.fontWeight = '600';
            toast.style.zIndex = '9999';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s cubic-bezier(.4,0,.2,1)';
            document.body.appendChild(toast);

            // Fade in
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);

            // Fade out and remove
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 350);
            }, duration);
        }
        //render the documents on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderDocs(currentView);
            restoreFontFamily();
            initUndoStack();
        });

    </script>
</body>
</html>
